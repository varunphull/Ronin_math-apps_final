<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ronin's Maths Interactive Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#080d1a;--card:rgba(15,23,42,0.85);--border:rgba(99,102,241,0.18);--text:#e2e8f0;--muted:#64748b}
    body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);
      background-image:linear-gradient(rgba(99,102,241,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(99,102,241,.04) 1px,transparent 1px);
      background-size:32px 32px;min-height:100vh}
    .mono{font-family:'JetBrains Mono',monospace}
    input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:5px;border-radius:4px;background:#1e293b;outline:none;cursor:pointer}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#6366f1;border:2px solid #fff;cursor:pointer}
    input[type=number]{background:#0f172a;border:1px solid rgba(99,102,241,.25);border-radius:8px;color:#f1f5f9;padding:6px 10px;width:70px;font-size:13px;font-family:'JetBrains Mono',monospace;text-align:center;outline:none}
    input[type=number]:focus{border-color:#6366f1}
    input[type=number]::-webkit-inner-spin-button{opacity:1}
    .btn{padding:6px 14px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:'Space Grotesk',sans-serif}
    .btn-tab{background:transparent;color:#64748b}
    .btn-tab:hover{color:#94a3b8}
    .btn-tab.active{background:rgba(99,102,241,.25);color:#a5b4fc}
    .btn-back{display:inline-flex;align-items:center;gap:6px;color:#64748b;font-size:14px;cursor:pointer;background:none;border:none;padding:0;margin-bottom:24px;font-family:'Space Grotesk',sans-serif;transition:color .15s}
    .btn-back:hover{color:#e2e8f0}
    .btn-action{background:rgba(99,102,241,.2);border:1px solid rgba(99,102,241,.4);color:#a5b4fc;padding:8px 18px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:all .2s}
    .btn-action:hover{background:rgba(99,102,241,.35)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
    .topic-card{background:rgba(15,23,42,.7);border:1px solid rgba(99,102,241,.12);border-radius:16px;padding:20px;cursor:pointer;transition:all .2s}
    .topic-card:hover{border-color:rgba(99,102,241,.4);background:rgba(30,41,59,.8);transform:translateY(-2px)}
    .step{background:rgba(15,23,42,.6);border:1px solid rgba(99,102,241,.1);border-radius:10px;padding:12px 16px;margin-bottom:8px;cursor:pointer}
    .step:hover{border-color:rgba(99,102,241,.3)}
    .step-body{font-size:12px;color:#94a3b8;margin-top:8px;display:none}
    .step.open .step-body{display:block}
    .tab-bar{display:flex;gap:6px;background:rgba(15,23,42,.6);padding:6px;border-radius:10px;border:1px solid rgba(99,102,241,.15);flex-wrap:wrap;width:fit-content;margin-bottom:20px}
    .page-wrap{min-height:100vh;padding:24px 16px;max-width:1000px;margin:0 auto}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start}
    @media(max-width:700px){.two-col{grid-template-columns:1fr}}
    .ctrl-col{display:flex;flex-direction:column;gap:14px}
    svg{display:block;max-width:100%;border-radius:12px}
    svg text{user-select:none}
    .si-row{margin-bottom:18px}
    .si-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .si-label span:first-child{font-size:13px;font-weight:600}
    .si-controls{display:flex;align-items:center;gap:10px}
    .si-controls input[type=range]{flex:1}
    .info-box{background:rgba(15,23,42,.6);border:1px solid rgba(99,102,241,.1);border-radius:12px;padding:16px}
    .info-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#475569;margin-bottom:8px}
    .dash-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
    .prob-ball{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;cursor:pointer;border:2px solid transparent;transition:all .15s}
    .steps-wrap{max-height:300px;overflow-y:auto;padding-right:4px}
    .steps-wrap::-webkit-scrollbar{width:4px}
    .steps-wrap::-webkit-scrollbar-thumb{background:#1e293b;border-radius:4px}
    /* Net face cards */
    .face-card{border-radius:10px;padding:12px;margin-bottom:8px;border:1px solid}
    /* Vector notation */
    .col-vec{display:inline-flex;flex-direction:column;align-items:center;background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.3);border-radius:6px;padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:#a5b4fc;line-height:1.4}
  </style>
</head>
<body>
<div id="app"></div>
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let PAGE='dashboard';
const S={
  grad:{A:{x:-4,y:-3},B:{x:4,y:4}},
  mid:{A:{x:-5,y:-3},B:{x:5,y:4}},
  bear:{A:{x:0,y:0},B:{x:4,y:6},mode:'forward'},
  area:{shape:'triangle',triA:{x:-5,y:-4},triB:{x:5,y:-4},triC:{x:0,y:5},rectA:{x:-4,y:-3},rectB:{x:4,y:4}},
  prism:{base:6,height:4,depth:8,shape:'triangular',showNet:false},
  linear:{m:1,c:0},
  unit:{value:10,dir:'mi2km'},
  trans:{type:'translate',shape:[{x:-3,y:-2},{x:1,y:-2},{x:1,y:2},{x:-1,y:3}],tx:3,ty:2,angle:90,cw:true,cx:0,cy:0,sf:2,mirrorLine:'x-axis'},
  para:{type:'parallelogram',b:6,h:4,a:3},
  pct:{original:80,pctChange:25,dir:'increase',findType:'new'},
  ratio:{mode:'share',a:3,b:5,total:160,simplA:12,simplB:18},
  prob:{mode:'single',balls:['red','red','red','blue','blue','green']},
  circle:{r:5,mode:'full',sector:90},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COORD HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W=400,H=400,RANGE=10;
function toSVG(x,y,w=W,h=H,r=RANGE){const c=w/(r*2);return{sx:w/2+x*c,sy:h/2-y*c};}
function toMath(sx,sy,w=W,h=H,r=RANGE){const c=w/(r*2);return{x:(sx-w/2)/c,y:(h/2-sy)/c};}
function snap(v){return Math.round(Math.max(-RANGE+1,Math.min(RANGE-1,v)));}
function r1(v){return Math.round(v*10)/10;}
function r2(v){return Math.round(v*100)/100;}
function gcd(a,b){a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b];}return a;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawGrid(w=W,h=H,range=RANGE){
  const cell=w/(range*2),cx=w/2,cy=h/2;let s='';
  for(let i=-range;i<=range;i++){
    const x=cx+i*cell,y=cy+i*cell,axis=i===0;
    s+=`<line x1="${x}" y1="0" x2="${x}" y2="${h}" stroke="${axis?'#334155':'#1a2535'}" stroke-width="${axis?1.5:.5}"/>`;
    s+=`<line x1="0" y1="${y}" x2="${w}" y2="${y}" stroke="${axis?'#334155':'#1a2535'}" stroke-width="${axis?1.5:.5}"/>`;
    if(i!==0&&i%2===0){
      s+=`<text x="${x}" y="${cy+15}" text-anchor="middle" fill="#334155" font-size="9" font-family="Space Grotesk">${i}</text>`;
      s+=`<text x="${cx-10}" y="${y+3}" text-anchor="end" fill="#334155" font-size="9" font-family="Space Grotesk">${-i}</text>`;
    }
  }
  s+=`<polygon points="${w-6},${cy-3} ${w},${cy} ${w-6},${cy+3}" fill="#475569"/>`;
  s+=`<polygon points="${cx-3},6 ${cx},0 ${cx+3},6" fill="#475569"/>`;
  s+=`<text x="${w-4}" y="${cy-8}" fill="#475569" font-size="11" font-weight="600" text-anchor="end">x</text>`;
  s+=`<text x="${cx+10}" y="12" fill="#475569" font-size="11" font-weight="600">y</text>`;
  return s;
}
function makeSVG(inner,id,w=W,h=H){
  return `<svg id="${id}" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="background:#060b14;border-radius:12px;touch-action:none">${drawGrid(w,h)}${inner}</svg>`;
}
function dragDot(sx,sy,color,label,id,lx,ly){
  const tx=lx!==undefined?lx:sx+12,ty=ly!==undefined?ly:sy-14;
  return `<g class="dp" data-id="${id}" style="cursor:grab">
    <circle cx="${sx}" cy="${sy}" r="16" fill="${color}" opacity=".1"/>
    <circle cx="${sx}" cy="${sy}" r="7" fill="${color}" stroke="#fff" stroke-width="2"/>
    ${label?`<text x="${tx}" y="${ty}" fill="${color}" font-size="11" font-weight="700" font-family="Space Grotesk">${label}</text>`:''}
  </g>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG ENGINE â€” uses actual SVG viewBox, works at any display size
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dragCleanup=null;
function attachDrag(svgId,onMove){
  if(_dragCleanup){_dragCleanup();_dragCleanup=null;}
  const svg=document.getElementById(svgId);if(!svg)return;
  let active=null;
  // Read viewBox to get logical dimensions â€” works regardless of CSS scaling
  function getVB(){const vb=svg.viewBox.baseVal;return{vw:vb.width||W,vh:vb.height||H};}
  function getPos(e){
    const rect=svg.getBoundingClientRect();
    const t=e.touches?e.touches[0]:e;
    const{vw,vh}=getVB();
    return{sx:(t.clientX-rect.left)*(vw/rect.width),sy:(t.clientY-rect.top)*(vh/rect.height)};
  }
  function onDown(e){const g=e.target.closest('.dp');if(!g)return;e.preventDefault();active=g.dataset.id;}
  function onMv(e){
    if(!active)return;e.preventDefault();
    const pos=getPos(e);
    const{vw,vh}=getVB();
    const m=toMath(pos.sx,pos.sy,vw,vh);
    onMove(active,snap(m.x),snap(m.y));
  }
  function onUp(){active=null;}
  svg.addEventListener('mousedown',onDown);svg.addEventListener('touchstart',onDown,{passive:false});
  window.addEventListener('mousemove',onMv);window.addEventListener('mouseup',onUp);
  window.addEventListener('touchmove',onMv,{passive:false});window.addEventListener('touchend',onUp);
  _dragCleanup=()=>{
    svg.removeEventListener('mousedown',onDown);svg.removeEventListener('touchstart',onDown);
    window.removeEventListener('mousemove',onMv);window.removeEventListener('mouseup',onUp);
    window.removeEventListener('touchmove',onMv);window.removeEventListener('touchend',onUp);
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLORS={
  indigo:['rgba(99,102,241,.12)','rgba(99,102,241,.35)','#a5b4fc','#818cf8'],
  emerald:['rgba(16,185,129,.12)','rgba(16,185,129,.35)','#6ee7b7','#34d399'],
  amber:['rgba(245,158,11,.12)','rgba(245,158,11,.35)','#fcd34d','#f59e0b'],
  rose:['rgba(244,63,94,.12)','rgba(244,63,94,.35)','#fda4af','#f43f5e'],
  violet:['rgba(139,92,246,.12)','rgba(139,92,246,.35)','#c4b5fd','#a78bfa'],
  cyan:['rgba(6,182,212,.12)','rgba(6,182,212,.35)','#67e8f9','#22d3ee'],
};
function fbox(title,formula,result,color='indigo'){
  const[bg,border,text,accent]=COLORS[color]||COLORS.indigo;
  return `<div style="background:${bg};border:1px solid ${border};border-radius:12px;padding:14px;margin-bottom:0">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:${accent};margin-bottom:4px">${title}</div>
    <div class="mono" style="font-size:11px;color:#94a3b8;margin-bottom:5px">${formula}</div>
    ${result!==undefined?`<div style="font-size:18px;font-weight:700;color:${text}">${result}</div>`:''}
  </div>`;
}
function steps(arr){
  return `<div class="steps-wrap">`+arr.map((s,i)=>`
    <div class="step" onclick="this.classList.toggle('open')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:13px;font-weight:600;color:#e2e8f0">Step ${i+1}: ${s.t}</div>
        <span style="color:#64748b;font-size:10px">â–¼</span>
      </div>
      <div class="step-body mono">${s.c}</div>
    </div>`).join('')+`</div>`;
}
function SI(label,color,val,min,max,step,key,subkey){
  const id=`si_${key}_${subkey||'v'}`;
  const path=subkey?`${key}.${subkey}`:key;
  return `<div class="si-row">
    <div class="si-label">
      <span style="color:${color}">${label}</span>
      <input type="number" min="${min}" max="${max}" step="${step}" value="${val}"
        oninput="S.${path}=parseFloat(this.value)||0;document.getElementById('${id}').value=this.value;rerender()">
    </div>
    <div class="si-controls">
      <input type="range" id="${id}" min="${min}" max="${max}" step="${step}" value="${val}"
        oninput="S.${path}=parseFloat(this.value);this.parentElement.previousElementSibling.querySelector('input[type=number]').value=this.value;rerender()">
    </div>
  </div>`;
}
function tabs(items,activeVal,setExpr){
  return `<div class="tab-bar">`+items.map(([v,l])=>
    `<button class="btn btn-tab${activeVal===v?' active':''}" onclick="${setExpr.replace('__V__',`'${v}'`)}">${l}</button>`
  ).join('')+`</div>`;
}
function pageWrap(title,icon,sub,content){
  return `<div class="page-wrap">
    <button class="btn-back" onclick="navigate('dashboard')">â† Back to Topics</button>
    <div style="margin-bottom:24px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
        <div style="width:40px;height:40px;border-radius:12px;background:rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;font-size:20px">${icon}</div>
        <h1 style="font-size:clamp(18px,3vw,26px);font-weight:700;color:#f1f5f9">${title}</h1>
      </div>
      <p style="color:#64748b;font-size:14px;margin-left:52px">${sub}</p>
    </div>${content}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const topics=[
    {icon:'ğŸ“ˆ',title:'Finding Gradient',desc:'Drag two points, watch gradient update live.',page:'gradient',tag:'Ch14'},
    {icon:'ğŸ¯',title:'Midpoint of a Line',desc:'Find the exact middle between two coordinates.',page:'midpoint',tag:'Ch14'},
    {icon:'ğŸ§­',title:'Bearings',desc:'Forward & back bearings, clockwise from North.',page:'bearings',tag:'Ch14'},
    {icon:'ğŸ”„',title:'2D Transformations',desc:'Translate (column vectors), reflect any mirror line, rotate CW/ACW, enlarge.',page:'transformations',tag:'Ch14'},
    {icon:'â¬¡',title:'Parallelogram & Trapezium',desc:'Compute areas with adjustable sliders.',page:'parallelogram',tag:'Ch15'},
    {icon:'ğŸ“',title:'Area of Shapes',desc:'Drag vertices to compute triangle and rectangle areas.',page:'area',tag:'Ch15'},
    {icon:'ğŸ“¦',title:'3D Surface Area Explorer',desc:'3D shape â†’ unfold net â†’ see each face â†’ total surface area.',page:'prisms',tag:'Ch15'},
    {icon:'â†”ï¸',title:'Miles â†” Kilometres',desc:'Convert between imperial and metric distances.',page:'units',tag:'Ch15'},
    {icon:'ğŸ“‰',title:'Linear Equations',desc:'Adjust m and c in y = mx + c and watch the line move.',page:'linear',tag:'Ch9'},
    {icon:'%',title:'Percentages',desc:'Percentage increase, decrease and reverse percentage.',page:'percentages',tag:'Ch10'},
    {icon:'âš–ï¸',title:'Ratio & Proportion',desc:'Share amounts in a ratio and simplify ratios.',page:'ratio',tag:'Ch12'},
    {icon:'ğŸ²',title:'Probability',desc:'Single events, complementary, combined two-dice.',page:'probability',tag:'Ch13'},
    {icon:'â­•',title:'Circles',desc:'Area, circumference, arc length and sector area.',page:'circles',tag:'Ch15'},
  ];
  return `<div class="page-wrap" style="max-width:1000px">
    <div style="margin-bottom:36px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div style="width:44px;height:44px;border-radius:14px;background:rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;font-size:22px">ğŸ§®</div>
        <h1 style="font-size:clamp(20px,4vw,30px);font-weight:700;color:#f1f5f9">Ronin's Maths Interactive Tool</h1>
      </div>
      <p style="color:#64748b;font-size:14px;margin-left:56px">Cambridge IGCSE Year 8 â€” drag, explore, and learn interactively.</p>
    </div>
    <div class="dash-grid">${topics.map(t=>`
      <div class="topic-card" onclick="navigate('${t.page}')">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
          <span style="font-size:26px">${t.icon}</span>
          <span style="font-size:10px;font-weight:700;color:#475569;background:#1e293b;padding:2px 8px;border-radius:20px">${t.tag}</span>
        </div>
        <div style="font-weight:700;color:#f1f5f9;font-size:15px;margin-bottom:5px">${t.title}</div>
        <div style="font-size:13px;color:#64748b;line-height:1.5">${t.desc}</div>
      </div>`).join('')}
    </div>
    <p style="text-align:center;color:#1e293b;font-size:12px;margin-top:28px">Drag points â€¢ Adjust sliders â€¢ Enter values manually</p>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRADIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGradient(){
  const{A,B}=S.grad;
  const svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y);
  const dx=B.x-A.x,dy=B.y-A.y;
  const m=dx===0?'âˆ':r2(dy/dx);
  let lx1=0,ly1,lx2=W,ly2;
  if(dx===0){lx1=lx2=svA.sx;ly1=0;ly2=H;}
  else{const sl=-dy/dx;ly1=svA.sy+sl*(svA.sx-lx1);ly2=svA.sy+sl*(svA.sx-lx2);}
  const inner=`
    <line x1="${lx1}" y1="${ly1}" x2="${lx2}" y2="${ly2}" stroke="#6366f1" stroke-width="1.5" opacity=".4" stroke-dasharray="6,4"/>
    <line x1="${svA.sx}" y1="${svA.sy}" x2="${svB.sx}" y2="${svB.sy}" stroke="#818cf8" stroke-width="2.5"/>
    <line x1="${svA.sx}" y1="${svA.sy}" x2="${svB.sx}" y2="${svA.sy}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,3"/>
    <line x1="${svB.sx}" y1="${svA.sy}" x2="${svB.sx}" y2="${svB.sy}" stroke="#34d399" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="${(svA.sx+svB.sx)/2}" y="${svA.sy+(svA.sy>svB.sy?-8:18)}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="600" font-family="Space Grotesk">Î”x=${dx}</text>
    <text x="${svB.sx+14}" y="${(svA.sy+svB.sy)/2+4}" fill="#34d399" font-size="11" font-weight="600" font-family="Space Grotesk">Î”y=${dy}</text>
    ${dragDot(svA.sx,svA.sy,'#818cf8',`A(${A.x},${A.y})`,'grad-A')}
    ${dragDot(svB.sx,svB.sy,'#34d399',`B(${B.x},${B.y})`,'grad-B')}`;
  return pageWrap('Finding Gradient','ğŸ“ˆ','Drag A and B to see the gradient update in real-time.',`
    <div class="two-col">${makeSVG(inner,'svg-grad')}
      <div class="ctrl-col">
        ${fbox('Gradient','m = (yâ‚‚âˆ’yâ‚) / (xâ‚‚âˆ’xâ‚)',m==='âˆ'?'Undefined':m,'indigo')}
        ${fbox('Rise Î”y','yâ‚‚ âˆ’ yâ‚',dy,'emerald')}
        ${fbox('Run Î”x','xâ‚‚ âˆ’ xâ‚',dx,'amber')}
        ${steps([{t:'Label points',c:`A=(${A.x},${A.y}), B=(${B.x},${B.y})`},{t:'Rise Î”y',c:`${B.y}âˆ’${A.y}=${dy}`},{t:'Run Î”x',c:`${B.x}âˆ’${A.x}=${dx}`},{t:'Gradient m',c:`${dy}/${dx} = ${m}`}])}
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIDPOINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMidpoint(){
  const{A,B}=S.mid;
  const svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y);
  const mx=r1((A.x+B.x)/2),my=r1((A.y+B.y)/2);
  const svM=toSVG(mx,my);
  const inner=`
    <line x1="${svA.sx}" y1="${svA.sy}" x2="${svB.sx}" y2="${svB.sy}" stroke="#818cf8" stroke-width="2.5"/>
    <circle cx="${svM.sx}" cy="${svM.sy}" r="9" fill="#fbbf24" stroke="#fff" stroke-width="2"/>
    <text x="${svM.sx+14}" y="${svM.sy-10}" fill="#fbbf24" font-size="12" font-weight="700" font-family="Space Grotesk">M(${mx},${my})</text>
    ${dragDot(svA.sx,svA.sy,'#818cf8',`A(${A.x},${A.y})`,'mid-A')}
    ${dragDot(svB.sx,svB.sy,'#34d399',`B(${B.x},${B.y})`,'mid-B')}`;
  return pageWrap('Midpoint of a Line','ğŸ¯','Drag A and B to find their midpoint M.',`
    <div class="two-col">${makeSVG(inner,'svg-mid')}
      <div class="ctrl-col">
        ${fbox('Midpoint','M = ((xâ‚+xâ‚‚)/2, (yâ‚+yâ‚‚)/2)',`(${mx}, ${my})`,'amber')}
        ${fbox('Midpoint x','('+A.x+'+'+B.x+')/2',mx,'indigo')}
        ${fbox('Midpoint y','('+A.y+'+'+B.y+')/2',my,'emerald')}
        ${steps([{t:'Label points',c:`A=(${A.x},${A.y}), B=(${B.x},${B.y})`},{t:'Average x',c:`(${A.x}+${B.x})/2=${mx}`},{t:'Average y',c:`(${A.y}+${B.y})/2=${my}`},{t:'Midpoint',c:`M=(${mx},${my})`}])}
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEARINGS â€” upgraded with back bearing & mode
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBearings(){
  const{A,B,mode}=S.bear;
  // Forward: bearing of B from A. Back: bearing of A from B
  const from=mode==='forward'?A:B, to=mode==='forward'?B:A;
  const fromLabel=mode==='forward'?'A':'B', toLabel=mode==='forward'?'B':'A';
  const svFrom=toSVG(from.x,from.y),svTo=toSVG(to.x,to.y);
  const svN=toSVG(from.x,from.y+3.5);
  const dx=to.x-from.x,dy=to.y-from.y;
  const dist=r2(Math.sqrt(dx*dx+dy*dy));
  let ang=Math.atan2(dx,dy)*180/Math.PI;if(ang<0)ang+=360;
  const bearing=Math.round(ang),bs=bearing.toString().padStart(3,'0');
  // Back bearing
  const backBearing=(bearing+180)%360, backBs=backBearing.toString().padStart(3,'0');
  const arcR=52,s0=(-90)*Math.PI/180,s1=(-90+bearing)*Math.PI/180;
  const ax1=svFrom.sx+arcR*Math.cos(s0),ay1=svFrom.sy+arcR*Math.sin(s0);
  const ax2=svFrom.sx+arcR*Math.cos(s1),ay2=svFrom.sy+arcR*Math.sin(s1);
  // North lines at both points
  const svN2=toSVG(to.x,to.y+3);
  const inner=`
    <line x1="${svFrom.sx}" y1="${svFrom.sy}" x2="${svN.sx}" y2="${svN.sy}" stroke="#475569" stroke-width="2" stroke-dasharray="5,4"/>
    <text x="${svN.sx}" y="${svN.sy-8}" text-anchor="middle" fill="#64748b" font-size="13" font-weight="700" font-family="Space Grotesk">N</text>
    <line x1="${svTo.sx}" y1="${svTo.sy}" x2="${svN2.sx}" y2="${svN2.sy}" stroke="#334155" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="${svN2.sx}" y="${svN2.sy-6}" text-anchor="middle" fill="#475569" font-size="11" font-weight="700" font-family="Space Grotesk">N</text>
    <line x1="${svFrom.sx}" y1="${svFrom.sy}" x2="${svTo.sx}" y2="${svTo.sy}" stroke="#818cf8" stroke-width="2.5"/>
    <path d="M ${ax1} ${ay1} A ${arcR} ${arcR} 0 ${bearing>180?1:0} 1 ${ax2} ${ay2}" fill="none" stroke="#fbbf24" stroke-width="2.5"/>
    <text x="${svFrom.sx+62}" y="${svFrom.sy-14}" fill="#fbbf24" font-size="14" font-weight="700" font-family="Space Grotesk">${bs}Â°</text>
    ${dragDot(svFrom.sx,svFrom.sy,'#f43f5e',`${fromLabel}(${from.x},${from.y})`,'bear-from')}
    ${dragDot(svTo.sx,svTo.sy,'#818cf8',`${toLabel}(${to.x},${to.y})`,'bear-to')}`;
  return pageWrap('Bearings','ğŸ§­','Drag points to see bearings update. Switch between forward and back bearing.',`
    ${tabs([['forward','Bearing of B from A'],['back','Bearing of A from B']],mode,"S.bear.mode=__V__;rerender()")}
    <div class="two-col">${makeSVG(inner,'svg-bear')}
      <div class="ctrl-col">
        ${fbox(`Bearing of ${toLabel} from ${fromLabel}`,'Clockwise from North',bs+'Â°','indigo')}
        ${fbox('Back Bearing','Forward bearing Â± 180Â°',backBs+'Â°','amber')}
        ${fbox('Distance','d = âˆš(Î”xÂ²+Î”yÂ²)',dist+' units','emerald')}
        <div class="info-box">
          <div class="info-label">Key Rule</div>
          <div style="font-size:13px;color:#94a3b8;line-height:1.8">
            Back bearing = forward Â± 180Â°<br>
            If forward &lt; 180Â°: add 180Â°<br>
            If forward â‰¥ 180Â°: subtract 180Â°<br><br>
            N=000Â° Â· E=090Â° Â· S=180Â° Â· W=270Â°
          </div>
        </div>
        ${steps([
          {t:`Mark ${fromLabel} and ${toLabel}`,c:`${fromLabel}=(${from.x},${from.y}), ${toLabel}=(${to.x},${to.y})`},
          {t:'Draw North from origin point',c:'Always start from North (000Â°)'},
          {t:'Measure clockwise to line',c:`Bearing = ${bs}Â°`},
          {t:'Back bearing',c:`${bs}Â° ${bearing<180?'+':'-'} 180Â° = ${backBs}Â°`},
        ])}
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AREA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderArea(){
  const s=S.area;
  let inner='',right='';
  if(s.shape==='triangle'){
    const{triA:A,triB:B,triC:C}=s;
    const svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y),svC=toSVG(C.x,C.y);
    const area=r2(Math.abs(A.x*(B.y-C.y)+B.x*(C.y-A.y)+C.x*(A.y-B.y))/2);
    inner=`<polygon points="${svA.sx},${svA.sy} ${svB.sx},${svB.sy} ${svC.sx},${svC.sy}" fill="#f59e0b" fill-opacity=".12" stroke="#f59e0b" stroke-width="2"/>
      ${dragDot(svA.sx,svA.sy,'#818cf8',`A(${A.x},${A.y})`,'area-tA')}
      ${dragDot(svB.sx,svB.sy,'#34d399',`B(${B.x},${B.y})`,'area-tB')}
      ${dragDot(svC.sx,svC.sy,'#f59e0b',`C(${C.x},${C.y})`,'area-tC')}`;
    right=fbox('Triangle Area','Â½|xâ‚(yâ‚‚âˆ’yâ‚ƒ)+xâ‚‚(yâ‚ƒâˆ’yâ‚)+xâ‚ƒ(yâ‚âˆ’yâ‚‚)|',area+' sq units','amber')+
      steps([{t:'Vertices',c:`A(${A.x},${A.y}), B(${B.x},${B.y}), C(${C.x},${C.y})`},{t:'Shoelace',c:`Â½|${A.x}(${B.y-C.y})+${B.x}(${C.y-A.y})+${C.x}(${A.y-B.y})|`},{t:'Area',c:`${area} sq units`}]);
  } else {
    const{rectA:A,rectB:B}=s;
    const svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y);
    const w=Math.abs(B.x-A.x),h=Math.abs(B.y-A.y),area=w*h;
    const minX=Math.min(svA.sx,svB.sx),minY=Math.min(svA.sy,svB.sy);
    inner=`<rect x="${minX}" y="${minY}" width="${Math.abs(svB.sx-svA.sx)}" height="${Math.abs(svB.sy-svA.sy)}" fill="#818cf8" fill-opacity=".12" stroke="#818cf8" stroke-width="2"/>
      <text x="${minX+Math.abs(svB.sx-svA.sx)/2}" y="${Math.max(svA.sy,svB.sy)+16}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="600" font-family="Space Grotesk">w=${w}</text>
      <text x="${Math.max(svA.sx,svB.sx)+14}" y="${minY+Math.abs(svB.sy-svA.sy)/2+4}" fill="#34d399" font-size="11" font-weight="600" font-family="Space Grotesk">h=${h}</text>
      ${dragDot(svA.sx,svA.sy,'#818cf8',`A(${A.x},${A.y})`,'area-rA')}
      ${dragDot(svB.sx,svB.sy,'#34d399',`B(${B.x},${B.y})`,'area-rB')}`;
    right=fbox('Rectangle Area','A = w Ã— h',area+' sq units','indigo')+steps([{t:'Width',c:`|${B.x}âˆ’${A.x}|=${w}`},{t:'Height',c:`|${B.y}âˆ’${A.y}|=${h}`},{t:'Area',c:`${w}Ã—${h}=${area}`}]);
  }
  return pageWrap('Area of Shapes','ğŸ“','Drag vertices to reshape and recalculate.',`
    ${tabs([['triangle','Triangle'],['rectangle','Rectangle']],s.shape,"S.area.shape=__V__;rerender()")}
    <div class="two-col">${makeSVG(inner,'svg-area')}<div class="ctrl-col">${right}</div></div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3D SURFACE AREA EXPLORER â€” with net unfold
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPrisms(){
  const{base:b,height:h,depth:d,shape,showNet}=S.prism;
  const hyp=r2(Math.sqrt(b*b+h*h));
  const triArea=r2(b*h/2);

  // â”€â”€ Triangular prism â”€â”€
  if(shape==='triangular'){
    const vol=r2(triArea*d);
    const rectA=r2(b*d), rectB=r2(h*d), rectC=r2(hyp*d);
    const sa=r2(2*triArea+rectA+rectB+rectC);
    const sc=14,pcx=200,pcy=200,bw=b*sc,th=h*sc,doff=d*8;
    const fT={x:pcx,y:pcy-th},fL={x:pcx-bw/2,y:pcy},fR={x:pcx+bw/2,y:pcy};
    const bT={x:fT.x+doff,y:fT.y-doff*.4},bL={x:fL.x+doff,y:fL.y-doff*.4},bR={x:fR.x+doff,y:fR.y-doff*.4};
    const prism3D=`<svg width="${W}" height="280" viewBox="0 0 ${W} 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <defs><linearGradient id="pg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#818cf8" stop-opacity=".6"/>
        <stop offset="100%" stop-color="#4f46e5" stop-opacity=".2"/></linearGradient></defs>
      <polygon points="${bT.x},${bT.y} ${bL.x},${bL.y} ${bR.x},${bR.y}" fill="#4f46e5" fill-opacity=".2" stroke="#818cf8" stroke-width="1.5" stroke-dasharray="5,4"/>
      <polygon points="${fT.x},${fT.y} ${fL.x},${fL.y} ${bL.x},${bL.y} ${bT.x},${bT.y}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="1.5"/>
      <polygon points="${fT.x},${fT.y} ${fR.x},${fR.y} ${bR.x},${bR.y} ${bT.x},${bT.y}" fill="rgba(99,102,241,.1)" stroke="#818cf8" stroke-width="1.5"/>
      <polygon points="${fT.x},${fT.y} ${fL.x},${fL.y} ${fR.x},${fR.y}" fill="url(#pg)" stroke="#818cf8" stroke-width="2.5"/>
      <line x1="${fL.x}" y1="${fL.y}" x2="${fR.x}" y2="${fR.y}" stroke="#f59e0b" stroke-width="2"/>
      <line x1="${fT.x}" y1="${fT.y}" x2="${fR.x}" y2="${fR.y}" stroke="#10b981" stroke-width="2"/>
      <line x1="${fL.x}" y1="${fL.y}" x2="${bL.x}" y2="${bL.y}" stroke="#f43f5e" stroke-width="2"/>
      <text x="${pcx}" y="${pcy+18}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">base=${b}</text>
      <text x="${fR.x+10}" y="${(fR.y+fT.y)/2}" fill="#10b981" font-size="12" font-weight="700" font-family="Space Grotesk">h=${h}</text>
      <text x="${(fL.x+bL.x)/2}" y="${fL.y-8}" fill="#f43f5e" font-size="12" font-weight="700" font-family="Space Grotesk">d=${d}</text>
    </svg>`;

    // NET layout: front triangle | rect A (base) | rect B (height) | rect C (hyp) | back triangle
    const ns=13;
    const netW=460,netH=260;
    const tH=h*ns,tB=b*ns,tHyp=hyp*ns,dN=d*ns;
    const ox=20,oy=80;
    // triangle A (front face)
    const tA_pts=`${ox},${oy+tH} ${ox+tB/2},${oy} ${ox+tB},${oy+tH}`;
    // rectangle base
    const rA_x=ox+tB,rA_y=oy,rA_w=dN,rA_h=tH;
    // rectangle height side
    const rB_x=ox+tB+dN,rB_y=oy;
    // rectangle hyp
    const rC_x=ox+tB+dN+tB,rC_y=oy;
    // triangle B (back face)
    const tB2_x=ox+tB+dN+tB+dN;
    const tB_pts=`${tB2_x},${oy+tH} ${tB2_x+tB/2},${oy} ${tB2_x+tB},${oy+tH}`;

    const netSVG=`<svg width="${netW}" height="${netH}" viewBox="0 0 ${netW} ${netH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <text x="${netW/2}" y="16" text-anchor="middle" fill="#64748b" font-size="11" font-weight="600" font-family="Space Grotesk">NET â€” all 5 faces unfolded</text>
      <!-- Front triangle -->
      <polygon points="${tA_pts}" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
      <text x="${ox+tB/2}" y="${oy+tH/2+4}" text-anchor="middle" fill="#818cf8" font-size="10" font-weight="700" font-family="Space Grotesk">â–³ ${triArea}cmÂ²</text>
      <!-- Rect A baseÃ—depth -->
      <rect x="${rA_x}" y="${rA_y}" width="${rA_w}" height="${rA_h}" fill="rgba(245,158,11,.2)" stroke="#f59e0b" stroke-width="2"/>
      <text x="${rA_x+rA_w/2}" y="${rA_y+rA_h/2+4}" text-anchor="middle" fill="#f59e0b" font-size="10" font-weight="700" font-family="Space Grotesk">${b}Ã—${d}=${rectA}</text>
      <!-- Rect B heightÃ—depth -->
      <rect x="${rB_x}" y="${rB_y}" width="${tB}" height="${tH}" fill="rgba(16,185,129,.2)" stroke="#10b981" stroke-width="2"/>
      <text x="${rB_x+tB/2}" y="${rB_y+tH/2+4}" text-anchor="middle" fill="#10b981" font-size="10" font-weight="700" font-family="Space Grotesk">${h}Ã—${d}=${rectB}</text>
      <!-- Rect C hypÃ—depth -->
      <rect x="${rC_x}" y="${rC_y}" width="${dN}" height="${tHyp}" fill="rgba(244,63,94,.2)" stroke="#f43f5e" stroke-width="2"/>
      <text x="${rC_x+dN/2}" y="${rC_y+tHyp/2+4}" text-anchor="middle" fill="#f43f5e" font-size="10" font-weight="700" font-family="Space Grotesk">${hyp}Ã—${d}=${rectC}</text>
      <!-- Back triangle -->
      <polygon points="${tB_pts}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="2" stroke-dasharray="5,3"/>
      <text x="${tB2_x+tB/2}" y="${oy+tH/2+4}" text-anchor="middle" fill="#818cf8" font-size="10" font-weight="700" font-family="Space Grotesk">â–³ ${triArea}cmÂ²</text>
    </svg>`;

    const facesHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="face-card" style="background:rgba(99,102,241,.1);border-color:rgba(99,102,241,.3)">
        <div style="font-size:10px;font-weight:700;color:#818cf8;margin-bottom:4px">2 TRIANGLES (front+back)</div>
        <div class="mono" style="font-size:12px;color:#a5b4fc">2 Ã— Â½Ã—${b}Ã—${h} = <strong>${2*triArea}</strong></div>
      </div>
      <div class="face-card" style="background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.3)">
        <div style="font-size:10px;font-weight:700;color:#f59e0b;margin-bottom:4px">BASE rectangle</div>
        <div class="mono" style="font-size:12px;color:#fcd34d">${b}Ã—${d} = <strong>${rectA}</strong></div>
      </div>
      <div class="face-card" style="background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.3)">
        <div style="font-size:10px;font-weight:700;color:#10b981;margin-bottom:4px">HEIGHT rectangle</div>
        <div class="mono" style="font-size:12px;color:#6ee7b7">${h}Ã—${d} = <strong>${rectB}</strong></div>
      </div>
      <div class="face-card" style="background:rgba(244,63,94,.1);border-color:rgba(244,63,94,.3)">
        <div style="font-size:10px;font-weight:700;color:#f43f5e;margin-bottom:4px">HYPOTENUSE rectangle</div>
        <div class="mono" style="font-size:12px;color:#fda4af">${hyp}Ã—${d} = <strong>${rectC}</strong></div>
      </div>
    </div>`;

    return pageWrap('3D Surface Area Explorer','ğŸ“¦','Adjust dimensions then unfold the net to see every face.',`
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;width:fit-content">
        <button class="btn-action${shape==='triangular'?' active':''}" onclick="S.prism.shape='triangular';S.prism.showNet=false;rerender()">Triangular Prism</button>
        <button class="btn-action" onclick="S.prism.shape='pyramid';S.prism.showNet=false;rerender()">Square Pyramid</button>
      </div>
      <div class="two-col">
        <div>
          ${showNet?netSVG:prism3D}
          <button class="btn-action" style="margin-top:12px;width:100%" onclick="S.prism.showNet=!S.prism.showNet;rerender()">
            ${showNet?'ğŸ”² Show 3D Shape':'ğŸ“ Unfold Net â€” See All Faces'}
          </button>
        </div>
        <div class="ctrl-col">
          <div class="card">
            ${SI('Base (b)','#f59e0b',b,1,12,1,'prism','base')}
            ${SI('Height (h)','#10b981',h,1,12,1,'prism','height')}
            ${SI('Depth / Length (d)','#f43f5e',d,1,15,1,'prism','depth')}
            <div style="font-size:12px;color:#475569;margin-top:4px">Hypotenuse = âˆš(bÂ²+hÂ²) = ${hyp}</div>
          </div>
          ${fbox('Total Surface Area','2â–³ + 3 rectangles',sa+' cmÂ²','indigo')}
          ${fbox('Volume','Â½ Ã— b Ã— h Ã— d',vol+' cmÂ³','emerald')}
          ${facesHTML}
          ${steps([
            {t:'Front & back triangles',c:`2 Ã— Â½ Ã— ${b} Ã— ${h} = ${2*triArea} cmÂ²`},
            {t:'Base rectangle',c:`${b} Ã— ${d} = ${rectA} cmÂ²`},
            {t:'Height-side rectangle',c:`${h} Ã— ${d} = ${rectB} cmÂ²`},
            {t:'Hypotenuse rectangle',c:`${hyp} Ã— ${d} = ${rectC} cmÂ²`},
            {t:'Total SA',c:`${2*triArea} + ${rectA} + ${rectB} + ${rectC} = ${sa} cmÂ²`},
          ])}
        </div>
      </div>`);
  }

  // â”€â”€ Square-based pyramid â”€â”€
  const sideL=b; // base side length
  const slantH=r2(Math.sqrt((sideL/2)*(sideL/2)+h*h));
  const baseArea=r2(sideL*sideL);
  const triFace=r2(0.5*sideL*slantH);
  const sa=r2(baseArea+4*triFace);
  const vol2=r2((1/3)*baseArea*h);

  const pcx=200,pcy=220,hs=sideL*14,doff=40;
  const bFL={x:pcx-hs/2,y:pcy},bFR={x:pcx+hs/2,y:pcy};
  const bBL={x:pcx-hs/2+doff,y:pcy-doff*.6};
  const bBR={x:pcx+hs/2+doff,y:pcy-doff*.6};
  const apex={x:pcx+doff/2,y:pcy-h*14-doff*.3};
  const pyr3D=`<svg width="${W}" height="280" viewBox="0 0 ${W} 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    <polygon points="${bFL.x},${bFL.y} ${bFR.x},${bFR.y} ${bBR.x},${bBR.y} ${bBL.x},${bBL.y}" fill="rgba(245,158,11,.15)" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="5,3"/>
    <polygon points="${bFL.x},${bFL.y} ${bFR.x},${bFR.y} ${apex.x},${apex.y}" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
    <polygon points="${bFR.x},${bFR.y} ${bBR.x},${bBR.y} ${apex.x},${apex.y}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="1.5"/>
    <polygon points="${bBL.x},${bBL.y} ${bFL.x},${bFL.y} ${apex.x},${apex.y}" fill="rgba(99,102,241,.1)" stroke="#818cf8" stroke-width="1.5" stroke-dasharray="5,3"/>
    <line x1="${(bFL.x+bBL.x)/2}" y1="${(bFL.y+bBL.y)/2}" x2="${apex.x}" y2="${apex.y}" stroke="#64748b" stroke-width="1" stroke-dasharray="4,3"/>
    <text x="${pcx}" y="${pcy+18}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">side=${sideL}</text>
    <text x="${apex.x+10}" y="${apex.y}" fill="#10b981" font-size="12" font-weight="700" font-family="Space Grotesk">h=${h}</text>
    <text x="${bFR.x+8}" y="${(bFR.y+apex.y)/2}" fill="#818cf8" font-size="11" font-weight="600" font-family="Space Grotesk">slant=${slantH}</text>
  </svg>`;

  // Net: base square + 4 triangles around it
  const ns2=18,netW=380,netH=320;
  const bsz=sideL*ns2,slN=slantH*ns2;
  const ncx=netW/2,ncy=netH/2+10;
  // triangles: top, bottom, left, right of base square
  const netSVG2=`<svg width="${netW}" height="${netH}" viewBox="0 0 ${netW} ${netH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    <text x="${netW/2}" y="14" text-anchor="middle" fill="#64748b" font-size="11" font-weight="600" font-family="Space Grotesk">NET â€” base + 4 triangular faces</text>
    <!-- Base square -->
    <rect x="${ncx-bsz/2}" y="${ncy-bsz/2}" width="${bsz}" height="${bsz}" fill="rgba(245,158,11,.2)" stroke="#f59e0b" stroke-width="2"/>
    <text x="${ncx}" y="${ncy+4}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="700" font-family="Space Grotesk">Base ${sideL}Â²=${baseArea}</text>
    <!-- Top triangle -->
    <polygon points="${ncx-bsz/2},${ncy-bsz/2} ${ncx+bsz/2},${ncy-bsz/2} ${ncx},${ncy-bsz/2-slN}" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
    <text x="${ncx}" y="${ncy-bsz/2-slN/2+4}" text-anchor="middle" fill="#818cf8" font-size="10" font-weight="700" font-family="Space Grotesk">Â½Ã—${sideL}Ã—${slantH}=${triFace}</text>
    <!-- Bottom triangle -->
    <polygon points="${ncx-bsz/2},${ncy+bsz/2} ${ncx+bsz/2},${ncy+bsz/2} ${ncx},${ncy+bsz/2+slN}" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
    <text x="${ncx}" y="${ncy+bsz/2+slN/2+4}" text-anchor="middle" fill="#818cf8" font-size="10" font-weight="700" font-family="Space Grotesk">Â½Ã—${sideL}Ã—${slantH}=${triFace}</text>
    <!-- Left triangle -->
    <polygon points="${ncx-bsz/2},${ncy-bsz/2} ${ncx-bsz/2},${ncy+bsz/2} ${ncx-bsz/2-slN},${ncy}" fill="rgba(16,185,129,.2)" stroke="#10b981" stroke-width="2"/>
    <text x="${ncx-bsz/2-slN/2}" y="${ncy+4}" text-anchor="middle" fill="#10b981" font-size="10" font-weight="700" font-family="Space Grotesk">${triFace}</text>
    <!-- Right triangle -->
    <polygon points="${ncx+bsz/2},${ncy-bsz/2} ${ncx+bsz/2},${ncy+bsz/2} ${ncx+bsz/2+slN},${ncy}" fill="rgba(16,185,129,.2)" stroke="#10b981" stroke-width="2"/>
    <text x="${ncx+bsz/2+slN/2}" y="${ncy+4}" text-anchor="middle" fill="#10b981" font-size="10" font-weight="700" font-family="Space Grotesk">${triFace}</text>
  </svg>`;

  const facesHTML2=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div class="face-card" style="background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.3)">
      <div style="font-size:10px;font-weight:700;color:#f59e0b;margin-bottom:4px">SQUARE BASE</div>
      <div class="mono" style="font-size:12px;color:#fcd34d">${sideL}Â² = <strong>${baseArea}</strong></div>
    </div>
    <div class="face-card" style="background:rgba(99,102,241,.1);border-color:rgba(99,102,241,.3)">
      <div style="font-size:10px;font-weight:700;color:#818cf8;margin-bottom:4px">4 TRIANGULAR FACES</div>
      <div class="mono" style="font-size:12px;color:#a5b4fc">4 Ã— Â½Ã—${sideL}Ã—${slantH} = <strong>${4*triFace}</strong></div>
    </div>
  </div>`;

  return pageWrap('3D Surface Area Explorer','ğŸ“¦','Adjust dimensions then unfold the net to see every face.',`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;width:fit-content">
      <button class="btn-action" onclick="S.prism.shape='triangular';S.prism.showNet=false;rerender()">Triangular Prism</button>
      <button class="btn-action active" onclick="S.prism.shape='pyramid';S.prism.showNet=false;rerender()">Square Pyramid</button>
    </div>
    <div class="two-col">
      <div>
        ${showNet?netSVG2:pyr3D}
        <button class="btn-action" style="margin-top:12px;width:100%" onclick="S.prism.showNet=!S.prism.showNet;rerender()">
          ${showNet?'ğŸ”² Show 3D Shape':'ğŸ“ Unfold Net â€” See All Faces'}
        </button>
      </div>
      <div class="ctrl-col">
        <div class="card">
          ${SI('Base Side (s)','#f59e0b',sideL,1,10,1,'prism','base')}
          ${SI('Vertical Height (h)','#10b981',h,1,12,1,'prism','height')}
          <div style="font-size:12px;color:#475569;margin-top:4px">Slant height = âˆš((s/2)Â²+hÂ²) = ${slantH}</div>
        </div>
        ${fbox('Total Surface Area','baseÂ² + 4 Ã— Â½sl',sa+' cmÂ²','indigo')}
        ${fbox('Volume','â…“ Ã— baseÂ² Ã— h',vol2+' cmÂ³','emerald')}
        ${facesHTML2}
        ${steps([
          {t:'Slant height',c:`âˆš((${sideL}/2)Â²+${h}Â²) = ${slantH} cm`},
          {t:'Square base',c:`${sideL}Â² = ${baseArea} cmÂ²`},
          {t:'One triangular face',c:`Â½ Ã— ${sideL} Ã— ${slantH} = ${triFace} cmÂ²`},
          {t:'Four triangular faces',c:`4 Ã— ${triFace} = ${4*triFace} cmÂ²`},
          {t:'Total SA',c:`${baseArea} + ${4*triFace} = ${sa} cmÂ²`},
        ])}
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINEAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLinear(){
  const{m,c}=S.linear;
  let pts=[];
  for(let x=-RANGE;x<=RANGE;x+=0.5){const y=m*x+c;if(y>=-RANGE&&y<=RANGE)pts.push(toSVG(x,y));}
  const pathD=pts.length?'M'+pts.map(p=>`${p.sx},${p.sy}`).join('L'):'';
  const yIntSV=toSVG(0,c);
  const xInt=m!==0?r2(-c/m):null;
  const inner=`
    ${pathD?`<path d="${pathD}" fill="none" stroke="#818cf8" stroke-width="2.5" stroke-linecap="round"/>`:''}
    <circle cx="${yIntSV.sx}" cy="${yIntSV.sy}" r="7" fill="#fbbf24" stroke="#fff" stroke-width="2"/>
    <text x="${yIntSV.sx+12}" y="${yIntSV.sy-10}" fill="#fbbf24" font-size="11" font-weight="600" font-family="Space Grotesk">c=${c}</text>`;
  return pageWrap('Linear Equations','ğŸ“‰','Adjust m and c in y = mx + c.',`
    <div class="two-col">${makeSVG(inner,'svg-lin')}
      <div class="ctrl-col">
        <div class="card">
          ${SI('Gradient (m)','#818cf8',m,-6,6,0.5,'linear','m')}
          ${SI('y-intercept (c)','#fbbf24',c,-9,9,1,'linear','c')}
        </div>
        ${fbox('Equation','y = mx + c',`y = ${m}x + (${c})`,'indigo')}
        ${fbox('y-intercept','crosses y-axis at','(0, '+c+')','amber')}
        ${xInt!==null?fbox('x-intercept','set y=0, solve for x','('+xInt+', 0)','emerald'):''}
        ${steps([{t:'Equation',c:`y = ${m}x + ${c}`},{t:'y-intercept',c:`when x=0, y=${c}`},{t:'x-intercept',c:xInt!==null?`when y=0: ${m}x=${-c}, x=${xInt}`:'line is horizontal'}])}
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUnits(){
  const{value:v,dir}=S.unit;
  const km=r2(v*1.60934),mi=r2(v/1.60934);
  return pageWrap('Miles â†” Kilometres','â†”ï¸','Convert between imperial and metric distances.',`
    <div style="max-width:520px">
      <div class="card" style="margin-bottom:20px">
        ${SI('Value','#818cf8',v,1,500,1,'unit','value')}
        <div style="display:flex;gap:8px">
          <button class="btn btn-tab${dir==='mi2km'?' active':''}" onclick="S.unit.dir='mi2km';rerender()">Miles â†’ Km</button>
          <button class="btn btn-tab${dir==='km2mi'?' active':''}" onclick="S.unit.dir='km2mi';rerender()">Km â†’ Miles</button>
        </div>
      </div>
      ${dir==='mi2km'?fbox('Miles â†’ Kilometres',v+' Ã— 1.60934',km+' km','indigo'):fbox('Kilometres â†’ Miles',v+' Ã· 1.60934',mi+' miles','emerald')}
      <div class="info-box" style="margin-top:16px">
        <div class="info-label">Quick Reference</div>
        <div style="font-size:13px;color:#94a3b8;line-height:1.9">1 mile = 1.60934 km &nbsp;|&nbsp; 1 km â‰ˆ 0.621 miles<br>5 miles â‰ˆ 8 km &nbsp;|&nbsp; Marathon = 26.2 mi = 42.2 km</div>
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARALLELOGRAM & TRAPEZIUM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderParallelogram(){
  const{type,b,h,a}=S.para;
  const svgW=380,svgH=240;
  let shape='',area,formula;
  const sc=20;
  if(type==='parallelogram'){
    area=r2(b*h);formula='A = base Ã— height';
    const ox=35,oy=190,slant=Math.min(28,h*7);
    const pts=`${ox},${oy} ${ox+b*sc},${oy} ${ox+b*sc+slant},${oy-h*sc} ${ox+slant},${oy-h*sc}`;
    shape=`<polygon points="${pts}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="2"/>
      <line x1="${ox}" y1="${oy+14}" x2="${ox+b*sc}" y2="${oy+14}" stroke="#f59e0b" stroke-width="1.5"/>
      <text x="${ox+b*sc/2}" y="${oy+26}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="600" font-family="Space Grotesk">b=${b}</text>
      <line x1="${ox+b*sc+slant+14}" y1="${oy}" x2="${ox+b*sc+slant+14}" y2="${oy-h*sc}" stroke="#10b981" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${ox+b*sc+slant+26}" y="${oy-h*sc/2+4}" fill="#10b981" font-size="11" font-weight="600" font-family="Space Grotesk">h=${h}</text>`;
  } else {
    area=r2(0.5*(b+a)*h);formula='A = Â½(a+b) Ã— h';
    const ox=30,oy=190,off=Math.min(24,a*sc/4);
    const pts=`${ox},${oy} ${ox+b*sc},${oy} ${ox+b*sc-off},${oy-h*sc} ${ox+off},${oy-h*sc}`;
    shape=`<polygon points="${pts}" fill="rgba(244,63,94,.15)" stroke="#f43f5e" stroke-width="2"/>
      <line x1="${ox}" y1="${oy+14}" x2="${ox+b*sc}" y2="${oy+14}" stroke="#f59e0b" stroke-width="1.5"/>
      <text x="${ox+b*sc/2}" y="${oy+26}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="600" font-family="Space Grotesk">b=${b}</text>
      <line x1="${ox+off}" y1="${oy-h*sc-14}" x2="${ox+b*sc-off}" y2="${oy-h*sc-14}" stroke="#818cf8" stroke-width="1.5"/>
      <text x="${ox+(b*sc)/2}" y="${oy-h*sc-20}" text-anchor="middle" fill="#818cf8" font-size="11" font-weight="600" font-family="Space Grotesk">a=${a}</text>
      <line x1="${ox+b*sc+10}" y1="${oy}" x2="${ox+b*sc+10}" y2="${oy-h*sc}" stroke="#10b981" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${ox+b*sc+22}" y="${oy-h*sc/2+4}" fill="#10b981" font-size="11" font-weight="600" font-family="Space Grotesk">h=${h}</text>`;
  }
  const color=type==='parallelogram'?'indigo':'rose';
  return pageWrap('Parallelogram & Trapezium','â¬¡','Adjust dimensions to compute area.',`
    ${tabs([['parallelogram','Parallelogram'],['trapezium','Trapezium']],type,"S.para.type=__V__;rerender()")}
    <div class="two-col">
      <svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">${shape}</svg>
      <div class="ctrl-col">
        <div class="card">
          ${SI('Base (b)','#f59e0b',b,1,12,1,'para','b')}
          ${SI('Height (h)','#10b981',h,1,8,1,'para','h')}
          ${type==='trapezium'?SI('Top (a)','#818cf8',a,1,10,1,'para','a'):''}
        </div>
        ${fbox(type.charAt(0).toUpperCase()+type.slice(1)+' Area',formula,area+' cmÂ²',color)}
        ${steps(type==='parallelogram'?[
          {t:'Formula',c:'A = base Ã— height'},
          {t:'Substitute',c:`A = ${b} Ã— ${h}`},
          {t:'Result',c:`A = ${area} cmÂ²`}]:[
          {t:'Formula',c:'A = Â½(a+b) Ã— h'},
          {t:'Substitute',c:`A = Â½(${a}+${b}) Ã— ${h}`},
          {t:'Simplify',c:`A = Â½ Ã— ${a+b} Ã— ${h}`},
          {t:'Result',c:`A = ${area} cmÂ²`}])}
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSFORMATIONS â€” fully upgraded
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTransformations(){
  const{type,shape,tx,ty,angle,cw,cx:rcx,cy:rcy,sf,mirrorLine}=S.trans;

  // Transform shape
  let transformed=[];
  const rad=angle*Math.PI/180*(cw?-1:1); // clockwise = negative rotation in standard coords

  if(type==='translate'){
    transformed=shape.map(p=>({x:r1(p.x+tx),y:r1(p.y+ty)}));
  } else if(type==='reflect'){
    if(mirrorLine==='x-axis') transformed=shape.map(p=>({x:p.x,y:-p.y}));
    else if(mirrorLine==='y-axis') transformed=shape.map(p=>({x:-p.x,y:p.y}));
    else if(mirrorLine==='y=x') transformed=shape.map(p=>({x:p.y,y:p.x}));
    else if(mirrorLine==='y=-x') transformed=shape.map(p=>({x:-p.y,y:-p.x}));
    else if(mirrorLine.startsWith('x=')){ // x = a
      const a=parseFloat(mirrorLine.slice(2));
      transformed=shape.map(p=>({x:r1(2*a-p.x),y:p.y}));
    } else if(mirrorLine.startsWith('y=')){ // y = b
      const b2=parseFloat(mirrorLine.slice(2));
      transformed=shape.map(p=>({x:p.x,y:r1(2*b2-p.y)}));
    }
  } else if(type==='rotate'){
    transformed=shape.map(p=>({
      x:r1((p.x-rcx)*Math.cos(rad)-(p.y-rcy)*Math.sin(rad)+rcx),
      y:r1((p.x-rcx)*Math.sin(rad)+(p.y-rcy)*Math.cos(rad)+rcy),
    }));
  } else if(type==='enlarge'){
    transformed=shape.map(p=>({x:r1(rcx+(p.x-rcx)*sf),y:r1(rcy+(p.y-rcy)*sf)}));
  }

  const pts=shape.map(p=>{const s=toSVG(p.x,p.y);return `${s.sx},${s.sy}`;}).join(' ');
  const tpts=transformed.map(p=>{const s=toSVG(p.x,p.y);return `${s.sx},${s.sy}`;}).join(' ');

  // Draw mirror line if reflecting
  let mirrorLineSVG='';
  if(type==='reflect'){
    if(mirrorLine==='x-axis') mirrorLineSVG=`<line x1="0" y1="${H/2}" x2="${W}" y2="${H/2}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="8" y="${H/2-6}" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">x-axis (y=0)</text>`;
    else if(mirrorLine==='y-axis') mirrorLineSVG=`<line x1="${W/2}" y1="0" x2="${W/2}" y2="${H}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="${W/2+6}" y="16" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">y-axis (x=0)</text>`;
    else if(mirrorLine==='y=x') mirrorLineSVG=`<line x1="0" y1="${H}" x2="${W}" y2="0" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="6" y="${H-6}" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">y=x</text>`;
    else if(mirrorLine==='y=-x') mirrorLineSVG=`<line x1="0" y1="0" x2="${W}" y2="${H}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="6" y="16" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">y=âˆ’x</text>`;
    else if(mirrorLine.startsWith('x=')){const a=parseFloat(mirrorLine.slice(2));const sx=toSVG(a,0).sx;mirrorLineSVG=`<line x1="${sx}" y1="0" x2="${sx}" y2="${H}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="${sx+6}" y="16" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">${mirrorLine}</text>`;}
    else if(mirrorLine.startsWith('y=')){const b2=parseFloat(mirrorLine.slice(2));const sy=toSVG(0,b2).sy;mirrorLineSVG=`<line x1="0" y1="${sy}" x2="${W}" y2="${sy}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="8" y="${sy-6}" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">${mirrorLine}</text>`;}
  }

  // Centre of rotation/enlargement dot
  let centreSVG='';
  if(type==='rotate'||type==='enlarge'){
    const sc=toSVG(rcx,rcy);
    centreSVG=`<circle cx="${sc.sx}" cy="${sc.sy}" r="6" fill="#fbbf24" stroke="#fff" stroke-width="2"/>
      <text x="${sc.sx+10}" y="${sc.sy-8}" fill="#fbbf24" font-size="11" font-weight="600" font-family="Space Grotesk">C(${rcx},${rcy})</text>`;
  }

  const inner=`
    ${mirrorLineSVG}
    <polygon points="${pts}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="2" stroke-dasharray="6,4"/>
    <polygon points="${tpts}" fill="rgba(16,185,129,.2)" stroke="#34d399" stroke-width="2.5"/>
    ${centreSVG}
    <text x="8" y="18" fill="#818cf8" font-size="11" font-weight="600" font-family="Space Grotesk">â–£ Object</text>
    <text x="8" y="34" fill="#34d399" font-size="11" font-weight="600" font-family="Space Grotesk">â–£ Image</text>`;

  const typeList=[['translate','Translate'],['reflect','Reflect'],['rotate','Rotate'],['enlarge','Enlarge']];

  // Mirror line options
  const mirrorOpts=[
    ['x-axis','x-axis (y=0)'],['y-axis','y-axis (x=0)'],
    ['y=x','y = x'],['y=-x','y = âˆ’x'],
    ['x=1','x = 1'],['x=2','x = 2'],['x=3','x = 3'],['x=4','x = 4'],
    ['y=1','y = 1'],['y=2','y = 2'],['y=3','y = 3'],['y=4','y = 4'],
  ];

  let controls='';
  if(type==='translate'){
    // Show column vector notation
    const vecHTML=`<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
      <div style="font-size:13px;color:#64748b">Column vector:</div>
      <div class="col-vec"><span>${tx}</span><span>${ty}</span></div>
    </div>`;
    controls=vecHTML+SI('x shift (tx)','#818cf8',tx,-8,8,1,'trans','tx')+SI('y shift (ty)','#34d399',ty,-8,8,1,'trans','ty');
  } else if(type==='reflect'){
    controls=`<div style="margin-bottom:14px">
      <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:10px">Mirror Line</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        ${mirrorOpts.map(([v,l])=>`<button class="btn btn-tab${mirrorLine===v?' active':''}" onclick="S.trans.mirrorLine='${v}';rerender()">${l}</button>`).join('')}
      </div>
    </div>`;
  } else if(type==='rotate'){
    controls=`<div style="display:flex;gap:8px;margin-bottom:14px">
      <button class="btn btn-tab${cw?' active':''}" onclick="S.trans.cw=true;rerender()">â†» Clockwise</button>
      <button class="btn btn-tab${!cw?' active':''}" onclick="S.trans.cw=false;rerender()">â†º Anticlockwise</button>
    </div>`+SI('Angle (Â°)','#818cf8',angle,0,360,15,'trans','angle')+SI('Centre x','#f59e0b',rcx,-5,5,1,'trans','cx')+SI('Centre y','#f43f5e',rcy,-5,5,1,'trans','cy');
  } else if(type==='enlarge'){
    controls=SI('Scale factor','#818cf8',sf,0.5,4,.5,'trans','sf')+SI('Centre x','#f59e0b',rcx,-5,5,1,'trans','cx')+SI('Centre y','#f43f5e',rcy,-5,5,1,'trans','cy');
  }

  const desc={
    translate:`Translate by column vector (${tx} / ${ty})`,
    reflect:`Reflect in the line ${mirrorLine}`,
    rotate:`Rotate ${angle}Â° ${cw?'clockwise':'anticlockwise'} about (${rcx},${rcy})`,
    enlarge:`Enlarge by scale factor ${sf}, centre (${rcx},${rcy})`,
  };

  return pageWrap('2D Transformations','ğŸ”„','Select transformation type â€” fully matches Cambridge Ch14.',`
    ${tabs(typeList,type,"S.trans.type=__V__;rerender()")}
    <div class="two-col">
      ${makeSVG(inner,'svg-trans')}
      <div class="ctrl-col">
        ${controls?`<div class="card">${controls}</div>`:''}
        ${fbox('Transformation',desc[type],'Blue â†’ Green','indigo')}
        <div class="info-box">
          <div class="info-label">Image Vertices</div>
          ${transformed.map((p,i)=>`<div style="font-size:13px;color:#94a3b8" class="mono">P${i+1}â€²: (${p.x}, ${p.y})</div>`).join('')}
        </div>
        ${type==='reflect'?`<div class="info-box"><div class="info-label">Key Rules</div>
          <div style="font-size:12px;color:#94a3b8;line-height:1.8">
            x-axis (y=0): (x,y)â†’(x,âˆ’y)<br>
            y-axis (x=0): (x,y)â†’(âˆ’x,y)<br>
            y=x: (x,y)â†’(y,x)<br>
            y=âˆ’x: (x,y)â†’(âˆ’y,âˆ’x)<br>
            x=a: (x,y)â†’(2aâˆ’x,y)<br>
            y=b: (x,y)â†’(x,2bâˆ’y)
          </div></div>`:''}
        ${type==='rotate'?`<div class="info-box"><div class="info-label">Describing a Rotation</div>
          <div style="font-size:12px;color:#94a3b8;line-height:1.8">
            Always state:<br>
            1. Angle (${angle}Â°)<br>
            2. Direction (${cw?'clockwise':'anticlockwise'})<br>
            3. Centre (${rcx}, ${rcy})
          </div></div>`:''}
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERCENTAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPercentages(){
  const{original:orig,pctChange:pct,dir,findType}=S.pct;
  let result,formula,stepArr;
  if(findType==='new'){
    const mult=dir==='increase'?1+pct/100:1-pct/100;
    result=r2(orig*mult);formula=dir==='increase'?`${orig}Ã—(1+${pct}/100)`:`${orig}Ã—(1âˆ’${pct}/100)`;
    stepArr=[{t:'Multiplier',c:dir==='increase'?`1+${pct}/100=${mult}`:`1âˆ’${pct}/100=${mult}`},{t:'Multiply',c:`${orig}Ã—${mult}=${result}`},{t:'New value',c:`After ${pct}% ${dir}: ${result}`}];
  } else if(findType==='change'){
    result=r2(pct/100*orig);formula=`${pct}/100Ã—${orig}`;
    stepArr=[{t:'Convert %',c:`${pct}Ã·100=${pct/100}`},{t:'Multiply',c:`${pct/100}Ã—${orig}=${result}`}];
  } else {
    const mult=dir==='increase'?1+pct/100:1-pct/100;
    result=r2(orig/mult);formula=dir==='increase'?`${orig}Ã·(1+${pct}/100)`:`${orig}Ã·(1âˆ’${pct}/100)`;
    stepArr=[{t:'Multiplier',c:dir==='increase'?`1+${pct}/100=${mult}`:`1âˆ’${pct}/100=${mult}`},{t:'Divide to reverse',c:`${orig}Ã·${mult}=${result}`},{t:'Original was',c:`${result}`}];
  }
  return pageWrap('Percentages','%','Percentage increase, decrease, amount and reverse.',`
    ${tabs([['new','New Value'],['change','% Amount'],['reverse','Reverse %']],findType,"S.pct.findType=__V__;rerender()")}
    <div class="two-col">
      <div class="ctrl-col">
        <div class="card">
          ${SI('Original Value','#818cf8',orig,1,1000,1,'pct','original')}
          ${SI('Percentage (%)','#f59e0b',pct,1,200,1,'pct','pctChange')}
          <div style="display:flex;gap:8px;margin-top:4px">
            <button class="btn btn-tab${dir==='increase'?' active':''}" onclick="S.pct.dir='increase';rerender()">Increase</button>
            <button class="btn btn-tab${dir==='decrease'?' active':''}" onclick="S.pct.dir='decrease';rerender()">Decrease</button>
          </div>
        </div>
        <div class="info-box">
          <div class="info-label">Visual Bar</div>
          <div style="font-size:12px;color:#64748b;margin-bottom:6px">Original: ${orig}</div>
          <div style="background:#1e293b;border-radius:6px;height:20px;overflow:hidden;margin-bottom:4px">
            <div style="width:${Math.min(100,orig/10)}%;background:#475569;height:100%"></div>
          </div>
          <div style="font-size:12px;color:${dir==='increase'?'#34d399':'#f43f5e'};margin-bottom:4px">Result: ${result}</div>
          <div style="background:#1e293b;border-radius:6px;height:20px;overflow:hidden">
            <div style="width:${Math.min(100,result/10)}%;background:${dir==='increase'?'#34d399':'#f43f5e'};height:100%"></div>
          </div>
        </div>
      </div>
      <div class="ctrl-col">
        ${fbox(findType==='new'?`After ${pct}% ${dir}`:findType==='change'?`${pct}% of ${orig}`:`Original before ${pct}% ${dir}`,formula,result,dir==='increase'?'emerald':'rose')}
        ${steps(stepArr)}
        <div class="info-box">
          <div class="info-label">Multipliers</div>
          <div style="font-size:12px;color:#94a3b8;line-height:1.9">
            Increase by ${pct}%: Ã— ${r2(1+pct/100)}<br>
            Decrease by ${pct}%: Ã— ${r2(1-pct/100)}<br>
            Increase by 200%: Ã— 3 (not Ã— 2!)
          </div>
        </div>
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATIO & PROPORTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRatio(){
  const{mode,a,b,total,simplA,simplB}=S.ratio;
  const shareA=r2(total*a/(a+b)),shareB=r2(total*b/(a+b));
  const g=gcd(simplA,simplB),sA=simplA/g,sB=simplB/g;
  const wA=Math.round(a/(a+b)*100);
  return pageWrap('Ratio & Proportion','âš–ï¸','Share amounts and simplify ratios.',`
    ${tabs([['share','Share Amount'],['simplify','Simplify Ratio']],mode,"S.ratio.mode=__V__;rerender()")}
    <div class="two-col">
      <div class="ctrl-col">
        ${mode==='share'?`<div class="card">
          ${SI('Ratio Part A','#818cf8',a,1,20,1,'ratio','a')}
          ${SI('Ratio Part B','#34d399',b,1,20,1,'ratio','b')}
          ${SI('Total Amount','#f59e0b',total,1,1000,10,'ratio','total')}
        </div>
        <div class="info-box">
          <div class="info-label">Visual Split</div>
          <div style="display:flex;border-radius:8px;overflow:hidden;height:32px;margin-bottom:6px">
            <div style="width:${wA}%;background:#818cf8;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff">${a}</div>
            <div style="width:${100-wA}%;background:#34d399;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff">${b}</div>
          </div>
        </div>`:
        `<div class="card">
          ${SI('First Number','#818cf8',simplA,1,200,1,'ratio','simplA')}
          ${SI('Second Number','#34d399',simplB,1,200,1,'ratio','simplB')}
        </div>
        <div class="info-box">
          <div class="info-label">HCF Calculation</div>
          <div style="font-size:13px;color:#94a3b8;line-height:1.8">HCF of ${simplA} and ${simplB} = ${g}<br>${simplA}Ã·${g}=${sA} &nbsp; ${simplB}Ã·${g}=${sB}</div>
        </div>`}
      </div>
      <div class="ctrl-col">
        ${mode==='share'?
          fbox(`Share ${total} in ratio ${a}:${b}`,`1 part = ${total}Ã·${a+b} = ${r2(total/(a+b))}`,`A:${shareA}  B:${shareB}`,'indigo')+
          steps([{t:'Total parts',c:`${a}+${b}=${a+b}`},{t:'One part',c:`${total}Ã·${a+b}=${r2(total/(a+b))}`},{t:'Share A',c:`${a}Ã—${r2(total/(a+b))}=${shareA}`},{t:'Share B',c:`${b}Ã—${r2(total/(a+b))}=${shareB}`}]):
          fbox(`Simplify ${simplA}:${simplB}`,'Divide both by HCF',`${sA} : ${sB}`,'emerald')+
          steps([{t:'Find HCF',c:`HCF(${simplA},${simplB})=${g}`},{t:'Divide',c:`${simplA}Ã·${g}=${sA}, ${simplB}Ã·${g}=${sB}`},{t:'Simplified',c:`${sA} : ${sB}`}])
        }
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROBABILITY â€” upgraded with complementary & two-dice
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProbability(){
  const{mode,balls}=S.prob;
  const colorMap={red:'#f43f5e',blue:'#6366f1',green:'#10b981',yellow:'#f59e0b',purple:'#a78bfa'};
  const colorNames=Object.keys(colorMap);
  const counts={};balls.forEach(b=>counts[b]=(counts[b]||0)+1);
  const total=balls.length;

  // Two-dice grid
  function twoDiceHTML(){
    const dice=[1,2,3,4,5,6];
    let rows='<tr><td style="padding:6px;color:#475569;font-size:11px">+</td>';
    dice.forEach(d=>rows+=`<td style="padding:6px;text-align:center;color:#64748b;font-size:11px;font-weight:700">${d}</td>`);
    rows+='</tr>';
    dice.forEach(d1=>{
      rows+=`<tr><td style="padding:6px;color:#64748b;font-size:11px;font-weight:700">${d1}</td>`;
      dice.forEach(d2=>{
        const sum=d1+d2;
        const c=sum===7?'rgba(99,102,241,.3)':sum===12?'rgba(244,63,94,.3)':sum===2?'rgba(16,185,129,.3)':'transparent';
        rows+=`<td style="padding:6px;text-align:center;background:${c};border-radius:4px;font-size:12px;color:#e2e8f0;font-family:'JetBrains Mono',monospace">${sum}</td>`;
      });
      rows+='</tr>';
    });
    // probabilities
    const freq={};for(let a=1;a<=6;a++)for(let b=1;b<=6;b++){const s=a+b;freq[s]=(freq[s]||0)+1;}
    return `<div style="overflow-x:auto;margin-bottom:12px"><table style="border-collapse:separate;border-spacing:3px">${rows}</table></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
        ${fbox('P(total=7)','6 ways out of 36','6/36 = 1/6','indigo')}
        ${fbox('P(total=12)','1 way out of 36','1/36','rose')}
        ${fbox('P(total=2)','1 way out of 36','1/36','emerald')}
      </div>`;
  }

  const singleProbs=Object.entries(counts).map(([col,cnt])=>({col,cnt,prob:`${cnt}/${total}`,dec:r2(cnt/total)}));

  return pageWrap('Probability','ğŸ²','Single events, complementary probabilities, two-dice combined events.',`
    ${tabs([['single','Single Event'],['complementary','Complementary'],['twodice','Two Dice']],mode,"S.prob.mode=__V__;rerender()")}
    ${mode==='twodice'?`<div>
      <div style="margin-bottom:12px;font-size:13px;color:#94a3b8">Two fair 6-sided dice are thrown and their scores are <strong style="color:#e2e8f0">added</strong>. Highlighted: 7 (most likely), 12 and 2 (least likely).</div>
      ${twoDiceHTML()}
    </div>`:
    `<div class="two-col">
      <div>
        <div class="card" style="margin-bottom:14px">
          <div class="info-label" style="margin-bottom:10px">Bag of Balls (click to remove)</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
            ${balls.map((col,i)=>`<div class="prob-ball" style="background:${colorMap[col]}" onclick="S.prob.balls.splice(${i},1);rerender()" title="Click to remove">${col[0].toUpperCase()}</div>`).join('')}
          </div>
          <div style="display:flex;gap:5px;flex-wrap:wrap">
            ${colorNames.map(col=>`<button class="btn" style="background:${colorMap[col]}22;border:1px solid ${colorMap[col]}55;color:${colorMap[col]};font-size:11px;padding:4px 8px" onclick="if(S.prob.balls.length<20)S.prob.balls.push('${col}');rerender()">+${col}</button>`).join('')}
          </div>
        </div>
        <div class="info-box">
          <div class="info-label">Counts (total = ${total})</div>
          ${Object.entries(counts).map(([col,cnt])=>`<div style="display:flex;justify-content:space-between;margin-bottom:5px">
            <div style="display:flex;align-items:center;gap:8px"><div style="width:12px;height:12px;border-radius:50%;background:${colorMap[col]}"></div><span style="font-size:13px">${col}</span></div>
            <span class="mono" style="font-size:13px;color:${colorMap[col]}">${cnt}/${total} = ${r2(cnt/total)}</span>
          </div>`).join('')}
        </div>
      </div>
      <div class="ctrl-col">
        ${mode==='single'?
          singleProbs.map(p=>fbox(`P(${p.col})`,`${p.cnt} out of ${total}`,p.prob+' = '+p.dec,p.col==='red'?'rose':p.col==='blue'?'indigo':p.col==='green'?'emerald':'amber')).join('')+
          steps([{t:'Count total',c:`Total = ${total}`},{t:'Write P',c:singleProbs.map(p=>`P(${p.col})=${p.prob}`).join(', ')}])
          :
          singleProbs.map(p=>fbox(`P(NOT ${p.col})`,'P(not E) = 1 âˆ’ P(E)',`1 âˆ’ ${p.prob} = ${r2(1-p.dec)}`,p.col==='red'?'rose':p.col==='blue'?'indigo':p.col==='green'?'emerald':'amber')).join('')+
          `<div class="info-box"><div class="info-label">Rule</div><div style="font-size:13px;color:#94a3b8;line-height:1.8">P(event) + P(not event) = 1<br>P(not event) = 1 âˆ’ P(event)</div></div>`+
          steps([{t:'P(not E) rule',c:'P(not E) = 1 âˆ’ P(E)'},{t:'Example',c:`P(not ${singleProbs[0]?.col}) = 1 âˆ’ ${singleProbs[0]?.prob} = ${r2(1-(singleProbs[0]?.cnt/total))}`}])
        }
      </div>
    </div>`}
  `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CIRCLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCircles(){
  const{r,mode,sector}=S.circle;
  const PI=Math.PI;
  const area=r2(PI*r*r),circ=r2(2*PI*r);
  const arcLen=r2((sector/360)*2*PI*r);
  const secArea=r2((sector/360)*PI*r*r);
  const svgW=300,svgH=300,cx=150,cy=150;
  const scale=Math.min(120/r,13);
  const svgR=r*scale;
  const angRad=(sector-90)*PI/180;
  const secX=cx+svgR*Math.cos(-PI/2),secY=cy+svgR*Math.sin(-PI/2);
  const secX2=cx+svgR*Math.cos(angRad-PI/2),secY2=cy+svgR*Math.sin(angRad-PI/2);
  const circleSVG=`<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    ${mode==='sector'?`<path d="M ${cx} ${cy} L ${secX} ${secY} A ${svgR} ${svgR} 0 ${sector>180?1:0} 1 ${secX2} ${secY2} Z" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
      <circle cx="${cx}" cy="${cy}" r="${svgR}" fill="none" stroke="#334155" stroke-width="1.5" stroke-dasharray="5,4"/>
      <line x1="${cx}" y1="${cy}" x2="${secX}" y2="${secY}" stroke="#818cf8" stroke-width="1.5"/>
      <line x1="${cx}" y1="${cy}" x2="${secX2}" y2="${secY2}" stroke="#818cf8" stroke-width="1.5"/>
      <text x="${cx}" y="${cy+svgR/2}" text-anchor="middle" fill="#818cf8" font-size="12" font-weight="600" font-family="Space Grotesk">${sector}Â°</text>`:`
      <circle cx="${cx}" cy="${cy}" r="${svgR}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="2.5"/>
      <line x1="${cx}" y1="${cy}" x2="${cx+svgR}" y2="${cy}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${cx+svgR/2}" y="${cy-8}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="600" font-family="Space Grotesk">r=${r}</text>`}
    <circle cx="${cx}" cy="${cy}" r="4" fill="#f43f5e"/>
  </svg>`;
  return pageWrap('Circles','â­•','Area, circumference, arc length and sectors.',`
    ${tabs([['full','Full Circle'],['sector','Sector']],mode,"S.circle.mode=__V__;rerender()")}
    <div class="two-col">
      <div>${circleSVG}<div class="card" style="margin-top:14px">
        ${SI('Radius (r)','#818cf8',r,1,15,.5,'circle','r')}
        ${mode==='sector'?SI('Sector Angle (Â°)','#f59e0b',sector,1,360,5,'circle','sector'):''}
      </div></div>
      <div class="ctrl-col">
        ${mode==='full'?`
          ${fbox('Area','A = Ï€ Ã— rÂ²',area+' cmÂ²','indigo')}
          ${fbox('Circumference','C = 2 Ã— Ï€ Ã— r',circ+' cm','emerald')}
          ${fbox('Diameter','d = 2r',r2(2*r)+' cm','amber')}
          ${steps([{t:'Area',c:`Ï€Ã—${r}Â²=Ï€Ã—${r*r}=${area}`},{t:'Circumference',c:`2Ã—Ï€Ã—${r}=${circ}`}])}`:`
          ${fbox('Arc Length','L = (Î¸/360) Ã— 2Ï€r',arcLen+' cm','indigo')}
          ${fbox('Sector Area','A = (Î¸/360) Ã— Ï€rÂ²',secArea+' cmÂ²','emerald')}
          ${steps([{t:'Fraction',c:`${sector}/360=${r2(sector/360)}`},{t:'Arc length',c:`${r2(sector/360)}Ã—2Ï€Ã—${r}=${arcLen}`},{t:'Sector area',c:`${r2(sector/360)}Ã—Ï€Ã—${r}Â²=${secArea}`}])}`}
      </div>
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PAGES={
  dashboard:renderDashboard,gradient:renderGradient,midpoint:renderMidpoint,
  bearings:renderBearings,area:renderArea,prisms:renderPrisms,linear:renderLinear,
  units:renderUnits,parallelogram:renderParallelogram,transformations:renderTransformations,
  percentages:renderPercentages,ratio:renderRatio,probability:renderProbability,circles:renderCircles,
};
function navigate(page){
  if(_dragCleanup){_dragCleanup();_dragCleanup=null;}
  PAGE=page;window.scrollTo(0,0);rerender();
}
function rerender(){
  document.getElementById('app').innerHTML=(PAGES[PAGE]||renderDashboard)();
  // Attach drag after DOM paint using rAF - reliable at any screen size
  requestAnimationFrame(function(){
    if(PAGE==='gradient'){
      attachDrag('svg-grad',function(id,x,y){
        if(id==='grad-A')S.grad.A={x,y};else S.grad.B={x,y};rerender();
      });
    } else if(PAGE==='midpoint'){
      attachDrag('svg-mid',function(id,x,y){
        if(id==='mid-A')S.mid.A={x,y};else S.mid.B={x,y};rerender();
      });
    } else if(PAGE==='bearings'){
      attachDrag('svg-bear',function(id,x,y){
        var m=S.bear.mode;
        if(id==='bear-from'){if(m==='forward')S.bear.A={x,y};else S.bear.B={x,y};}
        else{if(m==='forward')S.bear.B={x,y};else S.bear.A={x,y};}
        rerender();
      });
    } else if(PAGE==='area'){
      if(S.area.shape==='triangle'){
        attachDrag('svg-area',function(id,x,y){
          if(id==='area-tA')S.area.triA={x,y};
          else if(id==='area-tB')S.area.triB={x,y};
          else S.area.triC={x,y};
          rerender();
        });
      } else {
        attachDrag('svg-area',function(id,x,y){
          if(id==='area-rA')S.area.rectA={x,y};else S.area.rectB={x,y};rerender();
        });
      }
    }
  });
}
window.navigate=navigate;window.rerender=rerender;window.S=S;
rerender();
</script>
</body>
</html>
