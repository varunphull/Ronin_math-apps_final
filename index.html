<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ronin's Maths Interactive Tool</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MathsTool">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Android / Theme -->
  <meta name="theme-color" content="#6366f1">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- SEO / Share -->
  <meta name="description" content="Cambridge IGCSE Year 7/8 interactive maths tool â€” geometry, algebra, stats and probability.">

  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#080d1a;--card:rgba(15,23,42,0.85);--border:rgba(99,102,241,0.18);--text:#e2e8f0;--muted:#64748b}
    body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);
      background-image:linear-gradient(rgba(99,102,241,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(99,102,241,.04) 1px,transparent 1px);
      background-size:32px 32px;min-height:100vh}
    .mono{font-family:'JetBrains Mono',monospace}
    input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:5px;border-radius:4px;background:#1e293b;outline:none;cursor:pointer}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#6366f1;border:2px solid #fff;cursor:pointer}
    input[type=number],input[type=text]{background:#0f172a;border:1px solid rgba(99,102,241,.25);border-radius:8px;color:#f1f5f9;padding:6px 10px;font-size:13px;font-family:'JetBrains Mono',monospace;outline:none}
    input[type=number]{width:70px;text-align:center}
    input[type=text]{width:100%}
    input[type=number]:focus,input[type=text]:focus{border-color:#6366f1}
    input[type=number]::-webkit-inner-spin-button{opacity:1}
    .btn{padding:6px 14px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:'Space Grotesk',sans-serif}
    .btn-tab{background:transparent;color:#64748b}
    .btn-tab:hover{color:#94a3b8}
    .btn-tab.active{background:rgba(99,102,241,.25);color:#a5b4fc}
    .btn-back{display:inline-flex;align-items:center;gap:6px;color:#64748b;font-size:14px;cursor:pointer;background:none;border:none;padding:0;font-family:'Space Grotesk',sans-serif;transition:color .15s}
    .btn-back:hover{color:#e2e8f0}
    .btn-action{background:rgba(99,102,241,.2);border:1px solid rgba(99,102,241,.4);color:#a5b4fc;padding:8px 18px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:all .2s}
    .btn-action:hover{background:rgba(99,102,241,.35)}
    .btn-action.active{background:rgba(99,102,241,.4);border-color:#818cf8}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
    .topic-card{background:rgba(15,23,42,.7);border:1px solid rgba(99,102,241,.12);border-radius:16px;padding:20px;cursor:pointer;transition:all .2s}
    .topic-card:hover{border-color:rgba(99,102,241,.4);background:rgba(30,41,59,.8);transform:translateY(-2px)}
    .cat-card{border-radius:20px;padding:24px;cursor:pointer;transition:all .2s;border:1px solid}
    .cat-card:hover{transform:translateY(-3px);filter:brightness(1.1)}
    .step{background:rgba(15,23,42,.6);border:1px solid rgba(99,102,241,.1);border-radius:10px;padding:12px 16px;margin-bottom:8px;cursor:pointer}
    .step:hover{border-color:rgba(99,102,241,.3)}
    .step-body{font-size:12px;color:#94a3b8;margin-top:8px;display:none}
    .step.open .step-body{display:block}
    .tab-bar{display:flex;gap:6px;background:rgba(15,23,42,.6);padding:6px;border-radius:10px;border:1px solid rgba(99,102,241,.15);flex-wrap:wrap;width:fit-content;margin-bottom:20px}
    .page-wrap{min-height:100vh;padding:24px 16px;max-width:1100px;margin:0 auto}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start}
    @media(max-width:700px){.two-col{grid-template-columns:1fr}}
    .ctrl-col{display:flex;flex-direction:column;gap:14px}
    svg{display:block;max-width:100%;border-radius:12px}
    svg text{user-select:none}
    .si-row{margin-bottom:18px}
    .si-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .si-label span:first-child{font-size:13px;font-weight:600}
    .si-controls{display:flex;align-items:center;gap:10px}
    .si-controls input[type=range]{flex:1}
    .info-box{background:rgba(15,23,42,.6);border:1px solid rgba(99,102,241,.1);border-radius:12px;padding:16px}
    .info-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#475569;margin-bottom:8px}
    .dash-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .prob-ball{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;cursor:pointer;border:2px solid transparent;transition:all .15s}
    .steps-wrap{max-height:320px;overflow-y:auto;padding-right:4px}
    .steps-wrap::-webkit-scrollbar{width:4px}
    .steps-wrap::-webkit-scrollbar-thumb{background:#1e293b;border-radius:4px}
    .face-card{border-radius:10px;padding:12px;margin-bottom:8px;border:1px solid}
    .col-vec{display:inline-flex;flex-direction:column;align-items:center;background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.3);border-radius:6px;padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:#a5b4fc;line-height:1.4}
    /* Breadcrumb */
    .breadcrumb{display:flex;align-items:center;gap:8px;margin-bottom:24px;flex-wrap:wrap}
    .breadcrumb-item{font-size:13px;color:#64748b;cursor:pointer;transition:color .15s}
    .breadcrumb-item:hover{color:#a5b4fc}
    .breadcrumb-item.active{color:#e2e8f0;cursor:default}
    .breadcrumb-sep{color:#334155;font-size:12px}
    /* Quiz */
    .quiz-box{background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25);border-radius:16px;padding:20px;margin-top:16px}
    .quiz-input{background:#0f172a;border:1px solid rgba(99,102,241,.3);border-radius:10px;color:#f1f5f9;padding:10px 14px;font-size:16px;font-family:'JetBrains Mono',monospace;width:140px;text-align:center;outline:none}
    .quiz-input:focus{border-color:#6366f1}
    /* Sequence input */
    .seq-input{background:#0f172a;border:1px solid rgba(99,102,241,.25);border-radius:8px;color:#f1f5f9;padding:8px 12px;font-size:14px;font-family:'JetBrains Mono',monospace;width:100%;outline:none}
    .seq-input:focus{border-color:#6366f1}
    /* Data table */
    table.data-tbl{border-collapse:separate;border-spacing:3px;width:100%}
    table.data-tbl td,table.data-tbl th{padding:7px 10px;border-radius:6px;font-size:12px;text-align:center}
    table.data-tbl th{background:#1e293b;color:#64748b;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.05em}
    table.data-tbl td{background:#0f172a;color:#e2e8f0;font-family:'JetBrains Mono',monospace}
  </style>
</head>
<body>
<div id="app"></div>
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let PAGE='dashboard';
let CATEGORY=null; // null = top dashboard, else 'geometry'|'algebra'|'stats'|'probability'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={
  grad:{A:{x:-4,y:-3},B:{x:4,y:4}},
  mid:{A:{x:-5,y:-3},B:{x:5,y:4}},
  bear:{A:{x:0,y:0},B:{x:4,y:6},mode:'forward'},
  area:{shape:'triangle',triA:{x:-5,y:-4},triB:{x:5,y:-4},triC:{x:0,y:5},rectA:{x:-4,y:-3},rectB:{x:4,y:4}},
  prism:{base:6,height:4,depth:8,shape:'triangular',showNet:false,sides:5,cylR:5,coneR:4,sphereR:5,cuboidW:5},
  linear:{m:1,c:0},
  unit:{value:10,dir:'mi2km'},
  trans:{type:'translate',shape:[{x:-3,y:-2},{x:1,y:-2},{x:1,y:2},{x:-1,y:3}],tx:3,ty:2,angle:90,cw:true,cx:0,cy:0,sf:2,mirrorLine:'x-axis'},
  para:{type:'parallelogram',b:6,h:4,a:3},
  pct:{original:80,pctChange:25,dir:'increase',findType:'new'},
  ratio:{mode:'share',a:3,b:5,total:160,simplA:12,simplB:18},
  prob:{mode:'single',balls:['red','red','red','blue','blue','green']},
  circle:{r:5,mode:'full',sector:90},
  // NEW
  nth:{sequence:'2,5,8,11,14',nthTerm:'',findN:10,quizActive:false,quizQ:null,quizAnswer:'',quizResult:null},
  intersect:{m1:1,c1:0,m2:-1,c2:4},
  barchart:{labels:['Mon','Tue','Wed','Thu','Fri'],values:[4,7,3,8,5],values2:[2,5,6,3,7],mode:'single'},
  piechart:{labels:['Cats','Dogs','Birds','Fish'],values:[30,45,15,10]},
  timeseries:{points:[10,15,13,18,20,17,22,25,23,28],startYear:2015},
  stemleaf:{data:'12,15,18,21,23,25,27,31,34,35,38,42,45'},
  freqdiag:{classes:['0-10','10-20','20-30','30-40','40-50'],freqs:[3,8,12,7,4],mode:'histogram'},
  quiz:{active:false,q:null,userAns:'',result:null,score:0,total:0},
  // NEW CLASS 7 MODULES
  integers:{start:-3,change:5,mode:'add',animStep:0,animPlaying:false},
  fractions:{modeTab:'equivalent',num1:1,den1:2,num2:1,den2:3,eqNum:1,eqDen:2,eqMult:2,cols:4,rows:3},
  angles:{mode:'parallel',angleA:55,showReasons:false,quizMode:false,quizAnswer:'',quizResult:null,quizTarget:'b'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CATEGORIES={
  geometry:{
    icon:'ğŸ“',label:'Geometry & Mensuration',color:'indigo',
    desc:'Coordinates, transformations, area, 3D shapes and more.',
    topics:[
      {icon:'ğŸ“ˆ',title:'Gradient',page:'gradient',tag:'Ch14'},
      {icon:'ğŸ¯',title:'Midpoint',page:'midpoint',tag:'Ch14'},
      {icon:'ğŸ§­',title:'Bearings',page:'bearings',tag:'Ch14'},
      {icon:'ğŸ”„',title:'Transformations',page:'transformations',tag:'Ch14'},
      {icon:'ğŸ“',title:'Area of Shapes',page:'area',tag:'Ch15'},
      {icon:'â¬¡',title:'Parallelogram & Trapezium',page:'parallelogram',tag:'Ch15'},
      {icon:'ğŸ“¦',title:'3D Surface Area',page:'prisms',tag:'Ch15'},
      {icon:'â­•',title:'Circles',page:'circles',tag:'Ch15'},
      {icon:'â†”ï¸',title:'Miles â†” Km',page:'units',tag:'Ch15'},
      {icon:'ğŸ“',title:'Angle Reasoning',page:'angles',tag:'Ch6'},
    ]
  },
  algebra:{
    icon:'ğŸ”¢',label:'Algebra & Number',color:'emerald',
    desc:'Equations, sequences, graphs and number patterns.',
    topics:[
      {icon:'ğŸ“‰',title:'Linear Equations',page:'linear',tag:'Ch9'},
      {icon:'ğŸ”—',title:'Intersecting Graphs',page:'intersect',tag:'Ch9'},
      {icon:'ğŸ”¢',title:'Nth Term',page:'nth',tag:'Ch11'},
      {icon:'%',title:'Percentages',page:'percentages',tag:'Ch10'},
      {icon:'âš–ï¸',title:'Ratio & Proportion',page:'ratio',tag:'Ch12'},
      {icon:'â–',title:'Integers & Negatives',page:'integers',tag:'Ch1'},
      {icon:'Â½',title:'Fractions Visual',page:'fractions',tag:'Ch3'},
    ]
  },
  stats:{
    icon:'ğŸ“Š',label:'Statistics & Data',color:'amber',
    desc:'Charts, diagrams, stem & leaf, frequency and more.',
    topics:[
      {icon:'ğŸ“Š',title:'Bar Charts',page:'barchart',tag:'Ch16'},
      {icon:'ğŸ¥§',title:'Pie Charts',page:'piechart',tag:'Ch16'},
      {icon:'ğŸ“ˆ',title:'Time Series',page:'timeseries',tag:'Ch16'},
      {icon:'ğŸƒ',title:'Stem & Leaf',page:'stemleaf',tag:'Ch16'},
      {icon:'ğŸ“¶',title:'Frequency Diagram',page:'freqdiag',tag:'Ch16'},
    ]
  },
  probability:{
    icon:'ğŸ²',label:'Probability',color:'rose',
    desc:'Single events, complementary and combined outcomes.',
    topics:[
      {icon:'ğŸ²',title:'Probability',page:'probability',tag:'Ch13'},
    ]
  },
};

const CAT_COLORS={
  indigo:{bg:'rgba(99,102,241,.1)',border:'rgba(99,102,241,.3)',text:'#a5b4fc',accent:'#6366f1'},
  emerald:{bg:'rgba(16,185,129,.1)',border:'rgba(16,185,129,.3)',text:'#6ee7b7',accent:'#10b981'},
  amber:{bg:'rgba(245,158,11,.1)',border:'rgba(245,158,11,.3)',text:'#fcd34d',accent:'#f59e0b'},
  rose:{bg:'rgba(244,63,94,.1)',border:'rgba(244,63,94,.3)',text:'#fda4af',accent:'#f43f5e'},
  violet:{bg:'rgba(139,92,246,.1)',border:'rgba(139,92,246,.3)',text:'#c4b5fd',accent:'#a78bfa'},
  cyan:{bg:'rgba(6,182,212,.1)',border:'rgba(6,182,212,.3)',text:'#67e8f9',accent:'#22d3ee'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COORD HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W=400,H=400,RANGE=10;
function toSVG(x,y,w,h,r){w=w||W;h=h||H;r=r||RANGE;const c=w/(r*2);return{sx:w/2+x*c,sy:h/2-y*c};}
function toMath(sx,sy,w,h,r){w=w||W;h=h||H;r=r||RANGE;const c=w/(r*2);return{x:(sx-w/2)/c,y:(h/2-sy)/c};}
function snap(v){return Math.round(Math.max(-RANGE+1,Math.min(RANGE-1,v)));}
function r1(v){return Math.round(v*10)/10;}
function r2(v){return Math.round(v*100)/100;}
function r3(v){return Math.round(v*1000)/1000;}
function gcd(a,b){a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b];}return a||1;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawGrid(w,h,range){
  w=w||W;h=h||H;range=range||RANGE;
  const cell=w/(range*2),cx=w/2,cy=h/2;let s='';
  for(let i=-range;i<=range;i++){
    const x=cx+i*cell,y=cy+i*cell,axis=i===0;
    s+=`<line x1="${x}" y1="0" x2="${x}" y2="${h}" stroke="${axis?'#334155':'#1a2535'}" stroke-width="${axis?1.5:.5}"/>`;
    s+=`<line x1="0" y1="${y}" x2="${w}" y2="${y}" stroke="${axis?'#334155':'#1a2535'}" stroke-width="${axis?1.5:.5}"/>`;
    if(i!==0&&i%2===0){
      s+=`<text x="${x}" y="${cy+15}" text-anchor="middle" fill="#334155" font-size="9" font-family="Space Grotesk">${i}</text>`;
      s+=`<text x="${cx-10}" y="${y+3}" text-anchor="end" fill="#334155" font-size="9" font-family="Space Grotesk">${-i}</text>`;
    }
  }
  s+=`<polygon points="${w-6},${cy-3} ${w},${cy} ${w-6},${cy+3}" fill="#475569"/>`;
  s+=`<polygon points="${cx-3},6 ${cx},0 ${cx+3},6" fill="#475569"/>`;
  s+=`<text x="${w-4}" y="${cy-8}" fill="#475569" font-size="11" font-weight="600" text-anchor="end">x</text>`;
  s+=`<text x="${cx+10}" y="12" fill="#475569" font-size="11" font-weight="600">y</text>`;
  return s;
}
function makeSVG(inner,id,w,h){
  w=w||W;h=h||H;
  return `<svg id="${id}" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="background:#060b14;border-radius:12px;touch-action:none">${drawGrid(w,h)}${inner}</svg>`;
}
function dragDot(sx,sy,color,label,id,lx,ly){
  const tx=lx!==undefined?lx:sx+12,ty=ly!==undefined?ly:sy-14;
  return `<g class="dp" data-id="${id}" style="cursor:grab">
    <circle cx="${sx}" cy="${sy}" r="20" fill="${color}" opacity=".08"/>
    <circle cx="${sx}" cy="${sy}" r="8" fill="${color}" stroke="#fff" stroke-width="2"/>
    ${label?`<text x="${tx}" y="${ty}" fill="${color}" font-size="11" font-weight="700" font-family="Space Grotesk">${label}</text>`:''}
  </g>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dragCleanup=null;
function moveDot(dotId,sx,sy){
  const g=document.querySelector('[data-id="'+dotId+'"]');
  if(!g)return;
  g.querySelectorAll('circle').forEach(function(c){c.setAttribute('cx',sx);c.setAttribute('cy',sy);});
  const t=g.querySelector('text');
  if(t){t.setAttribute('x',sx+12);t.setAttribute('y',sy-14);}
}
function attachDrag(svgId,onDrag,onDrop){
  if(_dragCleanup){_dragCleanup();_dragCleanup=null;}
  const svg=document.getElementById(svgId);
  if(!svg)return;
  let active=null;
  function getCoords(e){
    const rect=svg.getBoundingClientRect();
    const touch=e.touches?e.touches[0]:e;
    const vb=svg.viewBox.baseVal;
    const vw=vb.width||W,vh=vb.height||H;
    const sx=(touch.clientX-rect.left)*(vw/rect.width);
    const sy=(touch.clientY-rect.top)*(vh/rect.height);
    const math=toMath(sx,sy,vw,vh);
    return{sx,sy,mx:snap(math.x),my:snap(math.y)};
  }
  function onDown(e){const g=e.target.closest('.dp');if(!g)return;e.preventDefault();active=g.dataset.id;}
  function onMv(e){if(!active)return;e.preventDefault();const c=getCoords(e);onDrag(active,c.sx,c.sy,c.mx,c.my);}
  function onUp(){if(!active)return;active=null;if(onDrop)onDrop();}
  svg.addEventListener('mousedown',onDown);
  svg.addEventListener('touchstart',onDown,{passive:false});
  window.addEventListener('mousemove',onMv);
  window.addEventListener('mouseup',onUp);
  window.addEventListener('touchmove',onMv,{passive:false});
  window.addEventListener('touchend',onUp);
  _dragCleanup=function(){
    svg.removeEventListener('mousedown',onDown);
    svg.removeEventListener('touchstart',onDown);
    window.removeEventListener('mousemove',onMv);
    window.removeEventListener('mouseup',onUp);
    window.removeEventListener('touchmove',onMv);
    window.removeEventListener('touchend',onUp);
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fbox(title,formula,result,color){
  color=color||'indigo';
  const c=CAT_COLORS[color]||CAT_COLORS.indigo;
  return `<div style="background:${c.bg};border:1px solid ${c.border};border-radius:12px;padding:14px;margin-bottom:0">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:${c.accent};margin-bottom:4px">${title}</div>
    <div class="mono" style="font-size:11px;color:#94a3b8;margin-bottom:5px">${formula}</div>
    ${result!==undefined?`<div style="font-size:18px;font-weight:700;color:${c.text}">${result}</div>`:''}
  </div>`;
}
function steps(arr){
  return `<div class="steps-wrap">`+arr.map(function(s,i){return `
    <div class="step" onclick="this.classList.toggle('open')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:13px;font-weight:600;color:#e2e8f0">Step ${i+1}: ${s.t}</div>
        <span style="color:#64748b;font-size:10px">â–¼</span>
      </div>
      <div class="step-body mono">${s.c}</div>
    </div>`;}).join('')+`</div>`;
}
function SI(label,color,val,min,max,step,key,subkey){
  const id=`si_${key}_${subkey||'v'}`;
  const nid=`ni_${key}_${subkey||'v'}`;
  const path=subkey?`${key}.${subkey}`:key;
  return `<div class="si-row">
    <div class="si-label">
      <span style="color:${color}">${label}</span>
      <input type="number" id="${nid}" min="${min}" max="${max}" step="${step}" value="${val}"
        oninput="var v=parseFloat(this.value);if(!isNaN(v)&&v>=${min}&&v<=${max}){S.${path}=v;var sl=document.getElementById('${id}');if(sl)sl.value=v;rerender();}">
    </div>
    <div class="si-controls">
      <input type="range" id="${id}" min="${min}" max="${max}" step="${step}" value="${val}"
        oninput="var v=parseFloat(this.value);S.${path}=v;var ni=document.getElementById('${nid}');if(ni)ni.value=v;"
        onchange="rerender();">
    </div>
  </div>`;
}
function tabs(items,activeVal,setExpr){
  return `<div class="tab-bar">`+items.map(function(t){const v=t[0],l=t[1];
    return `<button class="btn btn-tab${activeVal===v?' active':''}" onclick="${setExpr.replace('__V__','\''+v+'\'')}">${l}</button>`;
  }).join('')+`</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BREADCRUMB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function breadcrumb(catKey,pageTitle){
  let parts=[`<span class="breadcrumb-item" onclick="navigate('dashboard')">ğŸ  Dashboard</span>`];
  if(catKey){
    const cat=CATEGORIES[catKey];
    parts.push(`<span class="breadcrumb-sep">â€º</span>`);
    if(pageTitle){
      parts.push(`<span class="breadcrumb-item" onclick="navigateCat('${catKey}')">${cat.icon} ${cat.label}</span>`);
      parts.push(`<span class="breadcrumb-sep">â€º</span>`);
      parts.push(`<span class="breadcrumb-item active">${pageTitle}</span>`);
    } else {
      parts.push(`<span class="breadcrumb-item active">${cat.icon} ${cat.label}</span>`);
    }
  }
  return `<div class="breadcrumb">${parts.join('')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE WRAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pageWrap(title,icon,sub,content,catKey){
  return `<div class="page-wrap">
    ${breadcrumb(catKey,title)}
    <div style="margin-bottom:24px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
        <div style="width:40px;height:40px;border-radius:12px;background:rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;font-size:20px">${icon}</div>
        <h1 style="font-size:clamp(18px,3vw,26px);font-weight:700;color:#f1f5f9">${title}</h1>
      </div>
      <p style="color:#64748b;font-size:14px;margin-left:52px">${sub}</p>
    </div>${content}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function quizWidget(page){
  const q=S.quiz.q;
  if(!S.quiz.active){
    return `<div class="quiz-box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:14px;font-weight:700;color:#a5b4fc">ğŸ¯ Quiz Mode</div>
          <div style="font-size:12px;color:#64748b;margin-top:2px">Score: ${S.quiz.score}/${S.quiz.total}</div>
        </div>
        <button class="btn-action" onclick="startQuiz('${page}')">Start Quiz</button>
      </div>
    </div>`;
  }
  const resultHTML=S.quiz.result===null?'':S.quiz.result?
    `<div style="color:#34d399;font-weight:700;font-size:14px;margin-top:10px">âœ… Correct! ${q.explanation}</div>`:
    `<div style="color:#f43f5e;font-weight:700;font-size:14px;margin-top:10px">âŒ Answer: ${q.answer}. ${q.explanation}</div>`;
  return `<div class="quiz-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-size:14px;font-weight:700;color:#a5b4fc">ğŸ¯ Quiz â€” Score: ${S.quiz.score}/${S.quiz.total}</div>
      <button class="btn-action" onclick="S.quiz.active=false;S.quiz.q=null;S.quiz.result=null;rerender()">âœ• End</button>
    </div>
    <div style="font-size:14px;color:#e2e8f0;margin-bottom:12px;font-weight:600">${q?q.question:''}</div>
    <div style="display:flex;gap:10px;align-items:center">
      <input class="quiz-input" type="text" id="quiz-ans" value="${S.quiz.userAns}" placeholder="Answer..." oninput="S.quiz.userAns=this.value">
      <button class="btn-action" onclick="checkQuiz()">Check</button>
      <button class="btn-action" onclick="startQuiz('${page}')">Next â†’</button>
    </div>
    ${resultHTML}
  </div>`;
}

function startQuiz(page){
  S.quiz.active=true;S.quiz.result=null;S.quiz.userAns='';
  S.quiz.q=generateQuestion(page);rerender();
}
function checkQuiz(){
  const q=S.quiz.q;if(!q)return;
  const ans=S.quiz.userAns.trim().toLowerCase().replace(/\s/g,'');
  const correct=String(q.answer).toLowerCase().replace(/\s/g,'');
  S.quiz.result=ans===correct;
  if(S.quiz.result)S.quiz.score++;
  S.quiz.total++;rerender();
}
function generateQuestion(page){
  const qs={
    gradient:function(){
      const ax=rand(-5,5),ay=rand(-5,5),bx=rand(-5,5),by=rand(-5,5);
      const dx=bx-ax,dy=by-ay;
      if(dx===0)return generateQuestion(page);
      const m=r2(dy/dx);
      return{question:`Find the gradient of the line joining A(${ax},${ay}) and B(${bx},${by}).`,answer:String(m),explanation:`m = (${by}âˆ’${ay})/(${bx}âˆ’${ax}) = ${dy}/${dx} = ${m}`};
    },
    midpoint:function(){
      const ax=rand(-8,8),ay=rand(-8,8),bx=rand(-8,8),by=rand(-8,8);
      const mx=r1((ax+bx)/2),my=r1((ay+by)/2);
      return{question:`Find the midpoint of A(${ax},${ay}) and B(${bx},${by}).`,answer:`(${mx},${my})`,explanation:`M = ((${ax}+${bx})/2, (${ay}+${by})/2) = (${mx},${my})`};
    },
    nth:function(){
      const d=rand(1,6),a=rand(1,10);
      const seq=[a,a+d,a+2*d,a+3*d,a+4*d];
      const n=rand(8,20);
      const ans=a+(n-1)*d;
      return{question:`Sequence: ${seq.join(', ')}... Find the ${n}th term.`,answer:String(ans),explanation:`nth term = ${a}+(n-1)Ã—${d}. For n=${n}: ${a}+${n-1}Ã—${d}=${ans}`};
    },
    linear:function(){
      const m=rand(-4,4),c=rand(-5,5),x=rand(1,8);
      const y=m*x+c;
      return{question:`If y = ${m}x + (${c}), find y when x = ${x}.`,answer:String(y),explanation:`y = ${m}Ã—${x} + ${c} = ${m*x} + ${c} = ${y}`};
    },
    percentages:function(){
      const orig=rand(20,200)*5,pct=rand(1,40)*5;
      const ans=r2(orig*(1+pct/100));
      return{question:`Increase ${orig} by ${pct}%.`,answer:String(ans),explanation:`${orig} Ã— (1+${pct}/100) = ${orig} Ã— ${r2(1+pct/100)} = ${ans}`};
    },
    circles:function(){
      const r=rand(2,12);
      const area=r2(Math.PI*r*r);
      return{question:`Find the area of a circle with radius ${r} cm. (Give answer to 2 d.p.)`,answer:String(area),explanation:`A = Ï€ Ã— ${r}Â² = Ï€ Ã— ${r*r} â‰ˆ ${area} cmÂ²`};
    },
    ratio:function(){
      const a=rand(1,6),b=rand(1,6),total=rand(5,12)*(a+b);
      const shareA=total*a/(a+b);
      return{question:`Share ${total} in the ratio ${a}:${b}. What is the larger share?`,answer:String(Math.max(shareA,total-shareA)),explanation:`1 part = ${total}Ã·${a+b}=${total/(a+b)}. Shares: ${shareA} and ${total-shareA}`};
    },
    integers:function(){
      const a=rand(-10,10),b=rand(-10,10);
      const ans=a+b;
      return{question:`Calculate: ${a} + (${b})`,answer:String(ans),explanation:`${a} + (${b}) = ${ans}. ${b<0?'Adding a negative = moving left on number line':'Moving right on number line'}`};
    },
    angles:function(){
      const base=rand(30,80);
      const types=[
        {q:`Two angles on a straight line. One angle is ${base}Â°. Find the other.`,a:String(180-base),e:`Angles on a straight line sum to 180Â°. 180 - ${base} = ${180-base}Â°`},
        {q:`Vertically opposite angles. One is ${base}Â°. Find the opposite.`,a:String(base),e:`Vertically opposite angles are equal. Answer = ${base}Â°`},
        {q:`Angles in a triangle: ${base}Â° and ${base+10}Â°. Find the third.`,a:String(180-base-(base+10)),e:`Angles in triangle sum to 180Â°. 180 - ${base} - ${base+10} = ${180-base-base-10}Â°`},
      ];
      const t=types[rand(0,2)];
      return{question:t.q,answer:t.a,explanation:t.e};
    },
  };
  const fn=qs[page]||qs.linear;
  return fn();
}
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const catOrder=['geometry','algebra','stats','probability'];
  return `<div class="page-wrap" style="max-width:1100px">
    <div style="margin-bottom:40px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div style="width:48px;height:48px;border-radius:14px;background:rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;font-size:24px">ğŸ§®</div>
        <div>
          <h1 style="font-size:clamp(20px,4vw,32px);font-weight:700;color:#f1f5f9">Ronin's Maths Interactive Tool</h1>
          <p style="color:#64748b;font-size:14px">Cambridge IGCSE Year 7/8 â€” drag, explore, and learn interactively</p>
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;margin-bottom:32px">
      ${catOrder.map(function(key){
        const cat=CATEGORIES[key];
        const c=CAT_COLORS[cat.color];
        const topicCount=cat.topics.length;
        return `<div class="cat-card" style="background:${c.bg};border-color:${c.border}" onclick="navigateCat('${key}')">
          <div style="font-size:32px;margin-bottom:12px">${cat.icon}</div>
          <div style="font-weight:700;font-size:17px;color:${c.text};margin-bottom:6px">${cat.label}</div>
          <div style="font-size:13px;color:#64748b;line-height:1.5;margin-bottom:12px">${cat.desc}</div>
          <div style="font-size:11px;font-weight:700;color:${c.accent};background:${c.bg};border:1px solid ${c.border};border-radius:20px;padding:3px 10px;display:inline-block">${topicCount} topics</div>
        </div>`;
      }).join('')}
    </div>
    <div style="background:rgba(15,23,42,.6);border:1px solid rgba(99,102,241,.1);border-radius:16px;padding:20px">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#475569;margin-bottom:14px">Quick Access â€” All Topics</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        ${catOrder.map(function(key){
          const cat=CATEGORIES[key];
          const c=CAT_COLORS[cat.color];
          return cat.topics.map(function(t){
            return `<button class="btn" style="background:${c.bg};border:1px solid ${c.border};color:${c.text};font-size:12px" onclick="navigatePage('${t.page}','${key}')">${t.icon} ${t.title}</button>`;
          }).join('');
        }).join('')}
      </div>
    </div>
    <p style="text-align:center;color:#1e293b;font-size:12px;margin-top:24px">Drag points â€¢ Adjust sliders â€¢ Enter values â€¢ Take quizzes</p>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORY PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCategory(key){
  const cat=CATEGORIES[key];
  const c=CAT_COLORS[cat.color];
  return `<div class="page-wrap">
    ${breadcrumb(key)}
    <div style="margin-bottom:28px">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:8px">
        <div style="width:48px;height:48px;border-radius:14px;background:${c.bg};border:1px solid ${c.border};display:flex;align-items:center;justify-content:center;font-size:24px">${cat.icon}</div>
        <h1 style="font-size:clamp(18px,3vw,28px);font-weight:700;color:${c.text}">${cat.label}</h1>
      </div>
      <p style="color:#64748b;font-size:14px;margin-left:62px">${cat.desc}</p>
    </div>
    <div class="dash-grid">
      ${cat.topics.map(function(t){
        return `<div class="topic-card" onclick="navigatePage('${t.page}','${key}')">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
            <span style="font-size:28px">${t.icon}</span>
            <span style="font-size:10px;font-weight:700;color:#475569;background:#1e293b;padding:2px 8px;border-radius:20px">${t.tag}</span>
          </div>
          <div style="font-weight:700;color:#f1f5f9;font-size:15px;margin-bottom:4px">${t.title}</div>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXISTING TOPICS (geometry)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGradient(){
  const{A,B}=S.grad;
  const svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y);
  const dx=B.x-A.x,dy=B.y-A.y;
  const samePoint=(dx===0&&dy===0);
  const m=samePoint?'â€”':dx===0?'âˆ':r2(dy/dx);
  let lx1=0,ly1,lx2=W,ly2;
  if(dx===0){lx1=lx2=svA.sx;ly1=0;ly2=H;}
  else{const sl=-dy/dx;ly1=svA.sy+sl*(svA.sx-lx1);ly2=svA.sy+sl*(svA.sx-lx2);}
  const inner=`
    <line x1="${lx1}" y1="${ly1}" x2="${lx2}" y2="${ly2}" stroke="#6366f1" stroke-width="1.5" opacity=".4" stroke-dasharray="6,4"/>
    <line x1="${svA.sx}" y1="${svA.sy}" x2="${svB.sx}" y2="${svB.sy}" stroke="#818cf8" stroke-width="2.5"/>
    <line x1="${svA.sx}" y1="${svA.sy}" x2="${svB.sx}" y2="${svA.sy}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,3"/>
    <line x1="${svB.sx}" y1="${svA.sy}" x2="${svB.sx}" y2="${svB.sy}" stroke="#34d399" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="${(svA.sx+svB.sx)/2}" y="${svA.sy+(svA.sy>svB.sy?-8:18)}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="600" font-family="Space Grotesk">Î”x=${dx}</text>
    <text x="${svB.sx+14}" y="${(svA.sy+svB.sy)/2+4}" fill="#34d399" font-size="11" font-weight="600" font-family="Space Grotesk">Î”y=${dy}</text>
    ${dragDot(svA.sx,svA.sy,'#818cf8','A('+A.x+','+A.y+')','grad-A')}
    ${dragDot(svB.sx,svB.sy,'#34d399','B('+B.x+','+B.y+')','grad-B')}`;
  return pageWrap('Finding Gradient','ğŸ“ˆ','Drag A and B to see the gradient update in real-time.',`
    <div class="two-col">${makeSVG(inner,'svg-grad')}
      <div class="ctrl-col">
        ${fbox('Gradient','m = (yâ‚‚âˆ’yâ‚) / (xâ‚‚âˆ’xâ‚)',samePoint?'âš  Same point':m==='âˆ'?'Undefined (vertical)':m,'indigo')}
        ${fbox('Rise Î”y','yâ‚‚ âˆ’ yâ‚',dy,'emerald')}
        ${fbox('Run Î”x','xâ‚‚ âˆ’ xâ‚',dx,'amber')}
        ${steps([{t:'Label points',c:'A=('+A.x+','+A.y+'), B=('+B.x+','+B.y+')'},{t:'Rise Î”y',c:B.y+'-'+A.y+'='+dy},{t:'Run Î”x',c:B.x+'-'+A.x+'='+dx},{t:'Gradient m',c:dy+'/'+dx+' = '+m}])}
        ${quizWidget('gradient')}
      </div>
    </div>`,'geometry');
}

function renderMidpoint(){
  const{A,B}=S.mid;
  const svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y);
  const mx=r1((A.x+B.x)/2),my=r1((A.y+B.y)/2);
  const svM=toSVG(mx,my);
  const inner=`
    <line x1="${svA.sx}" y1="${svA.sy}" x2="${svB.sx}" y2="${svB.sy}" stroke="#818cf8" stroke-width="2.5"/>
    <circle cx="${svM.sx}" cy="${svM.sy}" r="9" fill="#fbbf24" stroke="#fff" stroke-width="2"/>
    <text x="${svM.sx+14}" y="${svM.sy-10}" fill="#fbbf24" font-size="12" font-weight="700" font-family="Space Grotesk">M(${mx},${my})</text>
    ${dragDot(svA.sx,svA.sy,'#818cf8','A('+A.x+','+A.y+')','mid-A')}
    ${dragDot(svB.sx,svB.sy,'#34d399','B('+B.x+','+B.y+')','mid-B')}`;
  return pageWrap('Midpoint of a Line','ğŸ¯','Drag A and B to find their midpoint M.',`
    <div class="two-col">${makeSVG(inner,'svg-mid')}
      <div class="ctrl-col">
        ${fbox('Midpoint','M = ((xâ‚+xâ‚‚)/2, (yâ‚+yâ‚‚)/2)','('+mx+', '+my+')','amber')}
        ${fbox('Midpoint x','('+A.x+'+'+B.x+')/2',mx,'indigo')}
        ${fbox('Midpoint y','('+A.y+'+'+B.y+')/2',my,'emerald')}
        ${steps([{t:'Label points',c:'A=('+A.x+','+A.y+'), B=('+B.x+','+B.y+')'},{t:'Average x',c:'('+A.x+'+'+B.x+')/2='+mx},{t:'Average y',c:'('+A.y+'+'+B.y+')/2='+my},{t:'Midpoint',c:'M=('+mx+','+my+')'}])}
        ${quizWidget('midpoint')}
      </div>
    </div>`,'geometry');
}

function renderBearings(){
  const{A,B,mode}=S.bear;
  const from=mode==='forward'?A:B,to=mode==='forward'?B:A;
  const fromLabel=mode==='forward'?'A':'B',toLabel=mode==='forward'?'B':'A';
  const svFrom=toSVG(from.x,from.y),svTo=toSVG(to.x,to.y);
  const svN=toSVG(from.x,from.y+3.5);
  const dx=to.x-from.x,dy=to.y-from.y;
  const dist=r2(Math.sqrt(dx*dx+dy*dy));
  let ang=Math.atan2(dx,dy)*180/Math.PI;if(ang<0)ang+=360;
  const bearing=Math.round(ang),bs=bearing.toString().padStart(3,'0');
  const backBearing=(bearing+180)%360,backBs=backBearing.toString().padStart(3,'0');
  const arcR=52,s0=(-90)*Math.PI/180,s1=(-90+bearing)*Math.PI/180;
  const ax1=svFrom.sx+arcR*Math.cos(s0),ay1=svFrom.sy+arcR*Math.sin(s0);
  const ax2=svFrom.sx+arcR*Math.cos(s1),ay2=svFrom.sy+arcR*Math.sin(s1);
  const svN2=toSVG(to.x,to.y+3);
  const inner=`
    <line x1="${svFrom.sx}" y1="${svFrom.sy}" x2="${svN.sx}" y2="${svN.sy}" stroke="#475569" stroke-width="2" stroke-dasharray="5,4"/>
    <text x="${svN.sx}" y="${svN.sy-8}" text-anchor="middle" fill="#64748b" font-size="13" font-weight="700" font-family="Space Grotesk">N</text>
    <line x1="${svTo.sx}" y1="${svTo.sy}" x2="${svN2.sx}" y2="${svN2.sy}" stroke="#334155" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="${svN2.sx}" y="${svN2.sy-6}" text-anchor="middle" fill="#475569" font-size="11" font-weight="700" font-family="Space Grotesk">N</text>
    <line x1="${svFrom.sx}" y1="${svFrom.sy}" x2="${svTo.sx}" y2="${svTo.sy}" stroke="#818cf8" stroke-width="2.5"/>
    <path d="M ${ax1} ${ay1} A ${arcR} ${arcR} 0 ${bearing>180?1:0} 1 ${ax2} ${ay2}" fill="none" stroke="#fbbf24" stroke-width="2.5"/>
    <text x="${svFrom.sx+62}" y="${svFrom.sy-14}" fill="#fbbf24" font-size="14" font-weight="700" font-family="Space Grotesk">${bs}Â°</text>
    ${dragDot(svFrom.sx,svFrom.sy,'#f43f5e',fromLabel+'('+from.x+','+from.y+')','bear-from')}
    ${dragDot(svTo.sx,svTo.sy,'#818cf8',toLabel+'('+to.x+','+to.y+')','bear-to')}`;
  return pageWrap('Bearings','ğŸ§­','Drag points to see bearings update.',`
    ${tabs([['forward','Bearing of B from A'],['back','Bearing of A from B']],mode,"S.bear.mode=__V__;rerender()")}
    <div class="two-col">${makeSVG(inner,'svg-bear')}
      <div class="ctrl-col">
        ${fbox('Bearing of '+toLabel+' from '+fromLabel,'Clockwise from North',bs+'Â°','indigo')}
        ${fbox('Back Bearing','Forward bearing Â± 180Â°',backBs+'Â°','amber')}
        ${fbox('Distance','d = âˆš(Î”xÂ²+Î”yÂ²)',dist+' units','emerald')}
        <div class="info-box"><div class="info-label">Key Rule</div>
          <div style="font-size:13px;color:#94a3b8;line-height:1.8">Back bearing = forward Â± 180Â°<br>N=000Â° Â· E=090Â° Â· S=180Â° Â· W=270Â°</div>
        </div>
        ${steps([{t:'Mark points',c:fromLabel+'=('+from.x+','+from.y+'), '+toLabel+'=('+to.x+','+to.y+')'},{t:'Draw North from origin',c:'Always start from North (000Â°)'},{t:'Measure clockwise',c:'Bearing = '+bs+'Â°'},{t:'Back bearing',c:bs+'Â° '+(bearing<180?'+':'-')+' 180Â° = '+backBs+'Â°'}])}
      </div>
    </div>`,'geometry');
}

function renderArea(){
  const s=S.area;
  let inner='',right='';
  if(s.shape==='triangle'){
    const A=s.triA,B=s.triB,C=s.triC;
    const svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y),svC=toSVG(C.x,C.y);
    const area=r2(Math.abs(A.x*(B.y-C.y)+B.x*(C.y-A.y)+C.x*(A.y-B.y))/2);
    const collinear=area===0;
    inner=`${collinear?'<text x="200" y="30" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">âš  Points are collinear â€” no triangle formed</text>':''}<polygon points="${svA.sx},${svA.sy} ${svB.sx},${svB.sy} ${svC.sx},${svC.sy}" fill="#f59e0b" fill-opacity=".12" stroke="#f59e0b" stroke-width="2"/>
      ${dragDot(svA.sx,svA.sy,'#818cf8','A('+A.x+','+A.y+')','area-tA')}
      ${dragDot(svB.sx,svB.sy,'#34d399','B('+B.x+','+B.y+')','area-tB')}
      ${dragDot(svC.sx,svC.sy,'#f59e0b','C('+C.x+','+C.y+')','area-tC')}`;
    right=fbox('Triangle Area','Â½|xâ‚(yâ‚‚âˆ’yâ‚ƒ)+xâ‚‚(yâ‚ƒâˆ’yâ‚)+xâ‚ƒ(yâ‚âˆ’yâ‚‚)|',area+' sq units','amber')+
      steps([{t:'Vertices',c:'A('+A.x+','+A.y+'), B('+B.x+','+B.y+'), C('+C.x+','+C.y+')'},{t:'Shoelace',c:'Â½|'+A.x+'('+( B.y-C.y)+')+'+B.x+'('+(C.y-A.y)+')+'+C.x+'('+(A.y-B.y)+')|'},{t:'Area',c:area+' sq units'}]);
  } else {
    const A=s.rectA,B=s.rectB;
    const svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y);
    const w=Math.abs(B.x-A.x),h=Math.abs(B.y-A.y),area=r2(w*h);
    const minX=Math.min(svA.sx,svB.sx),minY=Math.min(svA.sy,svB.sy);
    inner=`<rect x="${minX}" y="${minY}" width="${Math.abs(svB.sx-svA.sx)}" height="${Math.abs(svB.sy-svA.sy)}" fill="#818cf8" fill-opacity=".12" stroke="#818cf8" stroke-width="2"/>
      <text x="${minX+Math.abs(svB.sx-svA.sx)/2}" y="${Math.max(svA.sy,svB.sy)+16}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="600" font-family="Space Grotesk">w=${w}</text>
      <text x="${Math.max(svA.sx,svB.sx)+14}" y="${minY+Math.abs(svB.sy-svA.sy)/2+4}" fill="#34d399" font-size="11" font-weight="600" font-family="Space Grotesk">h=${h}</text>
      ${dragDot(svA.sx,svA.sy,'#818cf8','A('+A.x+','+A.y+')','area-rA')}
      ${dragDot(svB.sx,svB.sy,'#34d399','B('+B.x+','+B.y+')','area-rB')}`;
    right=fbox('Rectangle Area','A = w Ã— h',area+' sq units','indigo')+steps([{t:'Width',c:'|'+B.x+'âˆ’'+A.x+'|='+w},{t:'Height',c:'|'+B.y+'âˆ’'+A.y+'|='+h},{t:'Area',c:w+'Ã—'+h+'='+area}]);
  }
  return pageWrap('Area of Shapes','ğŸ“','Drag vertices to reshape and recalculate.',`
    ${tabs([['triangle','Triangle'],['rectangle','Rectangle']],s.shape,"S.area.shape=__V__;rerender()")}
    <div class="two-col">${makeSVG(inner,'svg-area')}<div class="ctrl-col">${right}</div></div>`,'geometry');
}

function renderParallelogram(){
  const{type,b,h,a}=S.para;
  const svgW=380,svgH=240;
  let shape='',area,formula;
  const sc=20;
  if(type==='parallelogram'){
    area=r2(b*h);formula='A = base Ã— height';
    const ox=35,oy=190,slant=Math.min(28,h*7);
    const pts=`${ox},${oy} ${ox+b*sc},${oy} ${ox+b*sc+slant},${oy-h*sc} ${ox+slant},${oy-h*sc}`;
    shape=`<polygon points="${pts}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="2"/>
      <line x1="${ox}" y1="${oy+14}" x2="${ox+b*sc}" y2="${oy+14}" stroke="#f59e0b" stroke-width="1.5"/>
      <text x="${ox+b*sc/2}" y="${oy+26}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="600" font-family="Space Grotesk">b=${b}</text>
      <line x1="${ox+b*sc+slant+14}" y1="${oy}" x2="${ox+b*sc+slant+14}" y2="${oy-h*sc}" stroke="#10b981" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${ox+b*sc+slant+26}" y="${oy-h*sc/2+4}" fill="#10b981" font-size="11" font-weight="600" font-family="Space Grotesk">h=${h}</text>`;
  } else {
    area=r2(0.5*(b+a)*h);formula='A = Â½(a+b) Ã— h';
    const ox=30,oy=190,off=Math.min(24,a*sc/4);
    const pts=`${ox},${oy} ${ox+b*sc},${oy} ${ox+b*sc-off},${oy-h*sc} ${ox+off},${oy-h*sc}`;
    shape=`<polygon points="${pts}" fill="rgba(244,63,94,.15)" stroke="#f43f5e" stroke-width="2"/>
      <line x1="${ox}" y1="${oy+14}" x2="${ox+b*sc}" y2="${oy+14}" stroke="#f59e0b" stroke-width="1.5"/>
      <text x="${ox+b*sc/2}" y="${oy+26}" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="600" font-family="Space Grotesk">b=${b}</text>
      <line x1="${ox+off}" y1="${oy-h*sc-14}" x2="${ox+b*sc-off}" y2="${oy-h*sc-14}" stroke="#818cf8" stroke-width="1.5"/>
      <text x="${ox+(b*sc)/2}" y="${oy-h*sc-20}" text-anchor="middle" fill="#818cf8" font-size="11" font-weight="600" font-family="Space Grotesk">a=${a}</text>
      <line x1="${ox+b*sc+10}" y1="${oy}" x2="${ox+b*sc+10}" y2="${oy-h*sc}" stroke="#10b981" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${ox+b*sc+22}" y="${oy-h*sc/2+4}" fill="#10b981" font-size="11" font-weight="600" font-family="Space Grotesk">h=${h}</text>`;
  }
  return pageWrap('Parallelogram & Trapezium','â¬¡','Adjust dimensions to compute area.',`
    ${tabs([['parallelogram','Parallelogram'],['trapezium','Trapezium']],type,"S.para.type=__V__;rerender()")}
    <div class="two-col">
      <svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">${shape}</svg>
      <div class="ctrl-col">
        <div class="card">
          ${SI('Base (b)','#f59e0b',b,1,12,1,'para','b')}
          ${SI('Height (h)','#10b981',h,1,8,1,'para','h')}
          ${type==='trapezium'?SI('Top (a)','#818cf8',a,1,10,1,'para','a'):''}
        </div>
        ${fbox((type.charAt(0).toUpperCase()+type.slice(1))+' Area',formula,area+' cmÂ²',type==='parallelogram'?'indigo':'rose')}
        ${steps(type==='parallelogram'?[{t:'Formula',c:'A = base Ã— height'},{t:'Substitute',c:'A = '+b+' Ã— '+h},{t:'Result',c:'A = '+area+' cmÂ²'}]:[{t:'Formula',c:'A = Â½(a+b) Ã— h'},{t:'Substitute',c:'A = Â½('+a+'+'+b+') Ã— '+h},{t:'Simplify',c:'A = Â½ Ã— '+(a+b)+' Ã— '+h},{t:'Result',c:'A = '+area+' cmÂ²'}])}
      </div>
    </div>`,'geometry');
}

function renderLinear(){
  const{m,c}=S.linear;
  let pts=[];
  for(let x=-RANGE;x<=RANGE;x+=0.5){const y=m*x+c;if(y>=-RANGE&&y<=RANGE)pts.push(toSVG(x,y));}
  const pathD=pts.length?'M'+pts.map(function(p){return p.sx+','+p.sy;}).join('L'):'';
  const yIntSV=toSVG(0,c);
  const xInt=m!==0?r2(-c/m):null;
  const inner=`
    ${pathD?`<path d="${pathD}" fill="none" stroke="#818cf8" stroke-width="2.5" stroke-linecap="round"/>`:''}
    <circle cx="${yIntSV.sx}" cy="${yIntSV.sy}" r="7" fill="#fbbf24" stroke="#fff" stroke-width="2"/>
    <text x="${yIntSV.sx+12}" y="${yIntSV.sy-10}" fill="#fbbf24" font-size="11" font-weight="600" font-family="Space Grotesk">c=${c}</text>`;
  return pageWrap('Linear Equations','ğŸ“‰','Adjust m and c in y = mx + c.',`
    <div class="two-col">${makeSVG(inner,'svg-lin')}
      <div class="ctrl-col">
        <div class="card">
          ${SI('Gradient (m)','#818cf8',m,-6,6,0.5,'linear','m')}
          ${SI('y-intercept (c)','#fbbf24',c,-9,9,1,'linear','c')}
        </div>
        ${fbox('Equation','y = mx + c','y = '+m+'x + ('+c+')','indigo')}
        ${fbox('y-intercept','crosses y-axis at','(0, '+c+')','amber')}
        ${xInt!==null?fbox('x-intercept','set y=0, solve for x','('+xInt+', 0)','emerald'):''}
        ${steps([{t:'Equation',c:'y = '+m+'x + '+c},{t:'y-intercept',c:'when x=0, y='+c},{t:'x-intercept',c:xInt!==null?'when y=0: '+m+'x='+(-c)+', x='+xInt:'line is horizontal'}])}
        ${quizWidget('linear')}
      </div>
    </div>`,'algebra');
}

function renderUnits(){
  const{value:v,dir}=S.unit;
  const km=r2(v*1.60934),mi=r2(v/1.60934);
  return pageWrap('Miles â†” Kilometres','â†”ï¸','Convert between imperial and metric distances.',`
    <div style="max-width:520px">
      <div class="card" style="margin-bottom:20px">
        ${SI('Value','#818cf8',v,1,500,1,'unit','value')}
        <div style="display:flex;gap:8px">
          <button class="btn btn-tab${dir==='mi2km'?' active':''}" onclick="S.unit.dir='mi2km';rerender()">Miles â†’ Km</button>
          <button class="btn btn-tab${dir==='km2mi'?' active':''}" onclick="S.unit.dir='km2mi';rerender()">Km â†’ Miles</button>
        </div>
      </div>
      ${dir==='mi2km'?fbox('Miles â†’ Kilometres',v+' Ã— 1.60934',km+' km','indigo'):fbox('Kilometres â†’ Miles',v+' Ã· 1.60934',mi+' miles','emerald')}
      <div class="info-box" style="margin-top:16px">
        <div class="info-label">Quick Reference</div>
        <div style="font-size:13px;color:#94a3b8;line-height:1.9">1 mile = 1.60934 km &nbsp;|&nbsp; 1 km â‰ˆ 0.621 miles<br>5 miles â‰ˆ 8 km &nbsp;|&nbsp; Marathon = 26.2 mi = 42.2 km</div>
      </div>
    </div>`,'geometry');
}

function renderPercentages(){
  const{original:orig,pctChange:pct,dir,findType}=S.pct;
  let result,formula,stepArr;
  if(findType==='new'){
    const mult=dir==='increase'?1+pct/100:1-pct/100;
    result=r2(orig*mult);formula=dir==='increase'?orig+'Ã—(1+'+pct+'/100)':orig+'Ã—(1âˆ’'+pct+'/100)';
    stepArr=[{t:'Multiplier',c:dir==='increase'?'1+'+pct+'/100='+mult:'1âˆ’'+pct+'/100='+mult},{t:'Multiply',c:orig+'Ã—'+mult+'='+result},{t:'New value',c:'After '+pct+'% '+dir+': '+result}];
  } else if(findType==='change'){
    result=r2(pct/100*orig);formula=pct+'/100Ã—'+orig;
    stepArr=[{t:'Convert %',c:pct+'Ã·100='+pct/100},{t:'Multiply',c:pct/100+'Ã—'+orig+'='+result}];
  } else {
    const mult=dir==='increase'?1+pct/100:1-pct/100;
    if(mult===0){
      result='âˆ';formula='Cannot reverse a 100% decrease (original was 0)';
      stepArr=[{t:'Error',c:'A 100% decrease means the value became 0. Cannot reverse â€” dividing by zero.'},{t:'Tip',c:'Try a percentage less than 100%'}];
    } else {
      result=r2(orig/mult);formula=dir==='increase'?orig+'Ã·(1+'+pct+'/100)':orig+'Ã·(1âˆ’'+pct+'/100)';
      stepArr=[{t:'Multiplier',c:dir==='increase'?'1+'+pct+'/100='+mult:'1âˆ’'+pct+'/100='+mult},{t:'Divide to reverse',c:orig+'Ã·'+mult+'='+result},{t:'Original was',c:''+result}];
    }
  }
  return pageWrap('Percentages','%','Percentage increase, decrease, amount and reverse.',`
    ${tabs([['new','New Value'],['change','% Amount'],['reverse','Reverse %']],findType,"S.pct.findType=__V__;rerender()")}
    <div class="two-col">
      <div class="ctrl-col">
        <div class="card">
          ${SI('Original Value','#818cf8',orig,1,1000,1,'pct','original')}
          ${SI('Percentage (%)','#f59e0b',pct,1,200,1,'pct','pctChange')}
          <div style="display:flex;gap:8px;margin-top:4px">
            <button class="btn btn-tab${dir==='increase'?' active':''}" onclick="S.pct.dir='increase';rerender()">Increase</button>
            <button class="btn btn-tab${dir==='decrease'?' active':''}" onclick="S.pct.dir='decrease';rerender()">Decrease</button>
          </div>
        </div>
        <div class="info-box">
          <div class="info-label">Visual Bar</div>
          <div style="font-size:12px;color:#64748b;margin-bottom:6px">Original: ${orig}</div>
          <div style="background:#1e293b;border-radius:6px;height:20px;overflow:hidden;margin-bottom:4px">
            <div style="width:${Math.min(100,orig/10)}%;background:#475569;height:100%"></div>
          </div>
          <div style="font-size:12px;color:${dir==='increase'?'#34d399':'#f43f5e'};margin-bottom:4px">Result: ${result}</div>
          <div style="background:#1e293b;border-radius:6px;height:20px;overflow:hidden">
            <div style="width:${Math.min(100,result/10)}%;background:${dir==='increase'?'#34d399':'#f43f5e'};height:100%"></div>
          </div>
        </div>
      </div>
      <div class="ctrl-col">
        ${fbox(findType==='new'?'After '+pct+'% '+dir:findType==='change'?pct+'% of '+orig:'Original before '+pct+'% '+dir,formula,result,dir==='increase'?'emerald':'rose')}
        ${steps(stepArr)}
        <div class="info-box"><div class="info-label">Multipliers</div>
          <div style="font-size:12px;color:#94a3b8;line-height:1.9">Increase by ${pct}%: Ã— ${r2(1+pct/100)}<br>Decrease by ${pct}%: Ã— ${r2(1-pct/100)}<br>Reverse: divide by the multiplier</div>
        </div>
        ${quizWidget('percentages')}
      </div>
    </div>`,'algebra');
}

function renderRatio(){
  const{mode,a,b,total,simplA,simplB}=S.ratio;
  const shareA=r2(total*a/(a+b)),shareB=r2(total*b/(a+b));
  const g=gcd(simplA,simplB),sA=simplA/g,sB=simplB/g;
  const wA=Math.round(a/(a+b)*100);
  return pageWrap('Ratio & Proportion','âš–ï¸','Share amounts and simplify ratios.',`
    ${tabs([['share','Share Amount'],['simplify','Simplify Ratio']],mode,"S.ratio.mode=__V__;rerender()")}
    <div class="two-col">
      <div class="ctrl-col">
        ${mode==='share'?`<div class="card">
          ${SI('Ratio Part A','#818cf8',a,1,20,1,'ratio','a')}
          ${SI('Ratio Part B','#34d399',b,1,20,1,'ratio','b')}
          ${SI('Total Amount','#f59e0b',total,1,1000,10,'ratio','total')}
        </div>
        <div class="info-box"><div class="info-label">Visual Split</div>
          <div style="display:flex;border-radius:8px;overflow:hidden;height:32px;margin-bottom:6px">
            <div style="width:${wA}%;background:#818cf8;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff">${a}</div>
            <div style="width:${100-wA}%;background:#34d399;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff">${b}</div>
          </div>
        </div>`:
        `<div class="card">
          ${SI('First Number','#818cf8',simplA,1,200,1,'ratio','simplA')}
          ${SI('Second Number','#34d399',simplB,1,200,1,'ratio','simplB')}
        </div>
        <div class="info-box"><div class="info-label">HCF Calculation</div>
          <div style="font-size:13px;color:#94a3b8;line-height:1.8">HCF of ${simplA} and ${simplB} = ${g}<br>${simplA}Ã·${g}=${sA} &nbsp; ${simplB}Ã·${g}=${sB}</div>
        </div>`}
      </div>
      <div class="ctrl-col">
        ${mode==='share'?
          fbox('Share '+total+' in ratio '+a+':'+b,'1 part = '+total+'Ã·'+(a+b)+' = '+r2(total/(a+b)),'A:'+shareA+'  B:'+shareB,'indigo')+
          steps([{t:'Total parts',c:a+'+'+b+'='+(a+b)},{t:'One part',c:total+'Ã·'+(a+b)+'='+r2(total/(a+b))},{t:'Share A',c:a+'Ã—'+r2(total/(a+b))+'='+shareA},{t:'Share B',c:b+'Ã—'+r2(total/(a+b))+'='+shareB}]):
          fbox('Simplify '+simplA+':'+simplB,'Divide both by HCF',sA+' : '+sB,'emerald')+
          steps([{t:'Find HCF',c:'HCF('+simplA+','+simplB+')='+g},{t:'Divide',c:simplA+'Ã·'+g+'='+sA+', '+simplB+'Ã·'+g+'='+sB},{t:'Simplified',c:sA+' : '+sB}])
        }
        ${quizWidget('ratio')}
      </div>
    </div>`,'algebra');
}

function renderProbability(){
  const{mode,balls}=S.prob;
  const colorMap={red:'#f43f5e',blue:'#6366f1',green:'#10b981',yellow:'#f59e0b',purple:'#a78bfa'};
  const colorNames=Object.keys(colorMap);
  const counts={};balls.forEach(function(b){counts[b]=(counts[b]||0)+1;});
  const total=balls.length;
  if(mode!=='twodice'&&total===0){
    return pageWrap('Probability','ğŸ²','Single events, complementary probabilities, two-dice combined events.',`
      ${tabs([['single','Single Event'],['complementary','Complementary'],['twodice','Two Dice']],mode,"S.prob.mode=__V__;rerender()")}
      <div class="info-box" style="text-align:center;padding:32px">
        <div style="font-size:32px;margin-bottom:12px">ğŸ±</div>
        <div style="font-size:15px;color:#f59e0b;font-weight:700;margin-bottom:8px">Bag is empty!</div>
        <div style="font-size:13px;color:#64748b">Add some balls using the buttons below</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:16px">
        ${Object.keys({red:'#f43f5e',blue:'#6366f1',green:'#10b981',yellow:'#f59e0b',purple:'#a78bfa'}).map(function(col){
          const cm={red:'#f43f5e',blue:'#6366f1',green:'#10b981',yellow:'#f59e0b',purple:'#a78bfa'};
          return '<button class="btn" style="background:'+cm[col]+'22;border:1px solid '+cm[col]+'55;color:'+cm[col]+';padding:8px 16px;font-size:13px" onclick="S.prob.balls.push(\''+col+'\');rerender()">+ '+col+'</button>';
        }).join('')}
      </div>`,'probability');
  }

  function twoDiceHTML(){
    const dice=[1,2,3,4,5,6];
    let rows='<tr><td style="padding:6px;color:#475569;font-size:11px">+</td>';
    dice.forEach(function(d){rows+=`<td style="padding:6px;text-align:center;color:#64748b;font-size:11px;font-weight:700">${d}</td>`;});
    rows+='</tr>';
    dice.forEach(function(d1){
      rows+=`<tr><td style="padding:6px;color:#64748b;font-size:11px;font-weight:700">${d1}</td>`;
      dice.forEach(function(d2){
        const sum=d1+d2;
        const col=sum===7?'rgba(99,102,241,.3)':sum===12||sum===2?'rgba(244,63,94,.3)':'transparent';
        rows+=`<td style="padding:6px;text-align:center;background:${col};border-radius:4px;font-size:12px;color:#e2e8f0;font-family:'JetBrains Mono',monospace">${sum}</td>`;
      });
      rows+='</tr>';
    });
    return `<div style="overflow-x:auto;margin-bottom:12px"><table style="border-collapse:separate;border-spacing:3px">${rows}</table></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
        ${fbox('P(total=7)','6 ways out of 36','6/36 = 1/6','indigo')}
        ${fbox('P(total=12)','1 way out of 36','1/36','rose')}
        ${fbox('P(total=2)','1 way out of 36','1/36','emerald')}
      </div>`;
  }

  const singleProbs=Object.entries(counts).map(function(e){const col=e[0],cnt=e[1];return{col,cnt,prob:cnt+'/'+total,dec:r2(cnt/total)};});

  return pageWrap('Probability','ğŸ²','Single events, complementary probabilities, two-dice combined events.',`
    ${tabs([['single','Single Event'],['complementary','Complementary'],['twodice','Two Dice']],mode,"S.prob.mode=__V__;rerender()")}
    ${mode==='twodice'?`<div>
      <div style="margin-bottom:12px;font-size:13px;color:#94a3b8">Two fair dice thrown â€” scores added. <strong style="color:#e2e8f0">Purple=7 (most likely), Red=2 or 12 (least likely).</strong></div>
      ${twoDiceHTML()}
    </div>`:
    `<div class="two-col">
      <div>
        <div class="card" style="margin-bottom:14px">
          <div class="info-label" style="margin-bottom:10px">Bag of Balls (click to remove)</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
            ${balls.map(function(col,i){return `<div class="prob-ball" style="background:${colorMap[col]}" onclick="S.prob.balls.splice(${i},1);rerender()" title="Remove">${col[0].toUpperCase()}</div>`;}).join('')}
          </div>
          <div style="display:flex;gap:5px;flex-wrap:wrap">
            ${colorNames.map(function(col){return `<button class="btn" style="background:${colorMap[col]}22;border:1px solid ${colorMap[col]}55;color:${colorMap[col]};font-size:11px;padding:4px 8px" onclick="if(S.prob.balls.length<20)S.prob.balls.push('${col}');rerender()">+${col}</button>`;}).join('')}
          </div>
        </div>
        <div class="info-box"><div class="info-label">Counts (total = ${total})</div>
          ${Object.entries(counts).map(function(e){const col=e[0],cnt=e[1];return `<div style="display:flex;justify-content:space-between;margin-bottom:5px">
            <div style="display:flex;align-items:center;gap:8px"><div style="width:12px;height:12px;border-radius:50%;background:${colorMap[col]}"></div><span style="font-size:13px">${col}</span></div>
            <span class="mono" style="font-size:13px;color:${colorMap[col]}">${cnt}/${total} = ${r2(cnt/total)}</span>
          </div>`;}).join('')}
        </div>
      </div>
      <div class="ctrl-col">
        ${mode==='single'?
          singleProbs.map(function(p){return fbox('P('+p.col+')',p.cnt+' out of '+total,p.prob+' = '+p.dec,p.col==='red'?'rose':p.col==='blue'?'indigo':p.col==='green'?'emerald':'amber');}).join('')+
          steps([{t:'Count total',c:'Total = '+total},{t:'Write P',c:singleProbs.map(function(p){return 'P('+p.col+')='+p.prob;}).join(', ')}]):
          singleProbs.map(function(p){return fbox('P(NOT '+p.col+')','P(not E) = 1 âˆ’ P(E)','1 âˆ’ '+p.prob+' = '+r2(1-p.dec),p.col==='red'?'rose':p.col==='blue'?'indigo':p.col==='green'?'emerald':'amber');}).join('')+
          `<div class="info-box"><div class="info-label">Rule</div><div style="font-size:13px;color:#94a3b8;line-height:1.8">P(event) + P(not event) = 1<br>P(not event) = 1 âˆ’ P(event)</div></div>`
        }
      </div>
    </div>`}`,'probability');
}

function renderCircles(){
  const{r,mode,sector}=S.circle;
  const PI=Math.PI;
  const area=r2(PI*r*r),circ=r2(2*PI*r);
  const arcLen=r2((sector/360)*2*PI*r),secArea=r2((sector/360)*PI*r*r);
  const svgW=300,svgH=300,cx=150,cy=150;
  const scale=Math.min(120/r,13),svgR=r*scale;
  const angRad=(sector-90)*PI/180;
  const secX=cx+svgR*Math.cos(-PI/2),secY=cy+svgR*Math.sin(-PI/2);
  const secX2=cx+svgR*Math.cos(angRad-PI/2),secY2=cy+svgR*Math.sin(angRad-PI/2);
  const circleSVG=`<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    ${mode==='sector'?`<path d="M ${cx} ${cy} L ${secX} ${secY} A ${svgR} ${svgR} 0 ${sector>180?1:0} 1 ${secX2} ${secY2} Z" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
      <circle cx="${cx}" cy="${cy}" r="${svgR}" fill="none" stroke="#334155" stroke-width="1.5" stroke-dasharray="5,4"/>
      <line x1="${cx}" y1="${cy}" x2="${secX}" y2="${secY}" stroke="#818cf8" stroke-width="1.5"/>
      <line x1="${cx}" y1="${cy}" x2="${secX2}" y2="${secY2}" stroke="#818cf8" stroke-width="1.5"/>
      <text x="${cx}" y="${cy+svgR/2}" text-anchor="middle" fill="#818cf8" font-size="12" font-weight="600" font-family="Space Grotesk">${sector}Â°</text>`:`
      <circle cx="${cx}" cy="${cy}" r="${svgR}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="2.5"/>
      <line x1="${cx}" y1="${cy}" x2="${cx+svgR}" y2="${cy}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${cx+svgR/2}" y="${cy-8}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="600" font-family="Space Grotesk">r=${r}</text>`}
    <circle cx="${cx}" cy="${cy}" r="4" fill="#f43f5e"/>
  </svg>`;
  return pageWrap('Circles','â­•','Area, circumference, arc length and sectors.',`
    ${tabs([['full','Full Circle'],['sector','Sector']],mode,"S.circle.mode=__V__;rerender()")}
    <div class="two-col">
      <div>${circleSVG}<div class="card" style="margin-top:14px">
        ${SI('Radius (r)','#818cf8',r,1,15,.5,'circle','r')}
        ${mode==='sector'?SI('Sector Angle (Â°)','#f59e0b',sector,1,360,5,'circle','sector'):''}
      </div></div>
      <div class="ctrl-col">
        ${mode==='full'?
          fbox('Area','A = Ï€ Ã— rÂ²',area+' cmÂ²','indigo')+fbox('Circumference','C = 2 Ã— Ï€ Ã— r',circ+' cm','emerald')+fbox('Diameter','d = 2r',r2(2*r)+' cm','amber')+
          steps([{t:'Area',c:'Ï€Ã—'+r+'Â²=Ï€Ã—'+r*r+'='+area},{t:'Circumference',c:'2Ã—Ï€Ã—'+r+'='+circ}]):`
          `+fbox('Arc Length','L = (Î¸/360) Ã— 2Ï€r',arcLen+' cm','indigo')+fbox('Sector Area','A = (Î¸/360) Ã— Ï€rÂ²',secArea+' cmÂ²','emerald')+
          steps([{t:'Fraction',c:sector+'/360='+r2(sector/360)},{t:'Arc length',c:r2(sector/360)+'Ã—2Ï€Ã—'+r+'='+arcLen},{t:'Sector area',c:r2(sector/360)+'Ã—Ï€Ã—'+r+'Â²='+secArea}])
        }
        ${quizWidget('circles')}
      </div>
    </div>`,'geometry');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3D SURFACE AREA EXPLORER â€” all 6 shapes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPrisms(){
  const{base:b,height:h,depth:d,shape,showNet,sides}=S.prism;
  const shapeButtons=`<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px">
    ${[['triangular','Triangular Prism'],['pyramid','Square Pyramid'],['cuboid','Cuboid'],['cylinder','Cylinder'],['cone','Cone'],['sphere','Sphere'],['pentahex','Penta/Hex Prism']].map(function(s){
      return `<button class="btn-action${shape===s[0]?' active':''}" onclick="S.prism.shape='${s[0]}';S.prism.showNet=false;rerender()">${s[1]}</button>`;
    }).join('')}
  </div>`;

  // â”€â”€â”€â”€â”€â”€ TRIANGULAR PRISM â”€â”€â”€â”€â”€â”€
  if(shape==='triangular'){
    const hyp=r2(Math.sqrt(b*b+h*h));
    const triArea=r2(b*h/2);
    const vol=r2(triArea*d);
    const rectA=r2(b*d),rectB=r2(h*d),rectC=r2(hyp*d);
    const sa=r2(2*triArea+rectA+rectB+rectC);
    const sc=14,pcx=200,pcy=200,bw=b*sc,th=h*sc,doff=d*8;
    const fT={x:pcx,y:pcy-th},fL={x:pcx-bw/2,y:pcy},fR={x:pcx+bw/2,y:pcy};
    const bT={x:fT.x+doff,y:fT.y-doff*.4},bL={x:fL.x+doff,y:fL.y-doff*.4},bR={x:fR.x+doff,y:fR.y-doff*.4};
    const diagram=`<svg width="400" height="280" viewBox="0 0 400 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <polygon points="${bT.x},${bT.y} ${bL.x},${bL.y} ${bR.x},${bR.y}" fill="#4f46e5" fill-opacity=".2" stroke="#818cf8" stroke-width="1.5" stroke-dasharray="5,4"/>
      <polygon points="${fT.x},${fT.y} ${fL.x},${fL.y} ${bL.x},${bL.y} ${bT.x},${bT.y}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="1.5"/>
      <polygon points="${fT.x},${fT.y} ${fR.x},${fR.y} ${bR.x},${bR.y} ${bT.x},${bT.y}" fill="rgba(99,102,241,.1)" stroke="#818cf8" stroke-width="1.5"/>
      <polygon points="${fT.x},${fT.y} ${fL.x},${fL.y} ${fR.x},${fR.y}" fill="rgba(99,102,241,.35)" stroke="#818cf8" stroke-width="2.5"/>
      <text x="${pcx}" y="${pcy+18}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">b=${b}</text>
      <text x="${fR.x+10}" y="${(fR.y+fT.y)/2}" fill="#10b981" font-size="12" font-weight="700" font-family="Space Grotesk">h=${h}</text>
      <text x="${(fL.x+bL.x)/2}" y="${fL.y-8}" fill="#f43f5e" font-size="12" font-weight="700" font-family="Space Grotesk">d=${d}</text>
    </svg>`;
    const ns=13,netW=460,netH=260,tH=h*ns,tB=b*ns,dN=d*ns,ox=20,oy=80;
    const netDiag=`<svg width="${netW}" height="${netH}" viewBox="0 0 ${netW} ${netH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <text x="${netW/2}" y="16" text-anchor="middle" fill="#64748b" font-size="11" font-weight="600" font-family="Space Grotesk">NET â€” 5 faces unfolded</text>
      <polygon points="${ox},${oy+tH} ${ox+tB/2},${oy} ${ox+tB},${oy+tH}" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
      <text x="${ox+tB/2}" y="${oy+tH/2+4}" text-anchor="middle" fill="#818cf8" font-size="10" font-weight="700" font-family="Space Grotesk">â–³${triArea}</text>
      <rect x="${ox+tB}" y="${oy}" width="${dN}" height="${tH}" fill="rgba(245,158,11,.2)" stroke="#f59e0b" stroke-width="2"/>
      <text x="${ox+tB+dN/2}" y="${oy+tH/2+4}" text-anchor="middle" fill="#f59e0b" font-size="10" font-weight="700" font-family="Space Grotesk">${b}Ã—${d}=${rectA}</text>
      <rect x="${ox+tB+dN}" y="${oy}" width="${tB}" height="${tH}" fill="rgba(16,185,129,.2)" stroke="#10b981" stroke-width="2"/>
      <text x="${ox+tB+dN+tB/2}" y="${oy+tH/2+4}" text-anchor="middle" fill="#10b981" font-size="10" font-weight="700" font-family="Space Grotesk">${h}Ã—${d}=${rectB}</text>
      <rect x="${ox+tB+dN+tB}" y="${oy}" width="${dN}" height="${hyp*ns}" fill="rgba(244,63,94,.2)" stroke="#f43f5e" stroke-width="2"/>
      <text x="${ox+tB+dN+tB+dN/2}" y="${oy+tH/2+4}" text-anchor="middle" fill="#f43f5e" font-size="10" font-weight="700" font-family="Space Grotesk">${hyp}Ã—${d}=${rectC}</text>
    </svg>`;
    return pageWrap('3D Surface Area Explorer','ğŸ“¦','Choose a shape, adjust sliders, unfold net.',shapeButtons+`
      <div class="two-col">
        <div>${showNet?netDiag:diagram}
          <button class="btn-action" style="margin-top:12px;width:100%" onclick="S.prism.showNet=!S.prism.showNet;rerender()">${showNet?'ğŸ”² Show 3D':'ğŸ“ Unfold Net'}</button>
        </div>
        <div class="ctrl-col">
          <div class="card">${SI('Base','#f59e0b',b,1,12,1,'prism','base')}${SI('Height','#10b981',h,1,12,1,'prism','height')}${SI('Depth','#f43f5e',d,1,15,1,'prism','depth')}
            <div style="font-size:12px;color:#475569;margin-top:4px">Hypotenuse = ${hyp}</div>
          </div>
          ${fbox('Total SA','2â–³ + 3 rects',sa+' cmÂ²','indigo')}${fbox('Volume','Â½Ã—bÃ—hÃ—d',vol+' cmÂ³','emerald')}
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div class="face-card" style="background:rgba(99,102,241,.1);border-color:rgba(99,102,241,.3)"><div style="font-size:10px;font-weight:700;color:#818cf8">2 TRIANGLES</div><div class="mono" style="font-size:12px;color:#a5b4fc">2Ã—Â½Ã—${b}Ã—${h}=<b>${2*triArea}</b></div></div>
            <div class="face-card" style="background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.3)"><div style="font-size:10px;font-weight:700;color:#f59e0b">BASE rect</div><div class="mono" style="font-size:12px;color:#fcd34d">${b}Ã—${d}=<b>${rectA}</b></div></div>
          </div>
          ${steps([{t:'Triangles',c:'2Ã—Â½Ã—'+b+'Ã—'+h+'='+2*triArea+' cmÂ²'},{t:'Base rect',c:b+'Ã—'+d+'='+rectA},{t:'Height rect',c:h+'Ã—'+d+'='+rectB},{t:'Hyp rect',c:hyp+'Ã—'+d+'='+rectC},{t:'Total SA',c:2*triArea+'+'+rectA+'+'+rectB+'+'+rectC+'='+sa+' cmÂ²'}])}
        </div>
      </div>`,'geometry');
  }

  // â”€â”€â”€â”€â”€â”€ CUBOID â”€â”€â”€â”€â”€â”€
  if(shape==='cuboid'){
    const l=b,w=S.prism.cuboidW,ht=h;
    const sa=r2(2*(l*w+l*ht+w*ht)),vol=r2(l*w*ht);
    const pcx=200,pcy=190,sc2=16,doff=d*7;
    const fl={x:pcx-l*sc2/2,y:pcy},fr={x:pcx+l*sc2/2,y:pcy};
    const bl={x:fl.x+doff,y:pcy-doff*.5},br={x:fr.x+doff,y:pcy-doff*.5};
    const tfl={x:fl.x,y:pcy-ht*sc2},tfr={x:fr.x,y:pcy-ht*sc2};
    const tbl={x:bl.x,y:bl.y-ht*sc2},tbr={x:br.x,y:br.y-ht*sc2};
    const diagram=`<svg width="400" height="280" viewBox="0 0 400 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <polygon points="${fl.x},${fl.y} ${fr.x},${fr.y} ${br.x},${br.y} ${bl.x},${bl.y}" fill="rgba(245,158,11,.15)" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="5,3"/>
      <polygon points="${tfl.x},${tfl.y} ${tfr.x},${tfr.y} ${tbr.x},${tbr.y} ${tbl.x},${tbl.y}" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
      <polygon points="${fl.x},${fl.y} ${fr.x},${fr.y} ${tfr.x},${tfr.y} ${tfl.x},${tfl.y}" fill="rgba(99,102,241,.2)" stroke="#818cf8" stroke-width="1.5"/>
      <polygon points="${fr.x},${fr.y} ${br.x},${br.y} ${tbr.x},${tbr.y} ${tfr.x},${tfr.y}" fill="rgba(99,102,241,.12)" stroke="#818cf8" stroke-width="1.5"/>
      <text x="${pcx}" y="${pcy+18}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">l=${l}</text>
      <text x="${tfr.x+10}" y="${(tfr.y+fr.y)/2+4}" fill="#10b981" font-size="12" font-weight="700" font-family="Space Grotesk">h=${ht}</text>
      <text x="${(fr.x+br.x)/2}" y="${(fr.y+br.y)/2-8}" fill="#f43f5e" font-size="12" font-weight="700" font-family="Space Grotesk">w=${w}</text>
    </svg>`;
    const ns=16,nw=400,nh=280,ll=l*ns,ww=w*ns,hh=ht*ns;
    const ox=20,oy=100;
    const netDiag=`<svg width="${nw}" height="${nh}" viewBox="0 0 ${nw} ${nh}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <text x="${nw/2}" y="14" text-anchor="middle" fill="#64748b" font-size="11" font-family="Space Grotesk">CUBOID NET â€” 6 faces</text>
      <rect x="${ox}" y="${oy}" width="${ll}" height="${ww}" fill="rgba(16,185,129,.2)" stroke="#10b981" stroke-width="2"/>
      <text x="${ox+ll/2}" y="${oy+ww/2+4}" text-anchor="middle" fill="#10b981" font-size="10" font-weight="700" font-family="Space Grotesk">${l}Ã—${w}=${l*w}</text>
      <rect x="${ox+ll}" y="${oy}" width="${hh}" height="${ww}" fill="rgba(99,102,241,.2)" stroke="#818cf8" stroke-width="2"/>
      <text x="${ox+ll+hh/2}" y="${oy+ww/2+4}" text-anchor="middle" fill="#818cf8" font-size="10" font-weight="700" font-family="Space Grotesk">${ht}Ã—${w}=${ht*w}</text>
      <rect x="${ox+ll+hh}" y="${oy}" width="${ll}" height="${ww}" fill="rgba(16,185,129,.2)" stroke="#10b981" stroke-width="2"/>
      <text x="${ox+ll+hh+ll/2}" y="${oy+ww/2+4}" text-anchor="middle" fill="#10b981" font-size="10" font-weight="700" font-family="Space Grotesk">${l}Ã—${w}=${l*w}</text>
      <rect x="${ox+ll}" y="${oy-hh}" width="${hh}" height="${hh}" fill="rgba(244,63,94,.2)" stroke="#f43f5e" stroke-width="2"/>
      <text x="${ox+ll+hh/2}" y="${oy-hh/2+4}" text-anchor="middle" fill="#f43f5e" font-size="10" font-weight="700" font-family="Space Grotesk">${l}Ã—${ht}=${l*ht}</text>
      <rect x="${ox+ll}" y="${oy+ww}" width="${hh}" height="${hh}" fill="rgba(244,63,94,.2)" stroke="#f43f5e" stroke-width="2"/>
      <text x="${ox+ll+hh/2}" y="${oy+ww+hh/2+4}" text-anchor="middle" fill="#f43f5e" font-size="10" font-weight="700" font-family="Space Grotesk">${l}Ã—${ht}=${l*ht}</text>
    </svg>`;
    return pageWrap('3D Surface Area Explorer','ğŸ“¦','Cuboid â€” 6 rectangular faces.',shapeButtons+`
      <div class="two-col">
        <div>${showNet?netDiag:diagram}
          <button class="btn-action" style="margin-top:12px;width:100%" onclick="S.prism.showNet=!S.prism.showNet;rerender()">${showNet?'ğŸ”² Show 3D':'ğŸ“ Unfold Net'}</button>
        </div>
        <div class="ctrl-col">
          <div class="card">${SI('Length (l)','#f59e0b',l,1,14,1,'prism','base')}${SI('Width (w)','#818cf8',w,1,12,1,'prism','cuboidW')}${SI('Height (h)','#10b981',ht,1,12,1,'prism','height')}</div>
          ${fbox('Surface Area','2(lw+lh+wh)',sa+' cmÂ²','indigo')}${fbox('Volume','l Ã— w Ã— h',r2(l*w*ht)+' cmÂ³','emerald')}
          ${steps([{t:'Top & bottom',c:'2Ã—'+l+'Ã—'+w+'='+2*l*w},{t:'Front & back',c:'2Ã—'+l+'Ã—'+ht+'='+2*l*ht},{t:'Left & right',c:'2Ã—'+w+'Ã—'+ht+'='+2*w*ht},{t:'Total SA',c:''+sa+' cmÂ²'}])}
        </div>
      </div>`,'geometry');
  }

  // â”€â”€â”€â”€â”€â”€ CYLINDER â”€â”€â”€â”€â”€â”€
  if(shape==='cylinder'){
    const r=S.prism.cylR;
    const sa=r2(2*Math.PI*r*r+2*Math.PI*r*h);
    const vol=r2(Math.PI*r*r*h);
    const curvedSA=r2(2*Math.PI*r*h),circSA=r2(2*Math.PI*r*r);
    const pcx=200,pcy=200,svR=r*18,svH=h*16;
    const diagram=`<svg width="400" height="280" viewBox="0 0 400 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <ellipse cx="${pcx}" cy="${pcy-svH}" rx="${svR}" ry="${svR*.35}" fill="rgba(99,102,241,.35)" stroke="#818cf8" stroke-width="2"/>
      <rect x="${pcx-svR}" y="${pcy-svH}" width="${2*svR}" height="${svH}" fill="rgba(99,102,241,.15)" stroke="none"/>
      <ellipse cx="${pcx}" cy="${pcy}" rx="${svR}" ry="${svR*.35}" fill="rgba(99,102,241,.1)" stroke="#818cf8" stroke-width="1.5" stroke-dasharray="5,3"/>
      <line x1="${pcx-svR}" y1="${pcy-svH}" x2="${pcx-svR}" y2="${pcy}" stroke="#818cf8" stroke-width="2"/>
      <line x1="${pcx+svR}" y1="${pcy-svH}" x2="${pcx+svR}" y2="${pcy}" stroke="#818cf8" stroke-width="2"/>
      <line x1="${pcx}" y1="${pcy-svH}" x2="${pcx+svR}" y2="${pcy-svH}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${pcx+svR/2}" y="${pcy-svH-8}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">r=${r}</text>
      <text x="${pcx+svR+10}" y="${pcy-svH/2+4}" fill="#10b981" font-size="12" font-weight="700" font-family="Space Grotesk">h=${h}</text>
    </svg>`;
    const circumf=r2(2*Math.PI*r);
    const netDiag=`<svg width="400" height="260" viewBox="0 0 400 260" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <text x="200" y="14" text-anchor="middle" fill="#64748b" font-size="11" font-family="Space Grotesk">CYLINDER NET â€” rectangle + 2 circles</text>
      <rect x="20" y="30" width="${Math.min(280,circumf*14)}" height="${Math.min(120,h*16)}" fill="rgba(99,102,241,.2)" stroke="#818cf8" stroke-width="2"/>
      <text x="${20+Math.min(280,circumf*14)/2}" y="${30+Math.min(120,h*16)/2+4}" text-anchor="middle" fill="#818cf8" font-size="10" font-weight="700" font-family="Space Grotesk">2Ï€rÃ—h=${curvedSA}</text>
      <ellipse cx="340" cy="70" rx="${Math.min(32,r*8)}" ry="${Math.min(32,r*8)}" fill="rgba(244,63,94,.2)" stroke="#f43f5e" stroke-width="2"/>
      <text x="340" y="70" text-anchor="middle" fill="#f43f5e" font-size="9" font-weight="700" font-family="Space Grotesk">Ï€rÂ²</text>
      <ellipse cx="340" cy="170" rx="${Math.min(32,r*8)}" ry="${Math.min(32,r*8)}" fill="rgba(244,63,94,.2)" stroke="#f43f5e" stroke-width="2"/>
      <text x="340" y="170" text-anchor="middle" fill="#f43f5e" font-size="9" font-weight="700" font-family="Space Grotesk">Ï€rÂ²</text>
    </svg>`;
    return pageWrap('3D Surface Area Explorer','ğŸ“¦','Cylinder â€” curved surface + 2 circles.',shapeButtons+`
      <div class="two-col">
        <div>${showNet?netDiag:diagram}
          <button class="btn-action" style="margin-top:12px;width:100%" onclick="S.prism.showNet=!S.prism.showNet;rerender()">${showNet?'ğŸ”² Show 3D':'ğŸ“ Unfold Net'}</button>
        </div>
        <div class="ctrl-col">
          <div class="card">${SI('Radius (r)','#f59e0b',r,1,12,0.5,'prism','cylR')}${SI('Height (h)','#10b981',h,1,14,0.5,'prism','height')}</div>
          ${fbox('Total SA','2Ï€rÂ² + 2Ï€rh',sa+' cmÂ²','indigo')}
          ${fbox('Curved SA','2Ï€rh',curvedSA+' cmÂ²','amber')}
          ${fbox('Volume','Ï€ Ã— rÂ² Ã— h',vol+' cmÂ³','emerald')}
          ${steps([{t:'Two circles',c:'2Ã—Ï€Ã—'+r+'Â²='+circSA},{t:'Curved surface',c:'2Ã—Ï€Ã—'+r+'Ã—'+h+'='+curvedSA},{t:'Total SA',c:circSA+'+'+curvedSA+'='+sa+' cmÂ²'}])}
        </div>
      </div>`,'geometry');
  }

  // â”€â”€â”€â”€â”€â”€ CONE â”€â”€â”€â”€â”€â”€
  if(shape==='cone'){
    const r=S.prism.coneR;
    const slant=r2(Math.sqrt(r*r+h*h));
    const sa=r2(Math.PI*r*r+Math.PI*r*slant);
    const vol=r2((1/3)*Math.PI*r*r*h);
    const curvedSA=r2(Math.PI*r*slant);
    const pcx=200,pcy=230,svR=r*20,svH=h*18;
    const diagram=`<svg width="400" height="280" viewBox="0 0 400 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <ellipse cx="${pcx}" cy="${pcy}" rx="${svR}" ry="${svR*.3}" fill="rgba(99,102,241,.1)" stroke="#818cf8" stroke-width="1.5" stroke-dasharray="5,3"/>
      <line x1="${pcx-svR}" y1="${pcy}" x2="${pcx}" y2="${pcy-svH}" stroke="#818cf8" stroke-width="2"/>
      <line x1="${pcx+svR}" y1="${pcy}" x2="${pcx}" y2="${pcy-svH}" stroke="#818cf8" stroke-width="2"/>
      <ellipse cx="${pcx}" cy="${pcy}" rx="${svR}" ry="${svR*.3}" fill="none" stroke="#818cf8" stroke-width="1.5"/>
      <line x1="${pcx}" y1="${pcy}" x2="${pcx+svR}" y2="${pcy}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${pcx+svR/2}" y="${pcy+16}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">r=${r}</text>
      <line x1="${pcx}" y1="${pcy-svH}" x2="${pcx}" y2="${pcy}" stroke="#64748b" stroke-width="1" stroke-dasharray="4,3"/>
      <text x="${pcx+8}" y="${pcy-svH/2}" fill="#10b981" font-size="12" font-weight="700" font-family="Space Grotesk">h=${h}</text>
      <text x="${pcx-svR/2-10}" y="${pcy-svH/2-10}" fill="#f43f5e" font-size="12" font-weight="700" font-family="Space Grotesk">l=${slant}</text>
    </svg>`;
    return pageWrap('3D Surface Area Explorer','ğŸ“¦','Cone â€” base circle + curved surface.',shapeButtons+`
      <div class="two-col">
        <div>${diagram}</div>
        <div class="ctrl-col">
          <div class="card">${SI('Radius (r)','#f59e0b',r,1,12,0.5,'prism','coneR')}${SI('Height (h)','#10b981',h,1,14,0.5,'prism','height')}
            <div style="font-size:12px;color:#475569;margin-top:4px">Slant height l = âˆš(rÂ²+hÂ²) = ${slant}</div>
          </div>
          ${fbox('Total SA','Ï€rÂ² + Ï€rl',sa+' cmÂ²','indigo')}
          ${fbox('Curved SA','Ï€rl',curvedSA+' cmÂ²','amber')}
          ${fbox('Volume','â…“ Ã— Ï€rÂ² Ã— h',vol+' cmÂ³','emerald')}
          ${steps([{t:'Slant height',c:'âˆš('+r+'Â²+'+h+'Â²)='+slant},{t:'Base circle',c:'Ï€Ã—'+r+'Â²='+r2(Math.PI*r*r)},{t:'Curved SA',c:'Ï€Ã—'+r+'Ã—'+slant+'='+curvedSA},{t:'Total SA',c:sa+' cmÂ²'}])}
        </div>
      </div>`,'geometry');
  }

  // â”€â”€â”€â”€â”€â”€ SPHERE â”€â”€â”€â”€â”€â”€
  if(shape==='sphere'){
    const r=S.prism.sphereR;
    const sa=r2(4*Math.PI*r*r);
    const vol=r2((4/3)*Math.PI*r*r*r);
    const pcx=200,pcy=160,svR=r*22;
    const diagram=`<svg width="400" height="280" viewBox="0 0 400 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <defs><radialGradient id="sg" cx="35%" cy="35%"><stop offset="0%" stop-color="#818cf8" stop-opacity=".8"/><stop offset="100%" stop-color="#312e81" stop-opacity=".3"/></radialGradient></defs>
      <circle cx="${pcx}" cy="${pcy}" r="${svR}" fill="url(#sg)" stroke="#818cf8" stroke-width="2"/>
      <ellipse cx="${pcx}" cy="${pcy}" rx="${svR}" ry="${svR*.25}" fill="none" stroke="#818cf8" stroke-width="1" stroke-dasharray="5,3" opacity=".5"/>
      <line x1="${pcx}" y1="${pcy}" x2="${pcx+svR}" y2="${pcy}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${pcx+svR/2}" y="${pcy-10}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">r=${r}</text>
    </svg>`;
    return pageWrap('3D Surface Area Explorer','ğŸ“¦','Sphere â€” 4Ï€rÂ² surface area.',shapeButtons+`
      <div class="two-col">
        <div>${diagram}</div>
        <div class="ctrl-col">
          <div class="card">${SI('Radius (r)','#f59e0b',r,1,12,0.5,'prism','sphereR')}</div>
          ${fbox('Surface Area','4 Ã— Ï€ Ã— rÂ²',sa+' cmÂ²','indigo')}
          ${fbox('Volume','â´â„â‚ƒ Ã— Ï€ Ã— rÂ³',vol+' cmÂ³','emerald')}
          ${fbox('Diameter','2r',r2(2*r)+' cm','amber')}
          ${steps([{t:'SA formula',c:'4Ã—Ï€Ã—rÂ²'},{t:'Substitute',c:'4Ã—Ï€Ã—'+r+'Â²=4Ã—Ï€Ã—'+r*r},{t:'SA',c:sa+' cmÂ²'},{t:'Volume',c:'4/3Ã—Ï€Ã—'+r+'Â³='+vol+' cmÂ³'}])}
        </div>
      </div>`,'geometry');
  }

  // â”€â”€â”€â”€â”€â”€ SQUARE PYRAMID â”€â”€â”€â”€â”€â”€
  if(shape==='pyramid'){
    const sideL=b;
    const slantH=r2(Math.sqrt((sideL/2)*(sideL/2)+h*h));
    const baseArea=r2(sideL*sideL);
    const triFace=r2(0.5*sideL*slantH);
    const sa=r2(baseArea+4*triFace);
    const vol2=r2((1/3)*baseArea*h);
    const pcx=200,pcy=230,hs=sideL*14,doff=40;
    const bFL={x:pcx-hs/2,y:pcy},bFR={x:pcx+hs/2,y:pcy};
    const bBL={x:pcx-hs/2+doff,y:pcy-doff*.6};
    const bBR={x:pcx+hs/2+doff,y:pcy-doff*.6};
    const apex={x:pcx+doff/2,y:pcy-h*14-doff*.3};
    const diagram=`<svg width="400" height="280" viewBox="0 0 400 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
      <polygon points="${bFL.x},${bFL.y} ${bFR.x},${bFR.y} ${bBR.x},${bBR.y} ${bBL.x},${bBL.y}" fill="rgba(245,158,11,.15)" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="5,3"/>
      <polygon points="${bFL.x},${bFL.y} ${bFR.x},${bFR.y} ${apex.x},${apex.y}" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2"/>
      <polygon points="${bFR.x},${bFR.y} ${bBR.x},${bBR.y} ${apex.x},${apex.y}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="1.5"/>
      <polygon points="${bBL.x},${bBL.y} ${bFL.x},${bFL.y} ${apex.x},${apex.y}" fill="rgba(99,102,241,.1)" stroke="#818cf8" stroke-width="1.5" stroke-dasharray="5,3"/>
      <text x="${pcx}" y="${pcy+18}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">side=${sideL}</text>
      <text x="${apex.x+10}" y="${apex.y}" fill="#10b981" font-size="12" font-weight="700" font-family="Space Grotesk">h=${h}</text>
    </svg>`;
    return pageWrap('3D Surface Area Explorer','ğŸ“¦','Square pyramid â€” base + 4 triangular faces.',shapeButtons+`
      <div class="two-col">
        <div>${diagram}</div>
        <div class="ctrl-col">
          <div class="card">${SI('Base side (s)','#f59e0b',sideL,1,10,1,'prism','base')}${SI('Height (h)','#10b981',h,1,12,1,'prism','height')}
            <div style="font-size:12px;color:#475569;margin-top:4px">Slant = ${slantH}</div>
          </div>
          ${fbox('Total SA','sÂ² + 4Ã—Â½sl',sa+' cmÂ²','indigo')}${fbox('Volume','â…“ Ã— sÂ² Ã— h',vol2+' cmÂ³','emerald')}
          ${steps([{t:'Slant',c:'âˆš(('+sideL+'/2)Â²+'+h+'Â²)='+slantH},{t:'Base',c:sideL+'Â²='+baseArea},{t:'4 faces',c:'4Ã—Â½Ã—'+sideL+'Ã—'+slantH+'='+4*triFace},{t:'Total SA',c:baseArea+'+'+4*triFace+'='+sa}])}
        </div>
      </div>`,'geometry');
  }

  // â”€â”€â”€â”€â”€â”€ PENTAGONAL / HEXAGONAL PRISM â”€â”€â”€â”€â”€â”€
  const n=sides; // number of sides
  const sideLen=b;
  const apothem=r2(sideLen/(2*Math.tan(Math.PI/n)));
  const polyArea=r2(0.5*n*sideLen*apothem);
  const perimeter=r2(n*sideLen);
  const lateralSA=r2(perimeter*h);
  const totalSA=r2(2*polyArea+lateralSA);
  const vol=r2(polyArea*h);
  const pcx=200,pcy=200,polyR=sideLen*18/(2*Math.sin(Math.PI/n));
  const frontPts=Array.from({length:n},function(_,i){
    const ang=i*2*Math.PI/n-Math.PI/2;
    return{x:pcx+polyR*Math.cos(ang),y:pcy+polyR*Math.sin(ang)};
  });
  const backOff=d*6;
  const backPts=frontPts.map(function(p){return{x:p.x+backOff,y:p.y-backOff*.5};});
  const fPts=frontPts.map(function(p){return p.x+','+p.y;}).join(' ');
  const bPts=backPts.map(function(p){return p.x+','+p.y;}).join(' ');
  const diagram=`<svg width="400" height="280" viewBox="0 0 400 280" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    <polygon points="${bPts}" fill="rgba(99,102,241,.08)" stroke="#818cf8" stroke-width="1.5" stroke-dasharray="5,3"/>
    ${frontPts.map(function(p,i){const b2=backPts[i];return `<line x1="${p.x}" y1="${p.y}" x2="${b2.x}" y2="${b2.y}" stroke="#818cf8" stroke-width="1" opacity=".5"/>`;}).join('')}
    <polygon points="${fPts}" fill="rgba(99,102,241,.25)" stroke="#818cf8" stroke-width="2.5"/>
    <text x="${pcx}" y="${pcy+polyR+18}" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="700" font-family="Space Grotesk">side=${sideLen} Ã— ${n} faces</text>
    <text x="${pcx+polyR+backOff+10}" y="${pcy}" fill="#f43f5e" font-size="12" font-weight="700" font-family="Space Grotesk">d=${d}</text>
  </svg>`;
  return pageWrap('3D Surface Area Explorer','ğŸ“¦',n+'-sided prism (challenge shape!).',shapeButtons+`
    <div class="two-col">
      <div>${diagram}</div>
      <div class="ctrl-col">
        <div class="card">
          <div style="display:flex;gap:8px;margin-bottom:14px">
            <button class="btn btn-tab${n===5?' active':''}" onclick="S.prism.sides=5;rerender()">Pentagonal (5)</button>
            <button class="btn btn-tab${n===6?' active':''}" onclick="S.prism.sides=6;rerender()">Hexagonal (6)</button>
          </div>
          ${SI('Side length','#f59e0b',sideLen,1,10,1,'prism','base')}
          ${SI('Height (depth)','#f43f5e',d,1,15,1,'prism','depth')}
        </div>
        ${fbox('Polygon Area','Â½Ã—nÃ—sÃ—a',polyArea+' cmÂ²','amber')}
        ${fbox('Total SA','2Ã—poly + perimeterÃ—h',totalSA+' cmÂ²','indigo')}
        ${fbox('Volume','poly area Ã— depth',vol+' cmÂ³','emerald')}
        ${steps([{t:'Apothem',c:'a=s/(2tan(Ï€/n))='+apothem},{t:'Polygon area',c:'Â½Ã—'+n+'Ã—'+sideLen+'Ã—'+apothem+'='+polyArea},{t:'Perimeter',c:n+'Ã—'+sideLen+'='+perimeter},{t:'Lateral SA',c:perimeter+'Ã—'+d+'='+lateralSA},{t:'Total SA',c:'2Ã—'+polyArea+'+'+lateralSA+'='+totalSA}])}
      </div>
    </div>`,'geometry');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSFORMATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Transformation calculation (pure, no side effects) â”€â”€
function calcTransform(shape,type,tx,ty,angle,cw,rcx,rcy,sf,mirrorLine){
  const rad=angle*Math.PI/180*(cw?-1:1);
  if(type==='translate') return shape.map(function(p){return{x:r1(p.x+tx),y:r1(p.y+ty)};});
  if(type==='reflect'){
    if(mirrorLine==='x-axis') return shape.map(function(p){return{x:p.x,y:-p.y};});
    if(mirrorLine==='y-axis') return shape.map(function(p){return{x:-p.x,y:p.y};});
    if(mirrorLine==='y=x') return shape.map(function(p){return{x:p.y,y:p.x};});
    if(mirrorLine==='y=-x') return shape.map(function(p){return{x:-p.y,y:-p.x};});
    if(mirrorLine.startsWith('x=')){const a=parseFloat(mirrorLine.slice(2));return shape.map(function(p){return{x:r1(2*a-p.x),y:p.y};});}
    if(mirrorLine.startsWith('y=')){const b2=parseFloat(mirrorLine.slice(2));return shape.map(function(p){return{x:p.x,y:r1(2*b2-p.y)};});}
  }
  if(type==='rotate') return shape.map(function(p){return{x:r1((p.x-rcx)*Math.cos(rad)-(p.y-rcy)*Math.sin(rad)+rcx),y:r1((p.x-rcx)*Math.sin(rad)+(p.y-rcy)*Math.cos(rad)+rcy)};});
  if(type==='enlarge') return shape.map(function(p){return{x:r1(rcx+(p.x-rcx)*sf),y:r1(rcy+(p.y-rcy)*sf)};});
  return shape;
}

// â”€â”€ SVG polygon point string from math coords â”€â”€
function mathPtsToSVG(pts){
  return pts.map(function(p){const s=toSVG(p.x,p.y);return s.sx+','+s.sy;}).join(' ');
}

// â”€â”€ Animate transformation (ease-out, 500ms) â”€â”€
function animateTransformation(fromPts,toPts,duration){
  duration=duration||500;
  const startTime=performance.now();
  const img=document.getElementById('trans-image');
  const coordBody=document.getElementById('trans-coord-body');
  if(!img)return;
  // Create ghost shadow showing start position
  const svg=img.closest('svg');
  var ghost=document.getElementById('trans-ghost-anim');
  if(ghost) ghost.remove();
  ghost=document.createElementNS('http://www.w3.org/2000/svg','polygon');
  ghost.setAttribute('id','trans-ghost-anim');
  ghost.setAttribute('points',mathPtsToSVG(fromPts));
  ghost.setAttribute('fill','none');
  ghost.setAttribute('stroke','#94a3b8');
  ghost.setAttribute('stroke-width','1.5');
  ghost.setAttribute('stroke-dasharray','6,4');
  ghost.setAttribute('opacity','0.7');
  svg.insertBefore(ghost, img);

  function easeOut(t){return t*(2-t);}  // ease-out quad

  function frame(now){
    const raw=Math.min((now-startTime)/duration,1);
    const t=easeOut(raw);
    // Interpolate in math space
    const interp=fromPts.map(function(p,i){
      return{x:p.x+(toPts[i].x-p.x)*t, y:p.y+(toPts[i].y-p.y)*t};
    });
    img.setAttribute('points',mathPtsToSVG(interp));
    // Update coord table during animation
    if(coordBody){
      coordBody.innerHTML=toPts.map(function(p,i){
        const prog={x:r1(fromPts[i].x+(toPts[i].x-fromPts[i].x)*t),y:r1(fromPts[i].y+(toPts[i].y-fromPts[i].y)*t)};
        return '<tr><td>P'+(i+1)+'</td><td style="color:#818cf8">('+fromPts[i].x+', '+fromPts[i].y+')</td><td style="color:#34d399">('+prog.x+', '+prog.y+')</td></tr>';
      }).join('');
    }
    if(raw<1){requestAnimationFrame(frame);}
    else{
      img.setAttribute('points',mathPtsToSVG(toPts));
      if(ghost)ghost.setAttribute('opacity','0.25');
      if(coordBody){
        coordBody.innerHTML=toPts.map(function(p,i){
          return '<tr><td>P'+(i+1)+'</td><td style="color:#818cf8">('+fromPts[i].x+', '+fromPts[i].y+')</td><td style="color:#34d399">('+p.x+', '+p.y+')</td></tr>';
        }).join('');
      }
    }
  }
  requestAnimationFrame(frame);
}

// â”€â”€ Rotation arc helper for SVG â”€â”€
function rotationArcSVG(cx,cy,radius,angleDeg,cw){
  const startDeg=cw?-90:-90+angleDeg;
  const endDeg=cw?-90+angleDeg:-90;
  const s=startDeg*Math.PI/180, e=endDeg*Math.PI/180;
  const x1=cx+radius*Math.cos(s),y1=cy+radius*Math.sin(s);
  const x2=cx+radius*Math.cos(e),y2=cy+radius*Math.sin(e);
  const large=angleDeg>180?1:0;
  const sweep=cw?1:0;
  const arrowX=x2+(cw?-4:4),arrowY=y2+4;
  return `<path d="M ${x1} ${y1} A ${radius} ${radius} 0 ${large} ${sweep} ${x2} ${y2}" fill="none" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.8"/>
    <text x="${(x1+x2)/2+(cw?18:-18)}" y="${Math.min(y1,y2)-8}" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">${angleDeg}Â°</text>`;
}

function renderTransformations(){
  const{type,shape,tx,ty,angle,cw,cx:rcx,cy:rcy,sf,mirrorLine}=S.trans;
  const transformed=calcTransform(shape,type,tx,ty,angle,cw,rcx,rcy,sf,mirrorLine);
  const pts=shape.map(function(p){const s=toSVG(p.x,p.y);return s.sx+','+s.sy;}).join(' ');
  const tpts=transformed.map(function(p){const s=toSVG(p.x,p.y);return s.sx+','+s.sy;}).join(' ');
  let mirrorLineSVG='';
  if(type==='reflect'){
    if(mirrorLine==='x-axis') mirrorLineSVG=`<line x1="0" y1="${H/2}" x2="${W}" y2="${H/2}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="8" y="${H/2-6}" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">y=0</text>`;
    else if(mirrorLine==='y-axis') mirrorLineSVG=`<line x1="${W/2}" y1="0" x2="${W/2}" y2="${H}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="${W/2+6}" y="16" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">x=0</text>`;
    else if(mirrorLine==='y=x') mirrorLineSVG=`<line x1="0" y1="${H}" x2="${W}" y2="0" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="6" y="${H-6}" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">y=x</text>`;
    else if(mirrorLine==='y=-x') mirrorLineSVG=`<line x1="0" y1="0" x2="${W}" y2="${H}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="6" y="16" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">y=âˆ’x</text>`;
    else if(mirrorLine.startsWith('x=')){const a=parseFloat(mirrorLine.slice(2));const sx=toSVG(a,0).sx;mirrorLineSVG=`<line x1="${sx}" y1="0" x2="${sx}" y2="${H}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="${sx+6}" y="16" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">${mirrorLine}</text>`;}
    else if(mirrorLine.startsWith('y=')){const b2=parseFloat(mirrorLine.slice(2));const sy=toSVG(0,b2).sy;mirrorLineSVG=`<line x1="0" y1="${sy}" x2="${W}" y2="${sy}" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="8,4"/><text x="8" y="${sy-6}" fill="#fbbf24" font-size="11" font-weight="700" font-family="Space Grotesk">${mirrorLine}</text>`;}
  }
  let centreSVG='';
  if(type==='rotate'||type==='enlarge'){const sc=toSVG(rcx,rcy);centreSVG=`<circle cx="${sc.sx}" cy="${sc.sy}" r="6" fill="#fbbf24" stroke="#fff" stroke-width="2"/><text x="${sc.sx+10}" y="${sc.sy-8}" fill="#fbbf24" font-size="11" font-weight="600" font-family="Space Grotesk">C(${rcx},${rcy})</text>`;}
  // Rotation arc SVG
  let rotArcSVG='';
  if(type==='rotate'&&angle>0){
    const sc2=toSVG(rcx,rcy);
    // Draw arc from first vertex
    const p0sv=toSVG(shape[0].x,shape[0].y);
    const arcR=Math.sqrt(Math.pow(p0sv.sx-sc2.sx,2)+Math.pow(p0sv.sy-sc2.sy,2));
    rotArcSVG=rotationArcSVG(sc2.sx,sc2.sy,Math.max(20,Math.min(80,arcR*0.5)),angle,cw);
  }

  const inner=`${mirrorLineSVG}
    <!-- Object: original filled blue -->
    <polygon points="${pts}" fill="rgba(99,102,241,.15)" stroke="#818cf8" stroke-width="2" stroke-dasharray="6,4"/>
    <!-- Image: shown at transformed position normally, animate button replays the motion -->
    <polygon id="trans-image" points="${tpts}" fill="rgba(16,185,129,.2)" stroke="#34d399" stroke-width="2.5"/>
    ${rotArcSVG}
    ${centreSVG}
    <text x="8" y="18" fill="#818cf8" font-size="11" font-weight="600" font-family="Space Grotesk">â–£ Object</text>
    <text x="8" y="34" fill="#34d399" font-size="11" font-weight="600" font-family="Space Grotesk">â–£ Image</text>`;
  const mirrorOpts=[['x-axis','x-axis'],['y-axis','y-axis'],['y=x','y=x'],['y=-x','y=âˆ’x'],['x=1','x=1'],['x=2','x=2'],['x=3','x=3'],['x=4','x=4'],['y=1','y=1'],['y=2','y=2'],['y=3','y=3'],['y=4','y=4']];
  let controls='';
  if(type==='translate'){
    controls=`<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px"><div style="font-size:13px;color:#64748b">Column vector:</div><div class="col-vec"><span>${tx}</span><span>${ty}</span></div></div>`+SI('x shift (tx)','#818cf8',tx,-8,8,1,'trans','tx')+SI('y shift (ty)','#34d399',ty,-8,8,1,'trans','ty');
  } else if(type==='reflect'){
    controls=`<div style="margin-bottom:14px"><div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:10px">Mirror Line</div><div style="display:flex;flex-wrap:wrap;gap:6px">${mirrorOpts.map(function(o){return `<button class="btn btn-tab${mirrorLine===o[0]?' active':''}" onclick="S.trans.mirrorLine='${o[0]}';rerender()">${o[1]}</button>`;}).join('')}</div></div>`;
  } else if(type==='rotate'){
    controls=`<div style="display:flex;gap:8px;margin-bottom:14px"><button class="btn btn-tab${cw?' active':''}" onclick="S.trans.cw=true;rerender()">â†» Clockwise</button><button class="btn btn-tab${!cw?' active':''}" onclick="S.trans.cw=false;rerender()">â†º Anticlockwise</button></div>`+SI('Angle (Â°)','#818cf8',angle,0,360,15,'trans','angle')+SI('Centre x','#f59e0b',rcx,-5,5,1,'trans','cx')+SI('Centre y','#f43f5e',rcy,-5,5,1,'trans','cy');
  } else if(type==='enlarge'){
    controls=SI('Scale factor','#818cf8',sf,0.5,4,.5,'trans','sf')+SI('Centre x','#f59e0b',rcx,-5,5,1,'trans','cx')+SI('Centre y','#f43f5e',rcy,-5,5,1,'trans','cy');
  }
  const desc={translate:'Translate by column vector ('+tx+' / '+ty+')',reflect:'Reflect in the line '+mirrorLine,rotate:'Rotate '+angle+'Â° '+(cw?'clockwise':'anticlockwise')+' about ('+rcx+','+rcy+')',enlarge:'Enlarge by SF '+sf+', centre ('+rcx+','+rcy+')'};
  // Coordinate comparison table
  const coordTable=`<div class="info-box" style="margin-top:14px">
    <div class="info-label">Before & After Coordinates</div>
    <table class="data-tbl" style="width:100%;margin-top:8px">
      <tr><th>Point</th><th style="color:#818cf8">Object</th><th style="color:#34d399">Image</th></tr>
      <tbody id="trans-coord-body">
        ${shape.map(function(p,i){const t2=transformed[i];return '<tr><td>P'+(i+1)+'</td><td style="color:#818cf8">('+p.x+', '+p.y+')</td><td style="color:#34d399">('+t2.x+', '+t2.y+')</td></tr>';}).join('')}
      </tbody>
    </table>
  </div>`;

  return pageWrap('2D Transformations','ğŸ”„','Translate, reflect, rotate, enlarge. Hit Animate to see it move.',`
    ${tabs([['translate','Translate'],['reflect','Reflect'],['rotate','Rotate'],['enlarge','Enlarge']],type,"S.trans.type=__V__;rerender()")}
    <div class="two-col">
      <div>
        ${makeSVG(inner,'svg-trans')}
        <button class="btn-action" style="margin-top:12px;width:100%" onclick="
          var from=JSON.parse(JSON.stringify(S.trans.shape));
          var to=calcTransform(from,S.trans.type,S.trans.tx,S.trans.ty,S.trans.angle,S.trans.cw,S.trans.cx,S.trans.cy,S.trans.sf,S.trans.mirrorLine);
          var img=document.getElementById('trans-image');
          if(!img)return;
          img.setAttribute('points',mathPtsToSVG(from));
          requestAnimationFrame(function(){
            requestAnimationFrame(function(){
              animateTransformation(from,to,700);
            });
          });
        ">â–¶ Animate Transformation</button>
      </div>
      <div class="ctrl-col">
        ${controls?`<div class="card">${controls}</div>`:''}
        ${fbox('Transformation',desc[type],'Blue â†’ Green','indigo')}
        ${coordTable}
      </div>
    </div>`,'geometry');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NTH TERM â€” find rule + use it
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNth(){
  const st=S.nth;
  const rawNums=st.sequence.split(',').map(function(s){return parseFloat(s.trim());}).filter(function(n){return !isNaN(n);});
  const nums=rawNums.slice(0,8);
  let ruleHTML='',useHTML='';

  if(nums.length>=2){
    const diffs=nums.slice(1).map(function(v,i){return v-nums[i];});
    const isLinear=diffs.length>0&&diffs.every(function(d){return Math.abs(d-diffs[0])<0.001;});
    const d=diffs[0];
    const a=nums[0];
    const c=a-d; // y-intercept when n=1: a = d*1 + c => c = a - d
    const rule=isLinear?(d===0?a+'':((d===1?'':''+d)+'n '+(c>0?'+ '+c:c<0?'- '+Math.abs(c):'')).trim()):'Not linear (2nd differences needed)';
    const ruleSimple=isLinear?d+'n + '+c:null;

    // next terms
    const nextTerms=isLinear?[6,7,8].map(function(n){return a+(n-1)*d;}):[];
    const findVal=isLinear?a+(st.findN-1)*d:null;

    ruleHTML=`<div class="info-box" style="margin-bottom:14px">
      <div class="info-label">Sequence Analysis</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
        ${nums.map(function(n,i){return `<div style="background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.3);border-radius:8px;padding:6px 12px;text-align:center"><div style="font-size:10px;color:#64748b">n=${i+1}</div><div style="font-size:16px;font-weight:700;color:#a5b4fc;font-family:'JetBrains Mono',monospace">${n}</div></div>`;}).join('')}
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
        ${diffs.map(function(d2){return `<div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:4px 10px;font-size:13px;font-weight:700;color:#fcd34d;font-family:'JetBrains Mono',monospace">${d2>0?'+':''} ${d2}</div>`;}).join('')}
        <div style="font-size:12px;color:#64748b;align-self:center;margin-left:4px">differences</div>
      </div>
      ${isLinear?`<div style="font-size:12px;color:#34d399">âœ“ Common difference = ${d} â†’ Linear sequence</div>`:
        `<div style="font-size:12px;color:#f59e0b">âš  Differences not constant â†’ check 2nd differences</div>`}
    </div>`;

    useHTML=isLinear?`
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
        ${fbox('nth Term Rule','un = dn + c',ruleSimple,'indigo')}
        ${fbox('Where d = '+d,'first difference = coefficient',d+'n','amber')}
        ${fbox('Where c = '+c,'c = uâ‚ âˆ’ d',''+c,'emerald')}
        ${fbox('Check n=1','dÃ—1 + c = uâ‚',d+'Ã—1 + '+c+' = '+(d+c),'violet')}
      </div>
      <div class="card" style="margin-bottom:14px">
        <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:10px">Find any term</div>
        ${SI('Find the nth term (n =)','#818cf8',st.findN,1,100,1,'nth','findN')}
        ${fbox('u'+st.findN,''+d+'Ã—'+st.findN+' + '+c,''+findVal,'rose')}
      </div>
      ${steps([{t:'Common diff d',c:'d = uâ‚‚âˆ’uâ‚ = '+nums[1]+'âˆ’'+nums[0]+' = '+d},{t:'nth term',c:'un = '+d+'n + c'},{t:'Find c',c:'when n=1: '+d+'Ã—1 + c = '+a+' â†’ c = '+c},{t:'Rule',c:'un = '+d+'n + ('+c+')'},{t:'Find u'+st.findN,c:d+'Ã—'+st.findN+'+'+c+' = '+findVal}])}`:
      `<div class="info-box"><div class="info-label">Not a linear sequence</div><div style="font-size:13px;color:#94a3b8;line-height:1.8">Check if 2nd differences are constant for a quadratic sequence.</div></div>`;
  } else {
    ruleHTML=`<div class="info-box" style="text-align:center;padding:20px">
      <div style="font-size:28px;margin-bottom:8px">ğŸ”¢</div>
      <div style="font-size:14px;color:#f59e0b;font-weight:700;margin-bottom:6px">Need at least 2 numbers</div>
      <div style="font-size:13px;color:#64748b">Enter a sequence like: 3, 7, 11, 15, 19</div>
    </div>`;
    useHTML='';
  }

  return pageWrap('Nth Term','ğŸ”¢','Enter a sequence to find the rule and use it.',`
    <div class="two-col">
      <div>
        <div class="card" style="margin-bottom:16px">
          <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:8px">Enter sequence (comma-separated)</div>
          <input class="seq-input" type="text" value="${st.sequence}" oninput="S.nth.sequence=this.value;rerender();" placeholder="e.g. 3, 7, 11, 15, 19">
          <div style="font-size:11px;color:#475569;margin-top:6px">Enter at least 4â€“8 terms for best results</div>
        </div>
        ${ruleHTML}
      </div>
      <div class="ctrl-col">${useHTML}${quizWidget('nth')}</div>
    </div>`,'algebra');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERSECTING GRAPHS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIntersect(){
  const{m1,c1,m2,c2}=S.intersect;
  let intX=null,intY=null,parallel=false;
  if(Math.abs(m1-m2)<0.01){parallel=true;}else{intX=r2((c2-c1)/(m1-m2));intY=r2(m1*intX+c1);}

  function linePoints(m,c){
    const pts=[];
    for(let x=-RANGE;x<=RANGE;x+=0.5){const y=m*x+c;if(y>=-RANGE&&y<=RANGE)pts.push(toSVG(x,y));}
    return pts;
  }
  const p1=linePoints(m1,c1),p2=linePoints(m2,c2);
  const d1=p1.length?'M'+p1.map(function(p){return p.sx+','+p.sy;}).join('L'):'';
  const d2=p2.length?'M'+p2.map(function(p){return p.sx+','+p.sy;}).join('L'):'';
  let intDot='';
  if(intX!==null&&Math.abs(intX)<=RANGE&&Math.abs(intY)<=RANGE){
    const sv=toSVG(intX,intY);
    intDot=`<circle cx="${sv.sx}" cy="${sv.sy}" r="9" fill="#fbbf24" stroke="#fff" stroke-width="2"/>
      <text x="${sv.sx+12}" y="${sv.sy-10}" fill="#fbbf24" font-size="12" font-weight="700" font-family="Space Grotesk">(${intX},${intY})</text>`;
  }
  const inner=`
    ${d1?`<path d="${d1}" fill="none" stroke="#818cf8" stroke-width="2.5" stroke-linecap="round"/>`:''}
    ${d2?`<path d="${d2}" fill="none" stroke="#34d399" stroke-width="2.5" stroke-linecap="round"/>`:''}
    ${intDot}
    <text x="8" y="18" fill="#818cf8" font-size="11" font-weight="600" font-family="Space Grotesk">y=${m1}x+(${c1})</text>
    <text x="8" y="34" fill="#34d399" font-size="11" font-weight="600" font-family="Space Grotesk">y=${m2}x+(${c2})</text>`;
  return pageWrap('Intersecting Graphs','ğŸ”—','Adjust two lines to find their intersection point.',`
    <div class="two-col">${makeSVG(inner,'svg-int')}
      <div class="ctrl-col">
        <div class="card">
          <div style="font-size:12px;font-weight:700;color:#818cf8;margin-bottom:10px">Line 1 (blue): y = ${m1}x + (${c1})</div>
          ${SI('Gradient mâ‚','#818cf8',m1,-6,6,0.5,'intersect','m1')}
          ${SI('Intercept câ‚','#818cf8',c1,-9,9,1,'intersect','c1')}
          <div style="font-size:12px;font-weight:700;color:#34d399;margin-top:8px;margin-bottom:10px">Line 2 (green): y = ${m2}x + (${c2})</div>
          ${SI('Gradient mâ‚‚','#34d399',m2,-6,6,0.5,'intersect','m2')}
          ${SI('Intercept câ‚‚','#34d399',c2,-9,9,1,'intersect','c2')}
        </div>
        ${parallel?fbox('Intersection','Lines are parallel','No intersection','rose'):fbox('Intersection Point','mâ‚x+câ‚ = mâ‚‚x+câ‚‚','('+intX+', '+intY+')','amber')}
        ${!parallel?steps([{t:'Set equal',c:m1+'x+('+c1+') = '+m2+'x+('+c2+')'},{t:'Rearrange',c:'('+(m1-m2)+')x = '+(c2-c1)},{t:'Solve x',c:'x = '+(c2-c1)+'Ã·'+(m1-m2)+' = '+intX},{t:'Substitute',c:'y = '+m1+'Ã—'+intX+'+('+c1+') = '+intY}]):steps([{t:'Parallel lines',c:'Same gradient (mâ‚=mâ‚‚='+m1+')'},{t:'No intersection',c:'Parallel lines never meet'},{t:'Tip',c:'Change mâ‚ or mâ‚‚ to make them different'}])}
      </div>
    </div>`,'algebra');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BAR CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBarChart(){
  const{labels,values,values2,mode}=S.barchart;
  const maxVal=Math.max(...values,...(mode==='dual'?values2:[]))+2;
  const svgW=500,svgH=320,padL=50,padB=60,padT=30,padR=20;
  const chartW=svgW-padL-padR,chartH=svgH-padB-padT;
  const n=labels.length;
  const groupW=chartW/n;
  const barW=mode==='dual'?groupW*0.35:groupW*0.6;
  const scaleY=chartH/maxVal;

  let bars='',xLabels='',yGridLines='';
  const ySteps=5;
  for(let i=0;i<=ySteps;i++){
    const v=Math.round(maxVal*i/ySteps);
    const y=padT+chartH-v*scaleY;
    yGridLines+=`<line x1="${padL}" y1="${y}" x2="${padL+chartW}" y2="${y}" stroke="#1e293b" stroke-width="1"/>
      <text x="${padL-8}" y="${y+4}" text-anchor="end" fill="#475569" font-size="10" font-family="Space Grotesk">${v}</text>`;
  }

  labels.forEach(function(label,i){
    const gx=padL+i*groupW;
    const bh=values[i]*scaleY;
    const by=padT+chartH-bh;
    if(mode==='dual'){
      bars+=`<rect x="${gx+groupW*0.05}" y="${by}" width="${barW}" height="${bh}" fill="rgba(99,102,241,.7)" stroke="#818cf8" stroke-width="1" rx="3"/>
        <text x="${gx+groupW*0.05+barW/2}" y="${by-5}" text-anchor="middle" fill="#818cf8" font-size="10" font-weight="700" font-family="Space Grotesk">${values[i]}</text>`;
      const bh2=values2[i]*scaleY;
      const by2=padT+chartH-bh2;
      bars+=`<rect x="${gx+groupW*0.5}" y="${by2}" width="${barW}" height="${bh2}" fill="rgba(16,185,129,.7)" stroke="#34d399" stroke-width="1" rx="3"/>
        <text x="${gx+groupW*0.5+barW/2}" y="${by2-5}" text-anchor="middle" fill="#34d399" font-size="10" font-weight="700" font-family="Space Grotesk">${values2[i]}</text>`;
    } else {
      const hue=i*47%360;
      bars+=`<rect x="${gx+(groupW-barW)/2}" y="${by}" width="${barW}" height="${bh}" fill="rgba(99,102,241,.7)" stroke="#818cf8" stroke-width="1" rx="3"/>
        <text x="${gx+groupW/2}" y="${by-5}" text-anchor="middle" fill="#a5b4fc" font-size="10" font-weight="700" font-family="Space Grotesk">${values[i]}</text>`;
    }
    xLabels+=`<text x="${gx+groupW/2}" y="${padT+chartH+18}" text-anchor="middle" fill="#64748b" font-size="11" font-family="Space Grotesk">${label}</text>`;
  });

  const chartSVG=`<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    ${yGridLines}
    <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${padT+chartH}" stroke="#334155" stroke-width="1.5"/>
    <line x1="${padL}" y1="${padT+chartH}" x2="${padL+chartW}" y2="${padT+chartH}" stroke="#334155" stroke-width="1.5"/>
    ${bars}${xLabels}
    ${mode==='dual'?`<rect x="${padL}" y="${padT+chartH+35}" width="12" height="12" fill="rgba(99,102,241,.7)" rx="2"/><text x="${padL+16}" y="${padT+chartH+45}" fill="#818cf8" font-size="11" font-family="Space Grotesk">Set A</text>
      <rect x="${padL+70}" y="${padT+chartH+35}" width="12" height="12" fill="rgba(16,185,129,.7)" rx="2"/><text x="${padL+86}" y="${padT+chartH+45}" fill="#34d399" font-size="11" font-family="Space Grotesk">Set B</text>`:''}
  </svg>`;

  const mean=r2(values.reduce(function(a,b){return a+b;},0)/values.length);
  const total=values.reduce(function(a,b){return a+b;},0);

  return pageWrap('Bar Charts','ğŸ“Š','Adjust bar heights using sliders. Switch to dual bar chart.',`
    ${tabs([['single','Single Bar Chart'],['dual','Dual Bar Chart']],mode,"S.barchart.mode=__V__;rerender()")}
    <div style="margin-bottom:16px">${chartSVG}</div>
    <div class="two-col">
      <div class="card">
        <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:12px">Adjust Values â€” Set A (blue)</div>
        ${labels.map(function(l,i){return SI(l,'#818cf8',values[i],0,20,1,'barchart.values['+i+']','');}).join('')}
      </div>
      ${mode==='dual'?`<div class="card">
        <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:12px">Set B (green)</div>
        ${labels.map(function(l,i){return SI(l,'#34d399',values2[i],0,20,1,'barchart.values2['+i+']','');}).join('')}
      </div>`:
      `<div class="ctrl-col">
        ${fbox('Total','Sum of all bars',''+total,'indigo')}
        ${fbox('Mean','Total Ã· '+labels.length,''+mean,'emerald')}
        ${fbox('Highest',labels[values.indexOf(Math.max(...values))],Math.max(...values)+'','amber')}
        ${fbox('Lowest',labels[values.indexOf(Math.min(...values))],Math.min(...values)+'','rose')}
      </div>`}
    </div>`,'stats');
}

// Override barchart SI for arrays
const _origSI=SI;
function renderBarChart_withArraySI(){
  // We patch the S object approach for arrays
  // barchart.values[i] handled via direct onclick
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIE CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPieChart(){
  const{labels,values}=S.piechart;
  const total=values.reduce(function(a,b){return a+b;},0);
  if(total===0) return pageWrap('Pie Charts','ğŸ¥§','Adjust values to reshape pie slices.','<div class="info-box" style="text-align:center;padding:32px"><div style="font-size:28px">âš ï¸</div><div style="font-size:14px;color:#f59e0b;margin-top:8px">All values are zero â€” pie chart cannot be drawn</div></div>','stats');
  const colors=['#818cf8','#34d399','#fbbf24','#f43f5e','#a78bfa','#22d3ee'];
  const cx=180,cy=160,r=130;
  let startAngle=-Math.PI/2;
  let slices='',legend='';
  values.forEach(function(v,i){
    const angle=(v/total)*2*Math.PI;
    const endAngle=startAngle+angle;
    const midAngle=startAngle+angle/2;
    const x1=cx+r*Math.cos(startAngle),y1=cy+r*Math.sin(startAngle);
    const x2=cx+r*Math.cos(endAngle),y2=cy+r*Math.sin(endAngle);
    const large=angle>Math.PI?1:0;
    const col=colors[i%colors.length];
    const lx=cx+(r+20)*Math.cos(midAngle),ly=cy+(r+20)*Math.sin(midAngle);
    slices+=`<path d="M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z" fill="${col}" fill-opacity=".75" stroke="#060b14" stroke-width="2"/>`;
    slices+=`<text x="${lx}" y="${ly}" text-anchor="middle" fill="${col}" font-size="11" font-weight="700" font-family="Space Grotesk">${r2(v/total*100)}%</text>`;
    legend+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <div style="width:14px;height:14px;border-radius:3px;background:${col}"></div>
      <span style="font-size:13px;color:#94a3b8;flex:1">${labels[i]}</span>
      <span class="mono" style="font-size:13px;color:${col}">${v} (${r2(v/total*100)}%)</span>
    </div>`;
    startAngle=endAngle;
  });
  const pieSVG=`<svg width="360" height="320" viewBox="0 0 360 320" style="background:#060b14;border-radius:12px;display:block;max-width:100%">${slices}</svg>`;

  const degreesHTML=values.map(function(v,i){return `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #1e293b"><span style="color:#94a3b8;font-size:13px">${labels[i]}</span><span class="mono" style="color:${colors[i%colors.length]};font-size:13px">${r2(v/total*360)}Â°</span></div>`;}).join('');

  return pageWrap('Pie Charts','ğŸ¥§','Adjust values to reshape pie slices. Angles calculated automatically.',`
    <div class="two-col">
      <div>${pieSVG}</div>
      <div class="ctrl-col">
        <div class="card" style="margin-bottom:14px">
          <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:12px">Adjust Values (total = ${total})</div>
          ${values.map(function(v,i){
            const col=colors[i%colors.length];
            const id='pc_si_'+i,nid='pc_ni_'+i;
            return `<div class="si-row">
              <div class="si-label"><span style="color:${col}">${labels[i]}</span><input type="number" id="${nid}" min="1" max="100" value="${v}" style="width:60px" oninput="var val=parseInt(this.value);if(!isNaN(val)&&val>=1){S.piechart.values[${i}]=val;var sl=document.getElementById('${id}');if(sl)sl.value=val;rerender();}"></div>
              <div class="si-controls"><input type="range" id="${id}" min="1" max="100" value="${v}" oninput="S.piechart.values[${i}]=parseInt(this.value);var ni=document.getElementById('${nid}');if(ni)ni.value=this.value;" onchange="rerender()"></div>
            </div>`;
          }).join('')}
        </div>
        <div class="info-box"><div class="info-label">Legend</div>${legend}</div>
        <div class="info-box"><div class="info-label">Angles (Ã· total Ã— 360Â°)</div>${degreesHTML}</div>
        ${steps([{t:'Total',c:'Sum all values = '+total},{t:'Angle formula',c:'angle = (value Ã· total) Ã— 360Â°'},{t:'Example',c:labels[0]+': ('+values[0]+'Ã·'+total+')Ã—360 = '+r2(values[0]/total*360)+'Â°'}])}
      </div>
    </div>`,'stats');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIME SERIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTimeSeries(){
  const{points,startYear}=S.timeseries;
  const n=points.length;
  const maxV=Math.max(...points)+3,minV=Math.max(0,Math.min(...points)-3);
  const svgW=500,svgH=300,padL=50,padB=50,padT=30,padR=20;
  const chartW=svgW-padL-padR,chartH=svgH-padB-padT;
  const scaleX=chartW/(n-1),scaleY=chartH/(maxV-minV);
  const ptCoords=points.map(function(v,i){return{sx:padL+i*scaleX,sy:padT+chartH-(v-minV)*scaleY};});

  let gridLines='',xLabels='';
  for(let i=0;i<=5;i++){
    const v=minV+(maxV-minV)*i/5;
    const y=padT+chartH-(v-minV)*scaleY;
    gridLines+=`<line x1="${padL}" y1="${y}" x2="${padL+chartW}" y2="${y}" stroke="#1e293b" stroke-width="1"/>
      <text x="${padL-8}" y="${y+4}" text-anchor="end" fill="#475569" font-size="10" font-family="Space Grotesk">${Math.round(v)}</text>`;
  }
  ptCoords.forEach(function(p,i){
    xLabels+=`<text x="${p.sx}" y="${padT+chartH+18}" text-anchor="middle" fill="#475569" font-size="10" font-family="Space Grotesk">${startYear+i}</text>`;
  });

  // Trend line (linear regression)
  const sumX=ptCoords.reduce(function(s,_,i){return s+i;},0);
  const sumY=points.reduce(function(s,v){return s+v;},0);
  const sumXY=points.reduce(function(s,v,i){return s+i*v;},0);
  const sumX2=ptCoords.reduce(function(s,_,i){return s+i*i;},0);
  const denom=(n*sumX2-sumX*sumX);
  const slope=denom===0?0:(n*sumXY-sumX*sumY)/denom;
  const intercept=(sumY-slope*sumX)/n;
  const trend_y1=padT+chartH-(intercept-minV)*scaleY;
  const trend_y2=padT+chartH-((slope*(n-1)+intercept)-minV)*scaleY;

  const pathD='M'+ptCoords.map(function(p){return p.sx+','+p.sy;}).join(' L');
  const dots=ptCoords.map(function(p,i){return `<circle cx="${p.sx}" cy="${p.sy}" r="6" fill="#818cf8" stroke="#fff" stroke-width="2"/>
    <text x="${p.sx}" y="${p.sy-10}" text-anchor="middle" fill="#a5b4fc" font-size="10" font-weight="700" font-family="Space Grotesk">${points[i]}</text>`;}).join('');

  const chartSVG=`<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    ${gridLines}
    <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${padT+chartH}" stroke="#334155" stroke-width="1.5"/>
    <line x1="${padL}" y1="${padT+chartH}" x2="${padL+chartW}" y2="${padT+chartH}" stroke="#334155" stroke-width="1.5"/>
    <line x1="${padL}" y1="${trend_y1}" x2="${padL+chartW}" y2="${trend_y2}" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="6,4" opacity=".7"/>
    <path d="${pathD}" fill="none" stroke="#818cf8" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    ${dots}${xLabels}
    <text x="${padL+chartW-4}" y="${trend_y2-8}" text-anchor="end" fill="#f59e0b" font-size="10" font-weight="700" font-family="Space Grotesk">Trend</text>
  </svg>`;

  const overallTrend=slope>0.1?'ğŸ“ˆ Increasing':slope<-0.1?'ğŸ“‰ Decreasing':'â¡ Stable';

  return pageWrap('Time Series','ğŸ“ˆ','Adjust data points. Trend line shown automatically.',`
    <div style="margin-bottom:16px">${chartSVG}</div>
    <div class="two-col">
      <div class="card">
        <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:12px">Adjust Data Points</div>
        ${points.map(function(v,i){
          const id='ts_'+i,nid='tsn_'+i;
          return `<div class="si-row">
            <div class="si-label"><span style="color:#818cf8">${startYear+i}</span><input type="number" id="${nid}" min="0" max="50" value="${v}" style="width:60px" oninput="var val=parseInt(this.value);if(!isNaN(val)){S.timeseries.points[${i}]=val;var sl=document.getElementById('${id}');if(sl)sl.value=val;rerender();}"></div>
            <div class="si-controls"><input type="range" id="${id}" min="0" max="50" value="${v}" oninput="S.timeseries.points[${i}]=parseInt(this.value);var ni=document.getElementById('${nid}');if(ni)ni.value=this.value;" onchange="rerender()"></div>
          </div>`;
        }).join('')}
        ${SI('Start Year','#64748b',startYear,2000,2025,1,'timeseries','startYear')}
      </div>
      <div class="ctrl-col">
        ${fbox('Overall Trend','Slope of trend line',overallTrend,'indigo')}
        ${fbox('Trend Slope','Change per year',r2(slope)+' per year','amber')}
        ${fbox('Highest Value',''+(startYear+points.indexOf(Math.max(...points))),Math.max(...points)+'','emerald')}
        ${fbox('Lowest Value',''+(startYear+points.indexOf(Math.min(...points))),Math.min(...points)+'','rose')}
        <div class="info-box"><div class="info-label">Reading Time Series</div>
          <div style="font-size:12px;color:#94a3b8;line-height:1.8">â€¢ Look for overall trend (up/down/stable)<br>â€¢ Note any seasonal patterns<br>â€¢ Identify outliers (sudden jumps)<br>â€¢ Use trend line to predict future values</div>
        </div>
      </div>
    </div>`,'stats');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEM & LEAF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStemLeaf(){
  const raw=S.stemleaf.data;
  const allParsed=raw.split(',').map(function(s){return parseInt(s.trim());}).filter(function(n){return !isNaN(n);});
  const outOfRange=allParsed.filter(function(n){return n<0||n>99;});
  const nums=allParsed.filter(function(n){return n>=0&&n<=99;}).sort(function(a,b){return a-b;});

  const stemMap={};
  nums.forEach(function(n){
    const stem=Math.floor(n/10),leaf=n%10;
    if(!stemMap[stem])stemMap[stem]=[];
    stemMap[stem].push(leaf);
  });

  const stems=Object.keys(stemMap).map(Number).sort(function(a,b){return a-b;});
  const tableRows=stems.map(function(s){
    return `<tr>
      <td style="background:#1e293b;color:#a5b4fc;font-weight:700">${s}</td>
      <td style="background:#0f172a;color:#e2e8f0;text-align:left;padding:7px 12px;letter-spacing:4px;font-family:'JetBrains Mono',monospace">${stemMap[s].join(' ')}</td>
    </tr>`;
  }).join('');

  const mean=nums.length>0?r2(nums.reduce(function(a,b){return a+b;},0)/nums.length):'-';
  const median=nums.length>0?(nums.length%2===0?r1((nums[nums.length/2-1]+nums[nums.length/2])/2):nums[Math.floor(nums.length/2)]):'-';
  const sorted=[...nums];
  const mode=nums.length>0?(function(){let maxCnt=0,modeVal=null;nums.forEach(function(n){const cnt=nums.filter(function(x){return x===n;}).length;if(cnt>maxCnt){maxCnt=cnt;modeVal=n;}});return modeVal;})():'-';
  const range=nums.length>1?nums[nums.length-1]-nums[0]:'-';

  return pageWrap('Stem & Leaf Diagram','ğŸƒ','Enter comma-separated two-digit data. Diagram auto-sorts.',`
    <div class="two-col">
      <div>
        <div class="card" style="margin-bottom:16px">
          <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:8px">Enter data (0â€“99, comma-separated)</div>
          <input class="seq-input" type="text" value="${raw}" oninput="S.stemleaf.data=this.value;rerender();" placeholder="e.g. 12,15,23,34,45">
          ${outOfRange.length>0?`<div style="font-size:12px;color:#f59e0b;margin-top:6px">âš  Removed ${outOfRange.length} value(s) outside 0â€“99: ${outOfRange.join(', ')}</div>`:''}
          ${nums.length===0?'<div style="font-size:12px;color:#f43f5e;margin-top:6px">âš  No valid data entered. Use whole numbers 0â€“99.</div>':''}
        </div>
        <div style="background:#060b14;border-radius:12px;padding:16px;overflow-x:auto">
          <div style="font-size:12px;font-weight:700;color:#475569;margin-bottom:10px;text-transform:uppercase;letter-spacing:.08em">Stem & Leaf (n=${nums.length})</div>
          <table class="data-tbl" style="width:auto;min-width:240px">
            <tr><th>Stem (tens)</th><th style="text-align:left">Leaves (units)</th></tr>
            ${tableRows}
          </table>
          <div style="font-size:11px;color:#334155;margin-top:8px">Key: 2 | 3 = 23</div>
        </div>
      </div>
      <div class="ctrl-col">
        ${fbox('Mean','Sum Ã· Count',''+mean,'indigo')}
        ${fbox('Median','Middle value',''+median,'emerald')}
        ${fbox('Mode','Most frequent',''+mode,'amber')}
        ${fbox('Range','Max âˆ’ Min',''+range,'rose')}
        ${fbox('Count','Number of values',''+nums.length,'violet')}
        ${steps([{t:'Sort data',c:'Data sorted: '+nums.slice(0,5).join(', ')+'...'},{t:'Split into stem/leaf',c:'E.g. 35 â†’ stem=3, leaf=5'},{t:'Group by stem',c:'Stems: '+stems.join(', ')},{t:'Read mean',c:'SumÃ·n = '+mean},{t:'Read median',c:'Middle value = '+median}])}
      </div>
    </div>`,'stats');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FREQUENCY DIAGRAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFreqDiag(){
  const{classes,freqs,mode}=S.freqdiag;
  const maxF=Math.max(...freqs)+1;
  const svgW=500,svgH=300,padL=50,padB=60,padT=30,padR=20;
  const chartW=svgW-padL-padR,chartH=svgH-padB-padT;
  const n=classes.length;
  const barW=chartW/n;
  const scaleY=chartH/maxF;

  let bars='',xLabels='',gridLines='';
  for(let i=0;i<=5;i++){
    const v=Math.round(maxF*i/5);
    const y=padT+chartH-v*scaleY;
    gridLines+=`<line x1="${padL}" y1="${y}" x2="${padL+chartW}" y2="${y}" stroke="#1e293b" stroke-width="1"/>
      <text x="${padL-8}" y="${y+4}" text-anchor="end" fill="#475569" font-size="10" font-family="Space Grotesk">${v}</text>`;
  }
  freqs.forEach(function(f,i){
    const x=padL+i*barW;
    const bh=f*scaleY;
    const by=padT+chartH-bh;
    const col=mode==='histogram'?'rgba(99,102,241,.7)':'rgba(245,158,11,.7)';
    const strokeCol=mode==='histogram'?'#818cf8':'#f59e0b';
    const gap=mode==='frequency'?barW*0.15:0;
    bars+=`<rect x="${x+gap/2}" y="${by}" width="${barW-gap}" height="${bh}" fill="${col}" stroke="${strokeCol}" stroke-width="1.5" rx="${mode==='frequency'?3:0}"/>
      <text x="${x+barW/2}" y="${by-5}" text-anchor="middle" fill="${strokeCol}" font-size="10" font-weight="700" font-family="Space Grotesk">${f}</text>`;
    xLabels+=`<text x="${x+barW/2}" y="${padT+chartH+18}" text-anchor="middle" fill="#475569" font-size="10" font-family="Space Grotesk" transform="rotate(-20,${x+barW/2},${padT+chartH+18})">${classes[i]}</text>`;
  });

  const total=freqs.reduce(function(a,b){return a+b;},0);
  const chartSVG=`<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    ${gridLines}
    <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${padT+chartH}" stroke="#334155" stroke-width="1.5"/>
    <line x1="${padL}" y1="${padT+chartH}" x2="${padL+chartW}" y2="${padT+chartH}" stroke="#334155" stroke-width="1.5"/>
    ${bars}${xLabels}
    <text x="${padL+chartW/2}" y="${svgH}" text-anchor="middle" fill="#475569" font-size="11" font-family="Space Grotesk">Class intervals</text>
    <text x="16" y="${padT+chartH/2}" text-anchor="middle" fill="#475569" font-size="11" font-family="Space Grotesk" transform="rotate(-90,16,${padT+chartH/2})">Frequency</text>
  </svg>`;

  return pageWrap('Frequency Diagram','ğŸ“¶','Histogram (continuous data) or frequency bar chart.',`
    ${tabs([['histogram','Histogram'],['frequency','Frequency Chart']],mode,"S.freqdiag.mode=__V__;rerender()")}
    <div style="margin-bottom:16px">${chartSVG}</div>
    <div class="two-col">
      <div class="card">
        <div style="font-size:13px;font-weight:600;color:#94a3b8;margin-bottom:12px">Adjust Frequencies</div>
        ${freqs.map(function(f,i){
          const id='fd_'+i,nid='fdn_'+i;
          return `<div class="si-row">
            <div class="si-label"><span style="color:${mode==='histogram'?'#818cf8':'#f59e0b'}">${classes[i]}</span><input type="number" id="${nid}" min="0" max="20" value="${f}" style="width:60px" oninput="var val=parseInt(this.value);if(!isNaN(val)&&val>=0){S.freqdiag.freqs[${i}]=val;var sl=document.getElementById('${id}');if(sl)sl.value=val;rerender();}"></div>
            <div class="si-controls"><input type="range" id="${id}" min="0" max="20" value="${f}" oninput="S.freqdiag.freqs[${i}]=parseInt(this.value);var ni=document.getElementById('${nid}');if(ni)ni.value=this.value;" onchange="rerender()"></div>
          </div>`;
        }).join('')}
      </div>
      <div class="ctrl-col">
        ${fbox('Total frequency','Sum of all bars',''+total,'indigo')}
        ${fbox('Modal class','Highest frequency bar',classes[freqs.indexOf(Math.max(...freqs))],'amber')}
        <div class="info-box"><div class="info-label">${mode==='histogram'?'Histogram Rules':'Frequency Chart Rules'}</div>
          <div style="font-size:12px;color:#94a3b8;line-height:1.8">
            ${mode==='histogram'?'â€¢ Bars touch (no gaps) â€” continuous data<br>â€¢ Width of bar represents class interval<br>â€¢ Area = frequency (if equal widths)<br>â€¢ x-axis: continuous scale':
            'â€¢ Bars can have gaps â€” discrete data<br>â€¢ Height = frequency<br>â€¢ Each bar represents one category<br>â€¢ Order can be changed'}
          </div>
        </div>
        ${steps([{t:'Read axes',c:'x-axis = classes, y-axis = frequency'},{t:'Identify modal class',c:'Tallest bar = '+classes[freqs.indexOf(Math.max(...freqs))]},{t:'Find total',c:'Sum all frequencies = '+total}])}
      </div>
    </div>`,'stats');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE DRAG UPDATERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dragUpdateGradient(id,sx,sy,mx,my){
  if(id==='grad-A')S.grad.A={x:mx,y:my};else S.grad.B={x:mx,y:my};
  moveDot(id,sx,sy);
  var g=document.querySelector('[data-id="'+id+'"]');
  if(g){var t=g.querySelector('text');if(t)t.textContent=(id==='grad-A'?'A':'B')+'('+mx+','+my+')';}
  var A=S.grad.A,B=S.grad.B;
  var svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y);
  var lines=document.querySelectorAll('#svg-grad line');
  if(lines.length>=4){
    lines[1].setAttribute('x1',svA.sx);lines[1].setAttribute('y1',svA.sy);lines[1].setAttribute('x2',svB.sx);lines[1].setAttribute('y2',svB.sy);
    lines[2].setAttribute('x1',svA.sx);lines[2].setAttribute('y1',svA.sy);lines[2].setAttribute('x2',svB.sx);lines[2].setAttribute('y2',svA.sy);
    lines[3].setAttribute('x1',svB.sx);lines[3].setAttribute('y1',svA.sy);lines[3].setAttribute('x2',svB.sx);lines[3].setAttribute('y2',svB.sy);
  }
}
function dragUpdateMidpoint(id,sx,sy,mx,my){
  if(id==='mid-A')S.mid.A={x:mx,y:my};else S.mid.B={x:mx,y:my};
  moveDot(id,sx,sy);
  var g=document.querySelector('[data-id="'+id+'"]');
  if(g){var t=g.querySelector('text');if(t)t.textContent=(id==='mid-A'?'A':'B')+'('+mx+','+my+')';}
  var A=S.mid.A,B=S.mid.B;
  var svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y);
  var mx2=r1((A.x+B.x)/2),my2=r1((A.y+B.y)/2);
  var svM=toSVG(mx2,my2);
  var line=document.querySelector('#svg-mid line');
  if(line){line.setAttribute('x1',svA.sx);line.setAttribute('y1',svA.sy);line.setAttribute('x2',svB.sx);line.setAttribute('y2',svB.sy);}
  var allCircles=document.querySelectorAll('#svg-mid circle');
  allCircles.forEach(function(c){if(!c.closest('.dp')){c.setAttribute('cx',svM.sx);c.setAttribute('cy',svM.sy);}});
  var midText=document.querySelector('#svg-mid > text');
  if(midText){midText.setAttribute('x',svM.sx+14);midText.setAttribute('y',svM.sy-10);midText.textContent='M('+mx2+','+my2+')';}
}
function dragUpdateBearings(id,sx,sy,mx,my){
  var m=S.bear.mode;
  if(id==='bear-from'){if(m==='forward')S.bear.A={x:mx,y:my};else S.bear.B={x:mx,y:my};}
  else{if(m==='forward')S.bear.B={x:mx,y:my};else S.bear.A={x:mx,y:my};}
  moveDot(id,sx,sy);
}
function dragUpdateArea(id,sx,sy,mx,my){
  var s=S.area;
  if(s.shape==='triangle'){
    if(id==='area-tA')s.triA={x:mx,y:my};else if(id==='area-tB')s.triB={x:mx,y:my};else s.triC={x:mx,y:my};
    moveDot(id,sx,sy);
    var A=s.triA,B=s.triB,C=s.triC;
    var svA=toSVG(A.x,A.y),svB=toSVG(B.x,B.y),svC=toSVG(C.x,C.y);
    var poly=document.querySelector('#svg-area polygon');
    if(poly)poly.setAttribute('points',svA.sx+','+svA.sy+' '+svB.sx+','+svB.sy+' '+svC.sx+','+svC.sy);
  } else {
    if(id==='area-rA')s.rectA={x:mx,y:my};else s.rectB={x:mx,y:my};
    moveDot(id,sx,sy);
    var rA=s.rectA,rB=s.rectB;
    var rsvA=toSVG(rA.x,rA.y),rsvB=toSVG(rB.x,rB.y);
    var rect=document.querySelector('#svg-area rect');
    if(rect){var minX=Math.min(rsvA.sx,rsvB.sx),minY=Math.min(rsvA.sy,rsvB.sy);rect.setAttribute('x',minX);rect.setAttribute('y',minY);rect.setAttribute('width',Math.abs(rsvB.sx-rsvA.sx));rect.setAttribute('height',Math.abs(rsvB.sy-rsvA.sy));}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PAGE_MAP={
  dashboard:renderDashboard,
  gradient:renderGradient,midpoint:renderMidpoint,bearings:renderBearings,
  area:renderArea,prisms:renderPrisms,linear:renderLinear,units:renderUnits,
  parallelogram:renderParallelogram,transformations:renderTransformations,
  circles:renderCircles,
  percentages:renderPercentages,ratio:renderRatio,
  nth:renderNth,intersect:renderIntersect,
  barchart:renderBarChart,piechart:renderPieChart,
  timeseries:renderTimeSeries,stemleaf:renderStemLeaf,freqdiag:renderFreqDiag,
  probability:renderProbability,
  integers:renderIntegers,
  fractions:renderFractions,
  angles:renderAngles,
};

function navigateCat(key){
  if(_dragCleanup){_dragCleanup();_dragCleanup=null;}
  CATEGORY=key;PAGE='__cat__';window.scrollTo(0,0);rerender();
}
function navigatePage(page,cat){
  if(_dragCleanup){_dragCleanup();_dragCleanup=null;}
  CATEGORY=cat||CATEGORY;PAGE=page;window.scrollTo(0,0);rerender();
}
function navigate(page){
  if(_dragCleanup){_dragCleanup();_dragCleanup=null;}
  if(page==='dashboard'){CATEGORY=null;PAGE='dashboard';}
  else PAGE=page;
  window.scrollTo(0,0);rerender();
}

function rerender(){
  var html;
  if(PAGE==='dashboard') html=renderDashboard();
  else if(PAGE==='__cat__') html=renderCategory(CATEGORY);
  else html=(PAGE_MAP[PAGE]||renderDashboard)();
  document.getElementById('app').innerHTML=html;
  requestAnimationFrame(function(){
    if(PAGE==='gradient') attachDrag('svg-grad',dragUpdateGradient,rerender);
    else if(PAGE==='midpoint') attachDrag('svg-mid',dragUpdateMidpoint,rerender);
    else if(PAGE==='bearings') attachDrag('svg-bear',dragUpdateBearings,rerender);
    else if(PAGE==='area') attachDrag('svg-area',dragUpdateArea,rerender);
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTEGERS & NEGATIVE NUMBERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIntegers(){
  const{start,change,mode,animStep}=S.integers;
  const end=mode==='add'?start+change:start-change;
  const actualChange=mode==='add'?change:-change;

  // Number line SVG
  const svgW=500,svgH=180,NL_MIN=-20,NL_MAX=20;
  const padL=30,padR=30,lineY=100;
  const lineW=svgW-padL-padR;
  const unitW=lineW/(NL_MAX-NL_MIN);

  function nx(v){return padL+(v-NL_MIN)*unitW;}

  // Ticks and labels
  let ticks='';
  for(let i=NL_MIN;i<=NL_MAX;i++){
    const x=nx(i);
    const major=(i%5===0);
    ticks+=`<line x1="${x}" y1="${lineY-(major?10:5)}" x2="${x}" y2="${lineY+(major?10:5)}" stroke="${i===0?'#475569':'#1e293b'}" stroke-width="${major?1.5:1}"/>`;
    if(major) ticks+=`<text x="${x}" y="${lineY+26}" text-anchor="middle" fill="${i===0?'#64748b':'#334155'}" font-size="11" font-family="Space Grotesk">${i}</text>`;
  }

  // Animate arrow â€” how far along are we?
  const steps=Math.abs(actualChange);
  const currentPos=steps>0?start+Math.sign(actualChange)*Math.min(animStep,steps):start;
  const arrowEnd=nx(currentPos);
  const arrowStart=nx(start);
  const arrowDir=actualChange>=0?1:-1;

  // Curved arc above/below the line
  const arcH=40;
  const ax1=nx(start),ax2=nx(end);
  const midX=(ax1+ax2)/2;
  const arcY=lineY-(actualChange>=0?arcH:-arcH/2);
  const arcPath=`M ${ax1} ${lineY} Q ${midX} ${arcY} ${ax2} ${lineY}`;

  // Start dot, end dot, current pos dot
  const startDot=`<circle cx="${nx(start)}" cy="${lineY}" r="10" fill="#818cf8" stroke="#fff" stroke-width="2"/>
    <text x="${nx(start)}" y="${lineY-18}" text-anchor="middle" fill="#818cf8" font-size="12" font-weight="700" font-family="Space Grotesk">${start}</text>`;
  const endDot=`<circle cx="${nx(end)}" cy="${lineY}" r="10" fill="#34d399" stroke="#fff" stroke-width="2"/>
    <text x="${nx(end)}" y="${lineY+38}" text-anchor="middle" fill="#34d399" font-size="13" font-weight="700" font-family="Space Grotesk">${end}</text>`;
  const curDot=animStep>0&&animStep<steps?`<circle cx="${nx(currentPos)}" cy="${lineY}" r="7" fill="#fbbf24" stroke="#fff" stroke-width="2"/>`:'' ;

  const nlSVG=`<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="background:#060b14;border-radius:12px;display:block;max-width:100%">
    <!-- Main number line -->
    <line x1="${padL}" y1="${lineY}" x2="${svgW-padR}" y2="${lineY}" stroke="#334155" stroke-width="2"/>
    <!-- Arrows at ends -->
    <polygon points="${svgW-padR},${lineY} ${svgW-padR-8},${lineY-4} ${svgW-padR-8},${lineY+4}" fill="#475569"/>
    ${ticks}
    <!-- Arc showing movement -->
    <path d="${arcPath}" fill="none" stroke="${actualChange>=0?'#818cf8':'#f43f5e'}" stroke-width="2.5" stroke-dasharray="${animStep===0?'6,4':'none'}" opacity="${animStep===0?'0.5':'1'}"/>
    <!-- Arrowhead at end of arc -->
    <polygon points="${nx(end)},${lineY} ${nx(end)-(arrowDir*6)},${lineY-5} ${nx(end)-(arrowDir*6)},${lineY+5}" fill="${actualChange>=0?'#818cf8':'#f43f5e'}"/>
    ${startDot}${endDot}${curDot}
    <!-- Zero marker -->
    <line x1="${nx(0)}" y1="${lineY-14}" x2="${nx(0)}" y2="${lineY+14}" stroke="#475569" stroke-width="2"/>
  </svg>`;

  // Direction words
  const dirWord=actualChange>=0?'â†— Move RIGHT (positive)':'â†™ Move LEFT (negative)';
  const dirColor=actualChange>=0?'#34d399':'#f43f5e';

  // Visual counter boxes (one per step)
  const stepBoxes=Array.from({length:Math.abs(actualChange)},function(_,i){
    const pos=start+Math.sign(actualChange)*(i+1);
    const done=animStep>i;
    return `<div style="display:inline-flex;flex-direction:column;align-items:center;gap:3px;margin:3px">
      <div style="width:36px;height:36px;border-radius:8px;background:${done?(actualChange>=0?'rgba(99,102,241,.4)':'rgba(244,63,94,.4)'):'rgba(30,41,59,.6)'};border:1px solid ${done?(actualChange>=0?'#818cf8':'#f43f5e'):'#1e293b'};display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:${done?'#e2e8f0':'#334155'};font-family:'JetBrains Mono',monospace;transition:all .3s">${Math.sign(actualChange)>=0?'+':'-'}1</div>
      <div style="font-size:10px;color:${done?'#64748b':'#1e293b'};font-family:'JetBrains Mono',monospace">${pos}</div>
    </div>`;
  }).join('');

  return pageWrap('Integers & Negative Numbers','â–','See addition and subtraction on a number line. Watch it step by step.',`
    <div class="two-col">
      <div>
        <div style="margin-bottom:12px">${nlSVG}</div>
        <div style="background:rgba(15,23,42,.6);border:1px solid rgba(99,102,241,.1);border-radius:12px;padding:14px;margin-bottom:12px">
          <div style="font-size:12px;font-weight:700;color:#475569;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px">Step-by-step counter</div>
          <div style="display:flex;flex-wrap:wrap;gap:2px;min-height:50px">${stepBoxes||'<div style="color:#334155;font-size:13px">Adjust the sliders to see steps</div>'}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-action" onclick="
            S.integers.animStep=0;
            var iv=setInterval(function(){
              if(S.integers.animStep>=Math.abs(S.integers.mode==='add'?S.integers.change:-S.integers.change)){clearInterval(iv);return;}
              S.integers.animStep++;rerender();
            },400);
          ">â–¶ Animate Steps</button>
          <button class="btn-action" onclick="S.integers.animStep=Math.abs(S.integers.change);rerender()">â­ Show Answer</button>
          <button class="btn-action" onclick="S.integers.animStep=0;rerender()">â†º Reset</button>
        </div>
      </div>
      <div class="ctrl-col">
        <div class="card">
          <div style="display:flex;gap:8px;margin-bottom:16px">
            <button class="btn btn-tab${mode==='add'?' active':''}" onclick="S.integers.mode='add';S.integers.animStep=0;rerender()">â• Addition</button>
            <button class="btn btn-tab${mode==='sub'?' active':''}" onclick="S.integers.mode='sub';S.integers.animStep=0;rerender()">â– Subtraction</button>
          </div>
          ${SI('Start number','#818cf8',start,-15,15,1,'integers','start')}
          ${SI((mode==='add'?'Add':'Subtract')+' (change)','#f59e0b',change,0,15,1,'integers','change')}
        </div>
        ${fbox('Calculation',start+(mode==='add'?' + ':' âˆ’ ')+change+' =',''+end,actualChange>=0?'emerald':'rose')}
        <div style="background:${actualChange>=0?'rgba(16,185,129,.1)':'rgba(244,63,94,.1)'};border:1px solid ${actualChange>=0?'rgba(16,185,129,.3)':'rgba(244,63,94,.3)'};border-radius:12px;padding:14px">
          <div style="font-size:13px;font-weight:700;color:${dirColor};margin-bottom:8px">${dirWord}</div>
          <div style="font-size:12px;color:#94a3b8;line-height:1.8">
            ${actualChange>=0?
              'Positive numbers â†’ move <strong style="color:#34d399">right</strong> on number line<br>Starting at '+start+', move '+Math.abs(actualChange)+' steps right â†’ land on '+end:
              'Subtracting â†’ move <strong style="color:#f43f5e">left</strong> on number line<br>Starting at '+start+', move '+Math.abs(actualChange)+' steps left â†’ land on '+end}
          </div>
        </div>
        <div class="info-box">
          <div class="info-label">Key Rules</div>
          <div style="font-size:12px;color:#94a3b8;line-height:1.9">
            + positive â†’ move <strong style="color:#34d399">right â¡</strong><br>
            âˆ’ negative â†’ move <strong style="color:#f43f5e">left â¬…</strong><br>
            + (âˆ’n) = âˆ’ n &nbsp;(adding neg = subtract)<br>
            âˆ’ (âˆ’n) = + n &nbsp;(subtracting neg = add)<br>
            |n| = absolute value = distance from 0
          </div>
        </div>
        ${steps([
          {t:'Start position',c:'Place marker at '+start+' on number line'},
          {t:'Direction',c:actualChange>=0?'Positive change â†’ move right':'Negative change â†’ move left'},
          {t:'Count steps',c:'Move '+Math.abs(actualChange)+' steps '+( actualChange>=0?'right':'left')},
          {t:'Answer',c:'Land on '+end},
        ])}
        ${quizWidget('integers')}
      </div>
    </div>`,'algebra');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FRACTIONS VISUAL MODEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFractions(){
  const st=S.fractions;
  const{modeTab,num1,den1,num2,den2,eqNum,eqDen,eqMult,cols,rows}=st;

  // â”€â”€ Fraction bar SVG helper â”€â”€
  function fracBar(num,den,color,w,h,label){
    if(den<=0)return '';
    const cellW=w/den;
    let cells='';
    for(let i=0;i<den;i++){
      const filled=i<num;
      cells+=`<rect x="${i*cellW+1}" y="1" width="${cellW-2}" height="${h-2}" fill="${filled?color:'rgba(30,41,59,.6)'}" stroke="#1e293b" stroke-width="1" rx="3"/>`;
      if(den<=20) cells+=`<text x="${i*cellW+cellW/2}" y="${h/2+4}" text-anchor="middle" fill="${filled?'#fff':'#334155'}" font-size="${Math.max(8,Math.min(13,cellW*0.5))}" font-weight="700" font-family="JetBrains Mono">${i<num?'â–ª':''}</text>`;
    }
    return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="display:block;margin-bottom:6px">
      <rect width="${w}" height="${h}" fill="rgba(15,23,42,.6)" rx="6"/>
      ${cells}
      ${label?`<text x="${w+8}" y="${h/2+4}" fill="#94a3b8" font-size="13" font-weight="600" font-family="Space Grotesk">${label}</text>`:''}
    </svg>`;
  }

  // â”€â”€ Grid model for multiplication â”€â”€
  function fracGrid(n1,d1,n2,d2,cols2,rows2){
    const cW=Math.min(300/cols2,40),rH=Math.min(200/rows2,40);
    const gW=cols2*cW,gH=rows2*rH;
    let cells='';
    for(let r=0;r<rows2;r++){
      for(let c=0;c<cols2;c++){
        const inFrac1=c<n1;  // columns represent first fraction
        const inFrac2=r<n2;  // rows represent second fraction
        const fill=inFrac1&&inFrac2?'rgba(99,102,241,.8)':inFrac1?'rgba(99,102,241,.2)':inFrac2?'rgba(16,185,129,.2)':'rgba(15,23,42,.4)';
        cells+=`<rect x="${c*cW}" y="${r*rH}" width="${cW}" height="${rH}" fill="${fill}" stroke="#1e293b" stroke-width="0.5" rx="2"/>`;
      }
    }
    // Shading lines
    const resNum=n1*n2,resDen=d1*d2;
    return `<div>
      <svg width="${gW}" height="${gH}" viewBox="0 0 ${gW} ${gH}" style="display:block;border-radius:8px;margin-bottom:8px">${cells}</svg>
      <div style="font-size:12px;color:#94a3b8">
        <span style="color:#818cf8">â–ˆ</span> = ${n1}/${d1} &nbsp;
        <span style="color:#34d399">â–ˆ</span> = ${n2}/${d2} &nbsp;
        <span style="color:#6366f1">â–ˆ</span> = overlap = ${resNum}/${resDen}${resNum!==0&&gcd(resNum,resDen)>1?' = '+(resNum/gcd(resNum,resDen))+'/'+(resDen/gcd(resNum,resDen)):''}
      </div>
    </div>`;
  }

  let mainContent='';
  let rightPanel='';

  if(modeTab==='equivalent'){
    const eqNum2=eqNum*eqMult, eqDen2=eqDen*eqMult;
    const pct=r2(eqNum/eqDen*100);
    mainContent=`
      <div class="info-box" style="margin-bottom:14px">
        <div class="info-label">Original Fraction</div>
        <div style="margin:10px 0">${fracBar(eqNum,eqDen,'rgba(99,102,241,.8)',320,44,eqNum+'/'+eqDen+' = '+pct+'%')}</div>
        <div class="info-label" style="margin-top:14px">Equivalent (Ã—${eqMult})</div>
        <div style="margin:10px 0">${fracBar(eqNum2,eqDen2,'rgba(99,102,241,.5)',320,44,eqNum2+'/'+eqDen2+' = '+pct+'%')}</div>
        <div style="font-size:12px;color:#64748b;margin-top:8px">Both bars are the same length â€” same value, different parts</div>
      </div>`;
    rightPanel=`
      <div class="card">
        ${SI('Numerator','#818cf8',eqNum,1,10,1,'fractions','eqNum')}
        ${SI('Denominator','#f59e0b',eqDen,1,12,1,'fractions','eqDen')}
        ${SI('Multiply by (Ã—)','#34d399',eqMult,2,8,1,'fractions','eqMult')}
      </div>
      ${fbox('Original',''+eqNum+'/'+eqDen,''+r2(eqNum/eqDen),'indigo')}
      ${fbox('Equivalent','Ã—'+eqMult+' top and bottom',eqNum2+'/'+eqDen2,'emerald')}
      ${fbox('As decimal','Ã· numerator by denominator',''+r2(eqNum/eqDen),'amber')}
      ${fbox('As percentage','decimal Ã— 100',pct+'%','violet')}
      ${steps([
        {t:'Original fraction',c:eqNum+'/'+eqDen},
        {t:'Multiply both',c:'numerator: '+eqNum+'Ã—'+eqMult+'='+eqNum2+', denominator: '+eqDen+'Ã—'+eqMult+'='+eqDen2},
        {t:'Equivalent fraction',c:eqNum2+'/'+eqDen2+' (same value as '+eqNum+'/'+eqDen+')'},
        {t:'Decimal',c:eqNum+' Ã· '+eqDen+' = '+r2(eqNum/eqDen)},
      ])}`;

  } else if(modeTab==='compare'){
    // Compare two fractions side by side
    const lcd=den1*den2/gcd(den1,den2);
    const eq1=num1*(lcd/den1), eq2=num2*(lcd/den2);
    const rel=eq1>eq2?'>':eq1<eq2?'<':'=';
    const dec1=r2(num1/den1), dec2=r2(num2/den2);
    mainContent=`
      <div class="info-box" style="margin-bottom:14px">
        <div class="info-label">Fraction A</div>
        <div style="margin:10px 0">${fracBar(num1,den1,'rgba(99,102,241,.8)',320,44,num1+'/'+den1+' = '+dec1)}</div>
        <div class="info-label" style="margin-top:12px">Fraction B</div>
        <div style="margin:10px 0">${fracBar(num2,den2,'rgba(16,185,129,.8)',320,44,num2+'/'+den2+' = '+dec2)}</div>
        <div style="margin-top:12px;font-size:16px;font-weight:700;color:#fcd34d;text-align:center">${num1}/${den1} ${rel} ${num2}/${den2}</div>
      </div>`;
    rightPanel=`
      <div class="card">
        <div style="font-size:12px;font-weight:700;color:#818cf8;margin-bottom:8px">Fraction A (purple)</div>
        ${SI('Numerator A','#818cf8',num1,1,12,1,'fractions','num1')}
        ${SI('Denominator A','#818cf8',den1,1,12,1,'fractions','den1')}
        <div style="font-size:12px;font-weight:700;color:#34d399;margin-top:10px;margin-bottom:8px">Fraction B (green)</div>
        ${SI('Numerator B','#34d399',num2,1,12,1,'fractions','num2')}
        ${SI('Denominator B','#34d399',den2,1,12,1,'fractions','den2')}
      </div>
      ${fbox('LCD (common denom)','LCM of '+den1+' and '+den2,''+lcd,'amber')}
      ${fbox('Comparison',num1+'/'+den1+' vs '+num2+'/'+den2,num1+'/'+den1+' '+rel+' '+num2+'/'+den2,'indigo')}
      ${steps([
        {t:'Find LCD',c:'LCM('+den1+','+den2+') = '+lcd},
        {t:'Convert A',c:num1+'/'+den1+' = '+eq1+'/'+lcd},
        {t:'Convert B',c:num2+'/'+den2+' = '+eq2+'/'+lcd},
        {t:'Compare',c:eq1+' '+rel+' '+eq2+' so '+num1+'/'+den1+' '+rel+' '+num2+'/'+den2},
      ])}`;

  } else if(modeTab==='multiply'){
    const resNum=num1*num2, resDen=den1*den2;
    const g=gcd(resNum,resDen);
    const simpNum=resNum/g, simpDen=resDen/g;
    mainContent=`
      <div class="info-box" style="margin-bottom:14px">
        <div class="info-label">Grid Model â€” ${num1}/${den1} Ã— ${num2}/${den2}</div>
        <div style="margin:12px 0">${fracGrid(num1,den1,num2,den2,den1,den2)}</div>
        <div style="font-size:12px;color:#64748b">Columns = ${den1} parts, Rows = ${den2} parts. Purple overlap = answer.</div>
      </div>`;
    rightPanel=`
      <div class="card">
        <div style="font-size:12px;font-weight:700;color:#818cf8;margin-bottom:8px">First fraction</div>
        ${SI('Numerator','#818cf8',num1,1,8,1,'fractions','num1')}
        ${SI('Denominator','#818cf8',den1,1,8,1,'fractions','den1')}
        <div style="font-size:12px;font-weight:700;color:#34d399;margin-top:10px;margin-bottom:8px">Second fraction</div>
        ${SI('Numerator','#34d399',num2,1,8,1,'fractions','num2')}
        ${SI('Denominator','#34d399',den2,1,8,1,'fractions','den2')}
      </div>
      ${fbox('Multiply','Multiply tops, multiply bottoms',num1+'Ã—'+num2+' / '+den1+'Ã—'+den2,'indigo')}
      ${fbox('Result',''+resNum+'/'+resDen,g>1?'= '+simpNum+'/'+simpDen:'Already simplified','emerald')}
      ${g>1?fbox('Simplified','Ã· both by HCF '+g,simpNum+'/'+simpDen,'amber'):''}
      ${steps([
        {t:'Multiply numerators',c:num1+' Ã— '+num2+' = '+resNum},
        {t:'Multiply denominators',c:den1+' Ã— '+den2+' = '+resDen},
        {t:'Result',c:resNum+'/'+resDen},
        {t:'Simplify (HCF='+g+')',c:g>1?resNum+'/'+g+' and '+resDen+'/'+g+' â†’ '+simpNum+'/'+simpDen:'Already in simplest form'},
      ])}`;
  }

  return pageWrap('Fractions Visual Model','Â½','See fractions as bars and grids. Compare, find equivalents, multiply.',`
    ${tabs([['equivalent','Equivalent'],['compare','Compare'],['multiply','Multiply']],modeTab,"S.fractions.modeTab=__V__;rerender()")}
    <div class="two-col">
      <div>${mainContent}</div>
      <div class="ctrl-col">${rightPanel}${quizWidget('fractions')}</div>
    </div>`,'algebra');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANGLE REASONING BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAngles(){
  const{mode,angleA,showReasons,quizMode,quizAnswer,quizResult,quizTarget}=S.angles;

  // â”€â”€ Helper: draw arc â”€â”€
  function arc(cx,cy,r,startDeg,endDeg,color,dashed){
    const s=startDeg*Math.PI/180, e=endDeg*Math.PI/180;
    const x1=cx+r*Math.cos(s),y1=cy+r*Math.sin(s);
    const x2=cx+r*Math.cos(e),y2=cy+r*Math.sin(e);
    const large=Math.abs(endDeg-startDeg)>180?1:0;
    return `<path d="M ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2}" fill="none" stroke="${color}" stroke-width="1.5" ${dashed?'stroke-dasharray="4,3"':''}/>`;
  }
  function label(x,y,text,color,size){
    return `<text x="${x}" y="${y}" text-anchor="middle" fill="${color||'#e2e8f0'}" font-size="${size||13}" font-weight="700" font-family="Space Grotesk">${text}</text>`;
  }
  function angleLabel(cx,cy,r,startDeg,endDeg,text,color){
    const midDeg=(startDeg+endDeg)/2;
    const mx=cx+r*Math.cos(midDeg*Math.PI/180);
    const my=cy+r*Math.sin(midDeg*Math.PI/180);
    return arc(cx,cy,r,startDeg,endDeg,color||'#fbbf24')+label(mx,my,text,color||'#fbbf24',11);
  }

  const W2=420,H2=320,svgStyle=`background:#060b14;border-radius:12px;display:block;max-width:100%`;

  let diagram='', facts=[], stepsArr=[];

  // â”€â”€ MODE: Angles on a straight line â”€â”€
  if(mode==='straight'){
    const b=180-angleA;
    const cx=W2/2, cy=H2*0.6;
    diagram=`<svg width="${W2}" height="${H2}" viewBox="0 0 ${W2} ${H2}" style="${svgStyle}">
      <line x1="40" y1="${cy}" x2="${W2-40}" y2="${cy}" stroke="#334155" stroke-width="2.5"/>
      <line x1="${cx}" y1="${cy}" x2="${cx+130*Math.cos((180-angleA)*Math.PI/180)}" y2="${cy-130*Math.sin((180-angleA)*Math.PI/180)}" stroke="#818cf8" stroke-width="2.5"/>
      ${angleLabel(cx,cy,55,180,180-angleA,'a = '+angleA+'Â°','#818cf8')}
      ${angleLabel(cx,cy,55,180-angleA,0,'b = '+b+'Â°','#34d399')}
      ${label(cx,cy+30,'Angles on a straight line = 180Â°','#475569',11)}
    </svg>`;
    facts=[{label:'a',val:angleA,color:'#818cf8',reason:'Given'},{label:'b',val:b,color:'#34d399',reason:'180Â° âˆ’ '+angleA+'Â° (straight line)'}];
    stepsArr=[{t:'Rule',c:'Angles on a straight line add up to 180Â°'},{t:'Given',c:'a = '+angleA+'Â°'},{t:'Find b',c:'b = 180Â° âˆ’ '+angleA+'Â° = '+b+'Â°'}];
  }

  // â”€â”€ MODE: Vertically opposite â”€â”€
  else if(mode==='vertop'){
    const cx=W2/2,cy=H2/2;
    const a2=angleA, b2=180-angleA;
    diagram=`<svg width="${W2}" height="${H2}" viewBox="0 0 ${W2} ${H2}" style="${svgStyle}">
      <line x1="40" y1="${cy+60}" x2="${W2-40}" y2="${cy-60}" stroke="#334155" stroke-width="2"/>
      <line x1="40" y1="${cy-60}" x2="${W2-40}" y2="${cy+60}" stroke="#334155" stroke-width="2"/>
      ${angleLabel(cx,cy,50,0,angleA,'a='+a2+'Â°','#818cf8')}
      ${angleLabel(cx,cy,50,180,180+angleA,'a='+a2+'Â°','#818cf8')}
      ${angleLabel(cx,cy,50,angleA,180,'b='+b2+'Â°','#34d399')}
      ${angleLabel(cx,cy,50,180+angleA,360,'b='+b2+'Â°','#34d399')}
      ${label(cx,cy-H2*0.35,'Vertically opposite angles are equal','#475569',11)}
    </svg>`;
    facts=[{label:'a',val:a2,color:'#818cf8',reason:'Given (vertically opposite = equal)'},{label:'b',val:b2,color:'#34d399',reason:'180Â° âˆ’ '+a2+'Â° (straight line)'}];
    stepsArr=[{t:'Rule',c:'Vertically opposite angles are equal'},{t:'a = a',c:'Both purple angles = '+a2+'Â°'},{t:'b = 180âˆ’a',c:b2+'Â° (angles on straight line)'}];
  }

  // â”€â”€ MODE: Parallel lines (main one) â”€â”€
  else if(mode==='parallel'){
    const cx=W2/2, cy=H2/2;
    // Two parallel lines + transversal
    const lineY1=cy-70, lineY2=cy+70;
    const transAngle=angleA; // angle with horizontal
    const rad=transAngle*Math.PI/180;
    const tx1=cx-160*Math.cos(rad), ty1=lineY1+160*Math.sin(rad); // wrong, let me fix
    // Transversal hits line1 at (ix1,lineY1) and line2 at (ix2,lineY2)
    const slope=Math.tan((90-transAngle)*Math.PI/180);
    const ix1=cx-40, ix2=cx+40*(lineY2-lineY1)*0/100+40;

    // Intersection points
    const P1={x:cx-30,y:lineY1}, P2={x:cx+30,y:lineY2};
    // Angle at P1
    const angRad=transAngle*Math.PI/180;
    // alternate angles = equal, co-interior = 180-a, corresponding = equal
    const altAngle=transAngle;
    const coInt=180-transAngle;
    const corrAngle=transAngle;

    diagram=`<svg width="${W2}" height="${H2}" viewBox="0 0 ${W2} ${H2}" style="${svgStyle}">
      <!-- Parallel lines -->
      <line x1="20" y1="${lineY1}" x2="${W2-20}" y2="${lineY1}" stroke="#334155" stroke-width="2"/>
      <line x1="20" y1="${lineY2}" x2="${W2-20}" y2="${lineY2}" stroke="#334155" stroke-width="2"/>
      <!-- Parallel markers -->
      <line x1="80" y1="${lineY1-6}" x2="90" y2="${lineY1+6}" stroke="#475569" stroke-width="2"/>
      <line x1="85" y1="${lineY1-6}" x2="95" y2="${lineY1+6}" stroke="#475569" stroke-width="2"/>
      <line x1="80" y1="${lineY2-6}" x2="90" y2="${lineY2+6}" stroke="#475569" stroke-width="2"/>
      <line x1="85" y1="${lineY2-6}" x2="95" y2="${lineY2+6}" stroke="#475569" stroke-width="2"/>
      <!-- Transversal -->
      <line x1="${P1.x-100*Math.cos(angRad)}" y1="${P1.y+100*Math.sin(angRad)}" x2="${P2.x+120*Math.cos(angRad)}" y2="${P2.y-120*Math.sin(angRad)}" stroke="#818cf8" stroke-width="2"/>
      <!-- Angle a at top intersection -->
      ${arc(P1.x,P1.y,38,-angRad*180/Math.PI*0+180,(180-transAngle),'#818cf8')}
      ${label(P1.x-26,P1.y-16,'a='+transAngle+'Â°','#818cf8',12)}
      <!-- Alternate angle (Z angle) at bottom -->
      ${arc(P2.x,P2.y,38,0,transAngle,'#34d399')}
      ${label(P2.x+30,P2.y+16,'alt='+altAngle+'Â°','#34d399',12)}
      <!-- Co-interior at bottom -->
      ${arc(P2.x,P2.y,52,transAngle,180,'#f59e0b',true)}
      ${label(P2.x-20,P2.y+30,'co-int='+coInt+'Â°','#f59e0b',10)}
      <!-- Labels -->
      ${label(W2-30,lineY1,'L1','#475569',11)}
      ${label(W2-30,lineY2,'L2','#475569',11)}
    </svg>`;
    facts=[
      {label:'a (given)',val:transAngle,color:'#818cf8',reason:'Given angle'},
      {label:'Alternate (Z-angle)',val:altAngle,color:'#34d399',reason:'Equal to a (alternate angles, parallel lines)'},
      {label:'Co-interior (C-angle)',val:coInt,color:'#f59e0b',reason:'180Â° âˆ’ a (co-interior angles sum to 180Â°)'},
      {label:'Corresponding (F-angle)',val:corrAngle,color:'#a78bfa',reason:'Equal to a (corresponding angles, parallel lines)'},
    ];
    stepsArr=[
      {t:'Identify parallel lines',c:'L1 âˆ¥ L2 (shown by tick marks)'},
      {t:'Alternate angles (Z)',c:'On opposite sides of transversal, between parallels. Equal: '+altAngle+'Â°'},
      {t:'Co-interior angles (C)',c:'Same side of transversal, between parallels. Sum = 180Â°: '+coInt+'Â°'},
      {t:'Corresponding angles (F)',c:'Same position at each intersection. Equal: '+corrAngle+'Â°'},
    ];
  }

  // â”€â”€ MODE: Triangle angles â”€â”€
  else if(mode==='triangle'){
    const b3=rand(20,angleA-10)||20, c3=180-angleA-b3;
    const b3fixed=Math.max(10,Math.min(angleA-10,60));
    const c3fixed=180-angleA-b3fixed;
    const W3=380,H3=280;
    // Triangle points
    const pA={x:60,y:H3-50}, pB={x:W3-60,y:H3-50}, pC={x:W3*0.4,y:50};
    diagram=`<svg width="${W3}" height="${H3}" viewBox="0 0 ${W3} ${H3}" style="${svgStyle}">
      <polygon points="${pA.x},${pA.y} ${pB.x},${pB.y} ${pC.x},${pC.y}" fill="rgba(99,102,241,.1)" stroke="#818cf8" stroke-width="2"/>
      ${label(pA.x-20,pA.y+10,'a='+angleA+'Â°','#818cf8',13)}
      ${label(pB.x+14,pB.y+10,'b='+b3fixed+'Â°','#34d399',13)}
      ${label(pC.x,pC.y-14,'c='+c3fixed+'Â°','#f59e0b',13)}
      ${label(W3/2,H3-10,'a + b + c = '+angleA+' + '+b3fixed+' + '+c3fixed+' = 180Â°','#475569',10)}
    </svg>`;
    facts=[
      {label:'a',val:angleA,color:'#818cf8',reason:'Given'},
      {label:'b',val:b3fixed,color:'#34d399',reason:'Given'},
      {label:'c',val:c3fixed,color:'#f59e0b',reason:'180Â° âˆ’ '+angleA+'Â° âˆ’ '+b3fixed+'Â° (angles in triangle)'},
    ];
    stepsArr=[{t:'Rule',c:'Angles in a triangle sum to 180Â°'},{t:'Given',c:'a='+angleA+'Â°, b='+b3fixed+'Â°'},{t:'Find c',c:'c = 180âˆ’'+angleA+'âˆ’'+b3fixed+' = '+c3fixed+'Â°'}];
  }

  // â”€â”€ Mode: Angles around a point â”€â”€
  else {
    const b4=360-angleA;
    const cx2=W2/2,cy2=H2/2;
    diagram=`<svg width="${W2}" height="${H2}" viewBox="0 0 ${W2} ${H2}" style="${svgStyle}">
      <circle cx="${cx2}" cy="${cy2}" r="110" fill="rgba(15,23,42,.4)" stroke="#1e293b" stroke-width="1"/>
      <line x1="${cx2}" y1="${cy2}" x2="${cx2+120}" y2="${cy2}" stroke="#334155" stroke-width="1.5"/>
      <line x1="${cx2}" y1="${cy2}" x2="${cx2+120*Math.cos(angleA*Math.PI/180)}" y2="${cy2-120*Math.sin(angleA*Math.PI/180)}" stroke="#818cf8" stroke-width="2.5"/>
      ${arc(cx2,cy2,70,0,-angleA,'#818cf8')}
      ${arc(cx2,cy2,70,-angleA,-360,'#34d399')}
      ${label(cx2+55,cy2-30,'a='+angleA+'Â°','#818cf8',12)}
      ${label(cx2-55,cy2+20,'b='+b4+'Â°','#34d399',12)}
      ${label(cx2,cy2+H2*0.38,'Angles around a point = 360Â°','#475569',11)}
    </svg>`;
    facts=[{label:'a',val:angleA,color:'#818cf8',reason:'Given'},{label:'b',val:b4,color:'#34d399',reason:'360Â° âˆ’ '+angleA+'Â° (angles around a point)'}];
    stepsArr=[{t:'Rule',c:'Angles around a point sum to 360Â°'},{t:'Given',c:'a = '+angleA+'Â°'},{t:'Find b',c:'b = 360Â° âˆ’ '+angleA+'Â° = '+b4+'Â°'}];
  }

  // Quiz mode overlay
  let quizHTML='';
  if(quizMode){
    const target=facts.find(function(f){return f.label.startsWith(quizTarget);});
    const correctAns=target?String(target.val):'?';
    quizHTML=`<div class="quiz-box" style="margin-top:14px">
      <div style="font-size:13px;font-weight:700;color:#a5b4fc;margin-bottom:8px">ğŸ¯ Find angle <span style="color:${target?target.color:'#fbbf24'}">${quizTarget}</span> â€” what is it?</div>
      <div style="display:flex;gap:10px;align-items:center">
        <input class="quiz-input" type="text" id="ang-quiz" value="${quizAnswer}" placeholder="e.g. 65" oninput="S.angles.quizAnswer=this.value">
        <button class="btn-action" onclick="
          var ans=S.angles.quizAnswer.trim().replace('Â°','');
          var correct='${correctAns}';
          S.angles.quizResult=(ans===correct);
          if(S.quiz.total!==undefined){S.quiz.total++;if(S.angles.quizResult)S.quiz.score++;}
          rerender();
        ">Check</button>
        <button class="btn-action" onclick="
          var targets=S.angles.mode==='parallel'?['a','Alternate (Z-angle)','Co-interior (C-angle)','Corresponding (F-angle)']:['a','b','c'];
          S.angles.quizTarget=targets[Math.floor(Math.random()*targets.length)];
          S.angles.quizAnswer='';S.angles.quizResult=null;rerender();
        ">New angle â†’</button>
      </div>
      ${quizResult===true?'<div style="color:#34d399;font-weight:700;margin-top:8px">âœ… Correct! '+target.reason+'</div>':
        quizResult===false?'<div style="color:#f43f5e;font-weight:700;margin-top:8px">âŒ Answer is '+correctAns+'Â°. '+( target?target.reason:'')+'</div>':''}
    </div>`;
  }

  const factCards=facts.map(function(f){
    return `<div style="background:rgba(15,23,42,.6);border:1px solid ${f.color}44;border-radius:10px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:12px;font-weight:700;color:${f.color};margin-bottom:3px">Angle ${f.label}</div>
        ${showReasons?`<div style="font-size:11px;color:#64748b">${f.reason}</div>`:''}
      </div>
      <div style="font-size:22px;font-weight:700;color:${f.color};font-family:'JetBrains Mono',monospace">${f.val}Â°</div>
    </div>`;
  }).join('');

  const modeList=[['straight','Straight Line'],['vertop','Vertically Opp.'],['parallel','Parallel Lines'],['triangle','Triangle'],['point','Around Point']];

  return pageWrap('Angle Reasoning Builder','ğŸ“','See angle rules visually. Toggle reasons. Quiz yourself.',`
    ${tabs(modeList,mode,"S.angles.mode=__V__;rerender()")}
    <div class="two-col">
      <div>
        <div style="margin-bottom:12px">${diagram}</div>
        <div style="margin-bottom:12px">${SI('Angle a (Â°)','#818cf8',angleA,10,170,1,'angles','angleA')}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-tab${showReasons?' active':''}" onclick="S.angles.showReasons=!S.angles.showReasons;rerender()">
            ${showReasons?'ğŸ§  Hide Reasons':'ğŸ§  Show Reasons'}
          </button>
          <button class="btn btn-tab${quizMode?' active':''}" onclick="S.angles.quizMode=!S.angles.quizMode;S.angles.quizResult=null;rerender()">
            ğŸ¯ ${quizMode?'Exit Quiz':'Quiz Mode'}
          </button>
        </div>
        ${quizHTML}
      </div>
      <div class="ctrl-col">
        <div class="info-box" style="margin-bottom:14px">
          <div class="info-label">Angles Found</div>
          ${factCards}
        </div>
        ${steps(stepsArr)}
        <div class="info-box">
          <div class="info-label">All Angle Rules</div>
          <div style="font-size:12px;color:#94a3b8;line-height:2">
            ğŸ“ Straight line â†’ 180Â°<br>
            ğŸ”„ Around a point â†’ 360Â°<br>
            â–³ Triangle â†’ 180Â°<br>
            â†• Vertically opposite â†’ equal<br>
            âˆ¥ Alternate (Z) â†’ equal<br>
            âˆ¥ Co-interior (C) â†’ 180Â°<br>
            âˆ¥ Corresponding (F) â†’ equal
          </div>
        </div>
        ${quizWidget('angles')}
      </div>
    </div>`,'geometry');
}

window.navigate=navigate;
window.navigateCat=navigateCat;
window.navigatePage=navigatePage;
window.rerender=rerender;
window.S=S;
window.startQuiz=startQuiz;
window.checkQuiz=checkQuiz;
rerender();
</script>

  <!-- â”€â”€ Offline status banner â”€â”€ -->
  <div id="offline-banner" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#1e293b;border-top:1px solid rgba(245,158,11,.4);padding:10px 20px;text-align:center;font-size:13px;color:#fcd34d;font-family:Space Grotesk,sans-serif;z-index:9999">
    ğŸ“¶ You are offline â€” the tool will still work fully from cache
  </div>

  <!-- â”€â”€ Update available banner â”€â”€ -->
  <div id="update-banner" style="display:none;position:fixed;top:0;left:0;right:0;background:rgba(99,102,241,.95);padding:12px 20px;text-align:center;font-size:13px;color:#fff;font-family:Space Grotesk,sans-serif;z-index:9999;align-items:center;justify-content:center;gap:12px">
    <span>ğŸ”„ New version available!</span>
    <button onclick="updateApp()" style="background:#fff;color:#4f46e5;border:none;border-radius:6px;padding:4px 14px;font-weight:700;cursor:pointer;font-size:12px">Update Now</button>
    <button onclick="document.getElementById('update-banner').style.display='none'" style="background:transparent;border:1px solid rgba(255,255,255,.4);color:#fff;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:12px">Later</button>
  </div>

  <script>
  // â”€â”€ Service Worker Registration (only on hosted URLs, not local files) â”€â”€
  if('serviceWorker' in navigator && location.protocol !== 'file:'){
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('./service-worker.js')
        .then(function(reg){
          console.log('[App] SW registered, scope:', reg.scope);

          // Check for updates
          reg.addEventListener('updatefound', function(){
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', function(){
              if(newWorker.state === 'installed' && navigator.serviceWorker.controller){
                // New version waiting â€” show banner
                document.getElementById('update-banner').style.display='flex';
                window._newWorker = newWorker;
              }
            });
          });
        })
        .catch(function(err){
          console.log('[App] SW registration failed:', err);
        });

      // Listen for controller change (after update)
      navigator.serviceWorker.addEventListener('controllerchange', function(){
        window.location.reload();
      });
    });
  }

  // â”€â”€ Update app when user clicks "Update Now" â”€â”€
  function updateApp(){
    if(window._newWorker){
      window._newWorker.postMessage({type:'SKIP_WAITING'});
    }
    document.getElementById('update-banner').style.display='none';
  }

  // â”€â”€ Offline / Online detection â”€â”€
  function updateOnlineStatus(){
    const banner = document.getElementById('offline-banner');
    if(banner){
      banner.style.display = navigator.onLine ? 'none' : 'block';
    }
  }
  window.addEventListener('online',  updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus(); // Check on load

  // â”€â”€ iOS "Add to Home Screen" hint (shows once) â”€â”€
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone === true;
  const hintShown = localStorage.getItem('pwa-hint-shown');
  if(isIOS && !isStandalone && !hintShown){
    setTimeout(function(){
      const hint = document.createElement('div');
      hint.id = 'ios-hint';
      hint.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1e293b;border:1px solid rgba(99,102,241,.4);border-radius:14px;padding:14px 18px;font-size:13px;color:#e2e8f0;font-family:Space Grotesk,sans-serif;z-index:9999;max-width:300px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.5)';
      hint.innerHTML = '<div style="font-size:18px;margin-bottom:6px">ğŸ“±</div><strong style="color:#a5b4fc">Install as App</strong><br><span style="color:#64748b;font-size:12px">Tap <strong style="color:#e2e8f0">Share â†‘</strong> then <strong style="color:#e2e8f0">"Add to Home Screen"</strong> to use offline</span><br><button onclick="document.getElementById('ios-hint').remove();localStorage.setItem('pwa-hint-shown','1')" style="margin-top:10px;background:rgba(99,102,241,.3);border:1px solid rgba(99,102,241,.5);color:#a5b4fc;border-radius:8px;padding:5px 16px;cursor:pointer;font-size:12px">Got it</button>';
      document.body.appendChild(hint);
      localStorage.setItem('pwa-hint-shown', '1');
    }, 3000);
  }
  </script>
</body>
</html>
